<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Builder - Spark Your Potential</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
        }
        /* Sidebar */
        .sidebar {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        .sidebar h2 {
            font-size: 18px;
            color: #1a1a2e;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* CV Version Manager */
        .cv-versions { margin-bottom: 24px; }
        .cv-versions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .cv-versions-count {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 4px 8px;
            border-radius: 12px;
        }
        .cv-version-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .cv-version-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .cv-version-item:hover { background: #e9ecef; }
        .cv-version-item.selected {
            background: #667eea15;
            border-color: #667eea;
        }
        .cv-version-item.primary::before {
            content: '‚≠ê';
            font-size: 12px;
        }
        .cv-version-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }
        .cv-version-actions {
            display: flex;
            gap: 4px;
        }
        .cv-version-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .cv-version-actions button:hover { opacity: 1; }
        .btn-create-cv {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 8px;
            transition: background 0.2s;
        }
        .btn-create-cv:hover { background: #5a6fd6; }
        .btn-create-cv:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        /* Export Buttons */
        .export-section {
            border-top: 1px solid #e9ecef;
            padding-top: 20px;
            margin-top: 20px;
        }
        .export-section h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }
        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .btn-export {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .btn-export.word {
            background: #2b579a;
            color: white;
        }
        .btn-export.word:hover { background: #1e3f6f; }
        .btn-export.pdf {
            background: #d32f2f;
            color: white;
        }
        .btn-export.pdf:hover { background: #b71c1c; }
        /* Data Source Indicator */
        .data-source {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 20px;
            margin-bottom: 16px;
        }
        .data-source.live {
            background: #d4edda;
            color: #155724;
        }
        .data-source.cached {
            background: #fff3cd;
            color: #856404;
        }
        .data-source::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .data-source.live::before { background: #28a745; }
        .data-source.cached::before { background: #ffc107; }
        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a2e;
        }
        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }
        .form-group input,
        .form-group textarea {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        /* Case Studies Section */
        .case-studies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        .case-study-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid #667eea;
            position: relative;
        }
        .case-study-card.hidden {
            opacity: 0.5;
            border-left-color: #ccc;
        }
        .case-study-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .case-study-title {
            font-weight: 600;
            color: #1a1a2e;
        }
        .case-study-client {
            font-size: 13px;
            color: #667eea;
        }
        .case-study-actions {
            display: flex;
            gap: 8px;
        }
        .case-study-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .case-study-actions button:hover { opacity: 1; }
        .case-study-field {
            margin-bottom: 8px;
        }
        .case-study-field-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }
        .case-study-field-value {
            font-size: 13px;
            color: #333;
        }
        .case-study-results {
            color: #28a745;
            font-weight: 600;
        }
        .btn-add-case-study {
            padding: 16px;
            border: 2px dashed #667eea;
            border-radius: 12px;
            background: transparent;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            min-height: 120px;
        }
        .btn-add-case-study:hover {
            background: #667eea10;
            border-style: solid;
        }
        /* Skills */
        .skills-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .skill-tag {
            background: #667eea15;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 20px;
            font-weight: 700;
        }
        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
        }
        .btn-primary:hover { background: #5a6fd6; }
        .btn-secondary {
            background: white;
            color: #666;
            border: 1px solid #ddd;
        }
        .btn-secondary:hover { background: #f5f5f5; }
        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 16px;
        }
        .loading-overlay.active { display: flex; }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Back Button */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 20px;
        }
        .back-link:hover { text-decoration: underline; }
        /* Responsive */
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: relative;
                top: 0;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        /* Print Styles */
        @media print {
            body { background: white; padding: 0; }
            .sidebar, .btn-add-case-study, .case-study-actions, .back-link { display: none !important; }
            .container { display: block; }
            .card { box-shadow: none; border: none; padding: 0; margin-bottom: 20px; }
            .case-study-card.hidden { display: none; }
        }
    </style>
</head>
<body>
    <a href="client-portal.html" class="back-link">‚Üê Back to Client Portal</a>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="data-source live" id="dataSource">
                <span>Live</span>
            </div>

            <!-- CV Versions -->
            <div class="cv-versions">
                <div class="cv-versions-header">
                    <h2>üìÅ My CVs</h2>
                    <span class="cv-versions-count" id="cvCount">0/5</span>
                </div>
                <div class="cv-version-list" id="cvVersionList">
                    <!-- CV versions will be populated here -->
                </div>
                <button class="btn-create-cv" id="btnCreateCv" onclick="createNewCV()">
                    + Create New CV
                </button>
            </div>

            <!-- Export Section -->
            <div class="export-section">
                <h3>Export Options</h3>
                <div class="export-buttons">
                    <button class="btn-export word" onclick="exportWord()">
                        üì• Download Word
                    </button>
                    <button class="btn-export pdf" onclick="window.print()">
                        üìÑ Print / Save PDF
                    </button>
                </div>
            </div>

            <!-- Save Button -->
            <button class="btn-primary" style="width: 100%; margin-top: 16px;" onclick="saveCV()">
                üíæ Save Changes
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Profile Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Profile & Positioning</h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Role Identity / Headline</label>
                        <input type="text" id="roleIdentity" placeholder="e.g., Creative Strategy Director">
                    </div>
                    <div class="form-group">
                        <label>Who You Serve</label>
                        <input type="text" id="whoYouServe" placeholder="e.g., creative teams and brands">
                    </div>
                    <div class="form-group full-width">
                        <label>What You Do</label>
                        <textarea id="whatYouDo" placeholder="What you do for your clients/employers"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Unique Approach</label>
                        <textarea id="uniqueApproach" placeholder="What makes you different"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Career Background</label>
                        <textarea id="background" placeholder="Your career journey summary"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label>Where You're Heading</label>
                        <textarea id="whereHeading" placeholder="Your aspirations and next chapter"></textarea>
                    </div>
                </div>
            </div>

            <!-- Contact Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Contact Information</h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="email" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="phone" placeholder="+44 7XXX XXX XXX">
                    </div>
                    <div class="form-group full-width">
                        <label>LinkedIn URL</label>
                        <input type="url" id="linkedin" placeholder="linkedin.com/in/yourprofile">
                    </div>
                </div>
            </div>

            <!-- Skills Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Key Skills</h2>
                </div>
                <div class="form-group">
                    <label>Skills (comma-separated)</label>
                    <input type="text" id="skills" placeholder="Strategic Planning, Team Leadership, Brand Strategy...">
                </div>
                <div class="skills-container" id="skillsPreview" style="margin-top: 12px;">
                    <!-- Skills preview will appear here -->
                </div>
            </div>

            <!-- Case Studies Section -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Case Studies</h2>
                </div>
                <div class="case-studies-grid" id="caseStudiesGrid">
                    <!-- Case studies will be populated here -->
                    <button class="btn-add-case-study" onclick="openAddCaseStudyModal()">
                        ‚ûï Add New Case Study
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Case Study Modal -->
    <div class="modal-overlay" id="addCaseStudyModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add New Case Study</h3>
                <button class="btn-close" onclick="closeAddCaseStudyModal()">√ó</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Client / Company Name *</label>
                    <input type="text" id="csClientName" placeholder="e.g., Nike, Spotify">
                </div>
                <div class="form-group">
                    <label>Project Title</label>
                    <input type="text" id="csProjectTitle" placeholder="e.g., Brand Transformation">
                </div>
                <div class="form-group full-width">
                    <label>Brief</label>
                    <textarea id="csBrief" placeholder="What was the challenge or brief?"></textarea>
                </div>
                <div class="form-group full-width">
                    <label>Research</label>
                    <textarea id="csResearch" placeholder="What research did you conduct?"></textarea>
                </div>
                <div class="form-group full-width">
                    <label>Insight</label>
                    <textarea id="csInsight" placeholder="What key insight emerged?"></textarea>
                </div>
                <div class="form-group full-width">
                    <label>Strategy</label>
                    <textarea id="csStrategy" placeholder="What was your strategic approach?"></textarea>
                </div>
                <div class="form-group full-width">
                    <label>Proposition</label>
                    <textarea id="csProposition" placeholder="What was the core proposition?"></textarea>
                </div>
                <div class="form-group full-width">
                    <label>Campaign / Execution</label>
                    <textarea id="csCampaign" placeholder="How was it executed?"></textarea>
                </div>
                <div class="form-group full-width">
                    <label>Results *</label>
                    <textarea id="csResults" placeholder="What were the measurable outcomes?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddCaseStudyModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addCaseStudy()">Add Case Study</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <script>
        // Configuration
        const API_SERVER = 'https://sparkhub-be-qtmmb.ondigitalocean.app';
        const MAX_CV_VERSIONS = 5;

        // State
        let cvVersions = [];
        let selectedCvId = null;
        let caseStudies = [];
        let isLiveData = false;

        // Get token from localStorage
        function getToken() {
            return localStorage.getItem('syp_token');
        }

        // Show/hide loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Update data source indicator
        function updateDataSource(live) {
            isLiveData = live;
            const el = document.getElementById('dataSource');
            el.className = 'data-source ' + (live ? 'live' : 'cached');
            el.querySelector('span').textContent = live ? 'Live' : 'Cached';
        }

        // Load CV versions from API
        async function loadCvVersions() {
            const token = getToken();
            if (!token) {
                console.log('No token, using cached data');
                loadFromCache();
                return;
            }

            try {
                const response = await fetch(`${API_SERVER}/api/crm/syp/blueprints/all/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    cvVersions = data.blueprints || [];
                    updateDataSource(true);
                    renderCvVersions();

                    // Cache locally
                    localStorage.setItem('syp_cv_versions', JSON.stringify(cvVersions));

                    // Load selected or primary CV
                    if (cvVersions.length > 0) {
                        const primary = cvVersions.find(cv => cv.is_primary);
                        selectedCvId = primary ? primary.id : cvVersions[0].id;
                        loadCvData(selectedCvId);
                    }
                } else {
                    throw new Error('API error');
                }
            } catch (error) {
                console.error('Failed to load from API:', error);
                loadFromCache();
            }
        }

        // Load from localStorage cache
        function loadFromCache() {
            updateDataSource(false);
            const cached = localStorage.getItem('syp_cv_versions');
            if (cached) {
                cvVersions = JSON.parse(cached);
                renderCvVersions();
                if (cvVersions.length > 0) {
                    selectedCvId = cvVersions[0].id;
                    loadCvData(selectedCvId);
                }
            }
        }

        // Render CV version list
        function renderCvVersions() {
            const list = document.getElementById('cvVersionList');
            document.getElementById('cvCount').textContent = `${cvVersions.length}/${MAX_CV_VERSIONS}`;
            document.getElementById('btnCreateCv').disabled = cvVersions.length >= MAX_CV_VERSIONS;

            list.innerHTML = cvVersions.map(cv => `
                <div class="cv-version-item ${cv.id === selectedCvId ? 'selected' : ''} ${cv.is_primary ? 'primary' : ''}"
                     onclick="selectCv(${cv.id})">
                    <span class="cv-version-name">${cv.name}</span>
                    <div class="cv-version-actions">
                        <button onclick="event.stopPropagation(); renameCv(${cv.id})" title="Rename">‚úèÔ∏è</button>
                        <button onclick="event.stopPropagation(); duplicateCv(${cv.id})" title="Duplicate">üìã</button>
                        ${!cv.is_primary ? `<button onclick="event.stopPropagation(); deleteCv(${cv.id})" title="Delete">üóëÔ∏è</button>` : ''}
                        ${!cv.is_primary ? `<button onclick="event.stopPropagation(); setPrimary(${cv.id})" title="Set as Primary">‚≠ê</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Select a CV version
        async function selectCv(cvId) {
            selectedCvId = cvId;
            renderCvVersions();
            await loadCvData(cvId);
        }

        // Load CV data for editing
        async function loadCvData(cvId) {
            showLoading();
            const token = getToken();

            try {
                const response = await fetch(`${API_SERVER}/api/crm/syp/blueprints/${cvId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    populateForm(data);
                    localStorage.setItem(`syp_cv_data_${cvId}`, JSON.stringify(data));
                } else {
                    throw new Error('Failed to load CV');
                }
            } catch (error) {
                console.error('Load CV error:', error);
                // Try cache
                const cached = localStorage.getItem(`syp_cv_data_${cvId}`);
                if (cached) {
                    populateForm(JSON.parse(cached));
                }
            }

            hideLoading();
        }

        // Populate form with CV data
        function populateForm(data) {
            document.getElementById('roleIdentity').value = data.role_identity || '';
            document.getElementById('whatYouDo').value = data.what_you_do || '';
            document.getElementById('whoYouServe').value = data.who_you_serve || '';
            document.getElementById('uniqueApproach').value = data.unique_approach || '';
            document.getElementById('background').value = data.career_background || '';
            document.getElementById('whereHeading').value = data.where_heading || '';

            // Skills
            const skills = data.skills || [];
            document.getElementById('skills').value = skills.join(', ');
            renderSkillsPreview();

            // Case studies from career_evidence
            caseStudies = (data.career_evidence || []).map((e, i) => ({
                id: e.id || `evidence-${i}`,
                clientName: e.company || '',
                projectTitle: e.role_title || `${e.company} Project`,
                brief: e.challenge || '',
                results: e.result || '',
                isVisible: true
            }));

            renderCaseStudies();
        }

        // Render skills preview
        function renderSkillsPreview() {
            const input = document.getElementById('skills').value;
            const skills = input.split(',').map(s => s.trim()).filter(s => s);
            document.getElementById('skillsPreview').innerHTML = skills.map(s =>
                `<span class="skill-tag">${s}</span>`
            ).join('');
        }

        // Add event listener for skills input
        document.getElementById('skills').addEventListener('input', renderSkillsPreview);

        // Render case studies
        function renderCaseStudies() {
            const grid = document.getElementById('caseStudiesGrid');
            const cards = caseStudies.map((cs, index) => `
                <div class="case-study-card ${cs.isVisible ? '' : 'hidden'}">
                    <div class="case-study-header">
                        <div>
                            <div class="case-study-title">${cs.projectTitle || cs.clientName}</div>
                            <div class="case-study-client">${cs.clientName}</div>
                        </div>
                        <div class="case-study-actions">
                            <button onclick="toggleCaseStudyVisibility(${index})" title="${cs.isVisible ? 'Hide' : 'Show'}">
                                ${cs.isVisible ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                            </button>
                            <button onclick="deleteCaseStudy(${index})" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>
                    ${cs.brief ? `<div class="case-study-field"><span class="case-study-field-label">Brief</span><div class="case-study-field-value">${cs.brief}</div></div>` : ''}
                    ${cs.insight ? `<div class="case-study-field"><span class="case-study-field-label">Insight</span><div class="case-study-field-value">${cs.insight}</div></div>` : ''}
                    ${cs.strategy ? `<div class="case-study-field"><span class="case-study-field-label">Strategy</span><div class="case-study-field-value">${cs.strategy}</div></div>` : ''}
                    ${cs.campaign ? `<div class="case-study-field"><span class="case-study-field-label">Campaign</span><div class="case-study-field-value">${cs.campaign}</div></div>` : ''}
                    ${cs.results ? `<div class="case-study-field"><span class="case-study-field-label">Results</span><div class="case-study-field-value case-study-results">${cs.results}</div></div>` : ''}
                </div>
            `).join('');

            grid.innerHTML = cards + `
                <button class="btn-add-case-study" onclick="openAddCaseStudyModal()">
                    ‚ûï Add New Case Study
                </button>
            `;
        }

        // Toggle case study visibility
        function toggleCaseStudyVisibility(index) {
            caseStudies[index].isVisible = !caseStudies[index].isVisible;
            renderCaseStudies();
        }

        // Delete case study
        function deleteCaseStudy(index) {
            if (confirm('Delete this case study?')) {
                caseStudies.splice(index, 1);
                renderCaseStudies();
            }
        }

        // Open add case study modal
        function openAddCaseStudyModal() {
            document.getElementById('addCaseStudyModal').classList.add('active');
            // Clear form
            ['csClientName', 'csProjectTitle', 'csBrief', 'csResearch', 'csInsight',
             'csStrategy', 'csProposition', 'csCampaign', 'csResults'].forEach(id => {
                document.getElementById(id).value = '';
            });
        }

        // Close add case study modal
        function closeAddCaseStudyModal() {
            document.getElementById('addCaseStudyModal').classList.remove('active');
        }

        // Add case study
        function addCaseStudy() {
            const clientName = document.getElementById('csClientName').value.trim();
            if (!clientName) {
                alert('Please enter a client/company name');
                return;
            }

            const newCaseStudy = {
                id: `custom-${Date.now()}`,
                clientName: clientName,
                projectTitle: document.getElementById('csProjectTitle').value.trim() || clientName,
                brief: document.getElementById('csBrief').value.trim(),
                research: document.getElementById('csResearch').value.trim(),
                insight: document.getElementById('csInsight').value.trim(),
                strategy: document.getElementById('csStrategy').value.trim(),
                proposition: document.getElementById('csProposition').value.trim(),
                campaign: document.getElementById('csCampaign').value.trim(),
                results: document.getElementById('csResults').value.trim(),
                isVisible: true
            };

            caseStudies.push(newCaseStudy);
            renderCaseStudies();
            closeAddCaseStudyModal();
        }

        // Create new CV
        async function createNewCV() {
            const name = prompt('Enter a name for your new CV (e.g., "Tech Industry CV"):');
            if (!name || !name.trim()) return;

            showLoading();
            const token = getToken();

            try {
                const response = await fetch(`${API_SERVER}/api/crm/syp/blueprints/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: name.trim() })
                });

                if (response.ok) {
                    await loadCvVersions();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to create CV');
                }
            } catch (error) {
                console.error('Create CV error:', error);
                alert('Failed to create CV. Please try again.');
            }

            hideLoading();
        }

        // Rename CV
        async function renameCv(cvId) {
            const cv = cvVersions.find(v => v.id === cvId);
            const newName = prompt('Enter new name:', cv?.name || '');
            if (!newName || !newName.trim()) return;

            showLoading();
            const token = getToken();

            try {
                const response = await fetch(`${API_SERVER}/api/crm/syp/blueprints/${cvId}/rename/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName.trim() })
                });

                if (response.ok) {
                    await loadCvVersions();
                } else {
                    alert('Failed to rename CV');
                }
            } catch (error) {
                console.error('Rename error:', error);
            }

            hideLoading();
        }

        // Duplicate CV
        async function duplicateCv(cvId) {
            showLoading();
            const token = getToken();

            try {
                const response = await fetch(`${API_SERVER}/api/crm/syp/blueprints/${cvId}/duplicate/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    await loadCvVersions();
                } else {
                    alert('Failed to duplicate CV');
                }
            } catch (error) {
                console.error('Duplicate error:', error);
            }

            hideLoading();
        }

        // Delete CV
        async function deleteCv(cvId) {
            if (!confirm('Delete this CV version? This cannot be undone.')) return;

            showLoading();
            const token = getToken();

            try {
                const response = await fetch(`${API_SERVER}/api/crm/syp/blueprints/${cvId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    await loadCvVersions();
                } else {
                    alert('Failed to delete CV');
                }
            } catch (error) {
                console.error('Delete error:', error);
            }

            hideLoading();
        }

        // Set CV as primary
        async function setPrimary(cvId) {
            showLoading();
            const token = getToken();

            try {
                const response = await fetch(`${API_SERVER}/api/crm/syp/blueprints/${cvId}/set-primary/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    await loadCvVersions();
                } else {
                    alert('Failed to set as primary');
                }
            } catch (error) {
                console.error('Set primary error:', error);
            }

            hideLoading();
        }

        // Save CV
        async function saveCV() {
            showLoading();
            const token = getToken();

            const cvData = {
                role_identity: document.getElementById('roleIdentity').value,
                what_you_do: document.getElementById('whatYouDo').value,
                who_you_serve: document.getElementById('whoYouServe').value,
                unique_approach: document.getElementById('uniqueApproach').value,
                career_background: document.getElementById('background').value,
                where_heading: document.getElementById('whereHeading').value,
                skills: document.getElementById('skills').value.split(',').map(s => s.trim()).filter(s => s)
            };

            try {
                const response = await fetch(`${API_SERVER}/api/crm/syp/blueprints/${selectedCvId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(cvData)
                });

                if (response.ok) {
                    alert('CV saved successfully!');
                    // Update cache
                    localStorage.setItem(`syp_cv_data_${selectedCvId}`, JSON.stringify(cvData));
                } else {
                    alert('Failed to save CV');
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save. Changes cached locally.');
                localStorage.setItem(`syp_cv_data_${selectedCvId}`, JSON.stringify(cvData));
            }

            hideLoading();
        }

        // Export to Word
        function exportWord() {
            const visibleCaseStudies = caseStudies.filter(cs => cs.isVisible);
            const roleIdentity = document.getElementById('roleIdentity').value;
            const whatYouDo = document.getElementById('whatYouDo').value;
            const whoYouServe = document.getElementById('whoYouServe').value;
            const uniqueApproach = document.getElementById('uniqueApproach').value;
            const background = document.getElementById('background').value;
            const whereHeading = document.getElementById('whereHeading').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const linkedin = document.getElementById('linkedin').value;
            const skillsInput = document.getElementById('skills').value;
            const skills = skillsInput.split(',').map(s => s.trim()).filter(s => s);

            const fullProfile = `I'm a ${roleIdentity} who ${whatYouDo} for ${whoYouServe}. I ${uniqueApproach}. After ${background}, I'm now ${whereHeading}.`;

            const wordHtml = `
<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="utf-8">
<title>CV</title>
<!--[if gte mso 9]>
<xml>
<w:WordDocument>
<w:View>Print</w:View>
<w:Zoom>100</w:Zoom>
</w:WordDocument>
</xml>
<![endif]-->
<style>
  @page { margin: 2cm; }
  body { font-family: 'Calibri', sans-serif; font-size: 11pt; line-height: 1.5; color: #333; }
  h1 { font-size: 24pt; margin-bottom: 0; color: #1a1a1a; }
  h2 { font-size: 14pt; color: #667eea; border-bottom: 2px solid #667eea; padding-bottom: 4pt; margin-top: 18pt; }
  h3 { font-size: 12pt; color: #1a1a1a; margin-bottom: 4pt; }
  .headline { font-size: 12pt; color: #667eea; margin-bottom: 8pt; }
  .contact { font-size: 10pt; color: #666; margin-bottom: 16pt; }
  .profile { font-size: 11pt; line-height: 1.6; margin-bottom: 16pt; }
  .case-study { margin-bottom: 16pt; padding: 12pt; background: #f9f9f9; border-left: 3px solid #667eea; }
  .case-study-title { font-weight: bold; color: #1a1a1a; }
  .case-study-client { color: #667eea; font-size: 10pt; }
  .result { color: #28a745; font-weight: bold; }
</style>
</head>
<body>
<h1>${roleIdentity}</h1>
<p class="headline">${whatYouDo} for ${whoYouServe}</p>
<p class="contact">üìß ${email} | üì± ${phone} | üîó ${linkedin}</p>

<h2>Profile</h2>
<p class="profile">${fullProfile}</p>

<h2>Key Skills</h2>
<p>${skills.join(' ‚Ä¢ ')}</p>

<h2>Case Studies</h2>
${visibleCaseStudies.map(cs => `
<div class="case-study">
  <p class="case-study-title">${cs.projectTitle}</p>
  <p class="case-study-client">${cs.clientName}</p>
  ${cs.brief ? `<p><strong>Brief:</strong> ${cs.brief}</p>` : ''}
  ${cs.research ? `<p><strong>Research:</strong> ${cs.research}</p>` : ''}
  ${cs.insight ? `<p><strong>Insight:</strong> ${cs.insight}</p>` : ''}
  ${cs.strategy ? `<p><strong>Strategy:</strong> ${cs.strategy}</p>` : ''}
  ${cs.proposition ? `<p><strong>Proposition:</strong> ${cs.proposition}</p>` : ''}
  ${cs.campaign ? `<p><strong>Campaign:</strong> ${cs.campaign}</p>` : ''}
  ${cs.results ? `<p><strong>Results:</strong> <span class="result">${cs.results}</span></p>` : ''}
</div>
`).join('')}
</body>
</html>`;

            const blob = new Blob([wordHtml], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // Include CV version name in filename
            const selectedCv = cvVersions.find(cv => cv.id === selectedCvId);
            const cvName = selectedCv ? selectedCv.name.replace(/\s+/g, '_') : 'CV';
            a.download = `${cvName}_CV.doc`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize on page load
        window.onload = function() {
            const token = getToken();
            if (!token) {
                // Check if we should redirect to login
                const clientEmail = localStorage.getItem('syp_client_email');
                if (!clientEmail) {
                    window.location.href = 'login.html';
                    return;
                }
            }

            loadCvVersions();
        };
    </script>
</body>
</html>
