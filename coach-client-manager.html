<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Client Manager - Harness the Spark</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üë•</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: white;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .logo { margin-bottom: 20px; }
        .logo img { height: 60px; }
        .header h1 {
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 10px;
        }
        .header h1 span { color: #fbbf24; }
        .header .subtitle {
            font-size: 1.1em;
            color: #94a3b8;
        }

        /* Data Source Indicator */
        .data-source {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-top: 10px;
        }
        .data-source.live {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .data-source.cached {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        .data-source .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .data-source.live .dot { background: #22c55e; }
        .data-source.cached .dot { background: #fbbf24; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 2em;
            font-weight: 800;
        }
        .stat-card .number.purple { color: #a855f7; }
        .stat-card .number.blue { color: #3b82f6; }
        .stat-card .number.green { color: #22c55e; }
        .stat-card .number.amber { color: #fbbf24; }
        .stat-card .label {
            font-size: 0.85em;
            color: #94a3b8;
            margin-top: 5px;
        }

        /* Filter Tabs */
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        .filter-tab {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s;
        }
        .filter-tab:hover {
            border-color: rgba(255,255,255,0.4);
            color: white;
        }
        .filter-tab.active {
            background: #fbbf24;
            border-color: #fbbf24;
            color: #0f172a;
        }

        /* Client Cards */
        .clients-section {
            margin-bottom: 40px;
        }
        .section-title {
            font-size: 1.3em;
            font-weight: 700;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .client-card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden;
            transition: all 0.3s;
        }
        .client-card:hover {
            border-color: rgba(255,255,255,0.2);
        }
        .client-card.career { border-left: 4px solid #3b82f6; }
        .client-card.audhd { border-left: 4px solid #a855f7; }
        .client-card.exec { border-left: 4px solid #f472b6; }
        .client-card.life { border-left: 4px solid #a855f7; }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            cursor: pointer;
        }
        .client-header:hover {
            background: rgba(255,255,255,0.03);
        }

        .client-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .client-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            font-weight: 700;
            color: #0f172a;
        }
        .client-name-section h3 {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .client-email {
            font-size: 0.85em;
            color: #94a3b8;
        }

        .client-badges {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }
        .badge.career { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .badge.audhd, .badge.life { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .badge.exec { background: rgba(244, 114, 182, 0.2); color: #f472b6; }
        .badge.status {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .badge.status.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        .badge.status.complete {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .badge.status.on-hold {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .expand-icon {
            font-size: 1.2em;
            color: #94a3b8;
            transition: transform 0.3s;
        }
        .client-card.expanded .expand-icon {
            transform: rotate(90deg);
        }

        /* Expanded Content */
        .client-details {
            display: none;
            padding: 0 20px 20px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .client-card.expanded .client-details {
            display: block;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .detail-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 15px;
        }
        .detail-section h4 {
            font-size: 0.9em;
            color: #94a3b8;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .detail-section .value {
            font-size: 0.95em;
            color: #e2e8f0;
        }

        /* Sessions Timeline */
        .sessions-timeline {
            margin-top: 15px;
        }
        .session-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .session-item:last-child { border-bottom: none; }
        .session-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
        }
        .session-icon.complete {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        .session-icon.pending {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }
        .session-name {
            flex: 1;
            font-size: 0.9em;
        }
        .session-date {
            font-size: 0.85em;
            color: #94a3b8;
        }

        /* Coach Notes */
        .notes-section {
            margin-top: 20px;
        }
        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .notes-header h4 {
            font-size: 0.95em;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .notes-textarea {
            width: 100%;
            min-height: 120px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 0.9em;
            resize: vertical;
        }
        .notes-textarea:focus {
            outline: none;
            border-color: #fbbf24;
        }
        .notes-textarea:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .notes-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        .btn.primary {
            background: #fbbf24;
            color: #0f172a;
        }
        .btn.primary:hover {
            background: #f59e0b;
        }
        .btn.secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        .btn.secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Quick Stats in Card */
        .client-quick-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .quick-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .quick-stat .num {
            font-size: 1.3em;
            font-weight: 700;
            color: #fbbf24;
        }
        .quick-stat .lbl {
            font-size: 0.75em;
            color: #94a3b8;
            margin-top: 2px;
        }

        /* Back Button */
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 30px;
            transition: all 0.2s;
        }
        /* Mobile fix for back button */
        @media (max-width: 600px) {
            .back-btn {
                position: relative;
                top: auto;
                left: auto;
                display: block;
                margin: 10px auto 20px;
                text-align: center;
                width: fit-content;
            }
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
        }
        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #fbbf24;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
        }
        .empty-state .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            color: #64748b;
            font-size: 0.85em;
        }

        /* Mobile */
        @media (max-width: 768px) {
            body { padding: 15px 10px; }
            .container { max-width: 100%; }

            .header h1 { font-size: 1.6em; }
            .header .subtitle { font-size: 0.95em; }

            /* Quick stats - 2x2 grid on mobile */
            .quick-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            .stat-card { padding: 15px; }
            .stat-card .number { font-size: 1.6em; }
            .stat-card .label { font-size: 0.8em; }

            /* Filter tabs - scrollable */
            .filter-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 5px;
            }
            .filter-tab {
                flex-shrink: 0;
                padding: 10px 16px;
            }

            /* Client cards */
            .client-card { margin-bottom: 12px; }
            .client-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
                padding: 15px;
            }
            .client-info { width: 100%; }
            .client-avatar {
                width: 45px;
                height: 45px;
                font-size: 1.1em;
            }
            .client-name-section h3 { font-size: 1em; }
            .client-email { font-size: 0.8em; }

            .client-badges {
                flex-wrap: wrap;
                width: 100%;
                justify-content: flex-start;
            }
            .badge { font-size: 0.7em; padding: 4px 8px; }
            .expand-icon {
                position: absolute;
                right: 15px;
                top: 15px;
            }
            .client-header { position: relative; }

            /* Expanded details */
            .client-details { padding: 0 15px 15px; }
            .details-grid { grid-template-columns: 1fr; gap: 15px; }
            .detail-section { padding: 12px; }
            .detail-section h4 { font-size: 0.85em; }

            /* Quick stats in card */
            .client-quick-stats { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .quick-stat { padding: 8px; }
            .quick-stat .num { font-size: 1.1em; }
            .quick-stat .lbl { font-size: 0.7em; }

            /* Sessions timeline */
            .session-item { padding: 6px 0; gap: 8px; }
            .session-icon { width: 20px; height: 20px; font-size: 0.7em; }
            .session-name { font-size: 0.85em; }
            .session-date { font-size: 0.8em; }

            /* Notes */
            .notes-textarea {
                font-size: 16px; /* Prevent iOS zoom */
                min-height: 100px;
            }
            .notes-actions { flex-direction: column; }
            .notes-actions .btn { width: 100%; justify-content: center; }

            /* Footer */
            .footer { font-size: 0.8em; margin-top: 30px; }
        }

        /* Small phones */
        @media (max-width: 400px) {
            .header h1 { font-size: 1.4em; }
            .quick-stats { grid-template-columns: repeat(2, 1fr); }
            .stat-card .number { font-size: 1.4em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="coach-hub.html" class="back-btn">
            <span>‚Üê</span> Back to Coach Hub
        </a>

        <div class="header">
            <div class="logo">
                <img src="White.png" alt="Harness the Spark" onerror="this.style.display='none'">
            </div>
            <h1>üë• Client <span>Manager</span></h1>
            <div class="subtitle">View and manage all coaching clients</div>
            <div id="dataSource" class="data-source cached">
                <span class="dot"></span>
                <span class="text">Checking...</span>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-card">
                <div class="number purple" id="totalCount">-</div>
                <div class="label">Total Clients</div>
            </div>
            <div class="stat-card">
                <div class="number blue" id="activeCount">-</div>
                <div class="label">Active</div>
            </div>
            <div class="stat-card">
                <div class="number green" id="completedCount">-</div>
                <div class="label">Completed</div>
            </div>
            <div class="stat-card">
                <div class="number amber" id="sessionsCount">-</div>
                <div class="label">Total Sessions</div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">All Clients</button>
            <button class="filter-tab" data-filter="career">Career</button>
            <button class="filter-tab" data-filter="audhd">ND Life</button>
            <button class="filter-tab" data-filter="exec">ND Exec</button>
        </div>

        <!-- Clients List -->
        <div class="clients-section">
            <div id="clientsList" class="clients-list">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading clients...</div>
                </div>
            </div>
        </div>

        <div class="footer">
            &copy; 2025 Harness the Spark | Coach Client Manager
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://sparkhub-be-qtmmb.ondigitalocean.app';

        // State
        let clients = [];
        let currentFilter = 'all';
        let authToken = localStorage.getItem('syp_token');
        let expandedClients = new Set();
        let editingNotes = new Map(); // Track which clients have notes being edited

        // Programme Type Labels
        const PROGRAMME_TYPES = {
            career: { label: 'Career', icon: '‚ö°', colour: 'career' },
            audhd: { label: 'ND Life', icon: 'üß†', colour: 'audhd' },
            life: { label: 'Life', icon: 'üíú', colour: 'life' },
            exec: { label: 'Executive', icon: 'üëî', colour: 'exec' }
        };

        // Status Labels
        const STATUS_LABELS = {
            'pre-programme': 'Pre-Programme',
            'enrolled': 'Enrolled',
            'week-1': 'Week 1',
            'week-2': 'Week 2',
            'week-3': 'Week 3',
            'week-4': 'Week 4',
            'session-1': 'Session 1',
            'session-2': 'Session 2',
            'session-3': 'Session 3',
            'session-4': 'Session 4',
            'complete': 'Completed',
            'on-hold': 'On Hold'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadClients();
            setupFilterTabs();
        });

        // Setup Filter Tabs
        function setupFilterTabs() {
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentFilter = tab.dataset.filter;
                    renderClients();
                });
            });
        }

        // Load Clients from API
        async function loadClients() {
            if (!authToken) {
                showLoginPrompt();
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/crm/syp/coach/clients/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    clients = await response.json();
                    console.log('‚úÖ Loaded', clients.length, 'clients from PostgreSQL');
                    updateDataSource(true);
                    updateStats();
                    renderClients();
                } else if (response.status === 401) {
                    console.warn('‚ö†Ô∏è Token expired');
                    showLoginPrompt();
                } else {
                    throw new Error(`API returned ${response.status}`);
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                updateDataSource(false);
                showError('Failed to load clients. Please check your connection.');
            }
        }

        // Update Data Source Indicator
        function updateDataSource(isLive) {
            const el = document.getElementById('dataSource');
            el.className = `data-source ${isLive ? 'live' : 'cached'}`;
            el.querySelector('.text').textContent = isLive ? 'Live' : 'Cached';
        }

        // Update Stats
        function updateStats() {
            const total = clients.length;
            const active = clients.filter(c => !['complete', 'on-hold'].includes(c.programme_status)).length;
            const completed = clients.filter(c => c.programme_status === 'complete').length;

            // Count sessions
            let sessions = 0;
            clients.forEach(c => {
                if (c.session_1_date) sessions++;
                if (c.session_2_date) sessions++;
                if (c.session_3_date) sessions++;
                if (c.completed_date) sessions++;
            });

            document.getElementById('totalCount').textContent = total;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('sessionsCount').textContent = sessions;
        }

        // Render Clients
        function renderClients() {
            const container = document.getElementById('clientsList');

            // Filter clients
            let filtered = clients;
            if (currentFilter !== 'all') {
                filtered = clients.filter(c => c.programme_type === currentFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üë•</div>
                        <div>No clients found</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(client => renderClientCard(client)).join('');

            // Add click handlers for expand/collapse
            container.querySelectorAll('.client-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('.btn')) return; // Don't toggle when clicking buttons
                    const card = header.closest('.client-card');
                    const clientId = card.dataset.clientId;
                    toggleExpand(clientId);
                });
            });
        }

        // Render Single Client Card
        function renderClientCard(client) {
            const type = PROGRAMME_TYPES[client.programme_type] || PROGRAMME_TYPES.career;
            const statusLabel = STATUS_LABELS[client.programme_status] || client.programme_status;
            const isExpanded = expandedClients.has(String(client.id));
            const initials = client.full_name.split(' ').map(n => n[0]).join('').toUpperCase();

            const isComplete = client.programme_status === 'complete';
            const isOnHold = client.programme_status === 'on-hold';
            const statusClass = isComplete ? 'complete' : (isOnHold ? 'on-hold' : 'active');

            return `
                <div class="client-card ${type.colour} ${isExpanded ? 'expanded' : ''}" data-client-id="${client.id}">
                    <div class="client-header">
                        <div class="client-info">
                            <div class="client-avatar">${initials}</div>
                            <div class="client-name-section">
                                <h3>${client.full_name}</h3>
                                <div class="client-email">${client.email}</div>
                            </div>
                        </div>
                        <div class="client-badges">
                            <span class="badge ${type.colour}">${type.icon} ${type.label}</span>
                            <span class="badge status ${statusClass}">${statusLabel}</span>
                            <span class="expand-icon">‚ñ∂</span>
                        </div>
                    </div>
                    <div class="client-details">
                        ${renderClientDetails(client)}
                    </div>
                </div>
            `;
        }

        // Render Client Details (Expanded)
        function renderClientDetails(client) {
            const type = PROGRAMME_TYPES[client.programme_type] || PROGRAMME_TYPES.career;
            const isAuDHD = ['audhd', 'life', 'exec'].includes(client.programme_type);

            return `
                <div class="details-grid">
                    <div class="detail-section">
                        <h4>üìÖ Schedule</h4>
                        <div class="sessions-timeline">
                            ${renderSessionItem('Enrolled', client.enrolled_date, true)}
                            ${renderSessionItem(isAuDHD ? 'Session 1' : 'Week 1', client.session_1_date, !!client.session_1_date)}
                            ${renderSessionItem(isAuDHD ? 'Session 2' : 'Week 2', client.session_2_date, !!client.session_2_date)}
                            ${renderSessionItem(isAuDHD ? 'Session 3' : 'Week 3', client.session_3_date, !!client.session_3_date)}
                            ${renderSessionItem(isAuDHD ? 'Session 4' : 'Week 4', client.completed_date, !!client.completed_date)}
                        </div>
                    </div>
                    <div class="detail-section">
                        <h4>üìä Quick Stats</h4>
                        <div class="client-quick-stats">
                            <div class="quick-stat">
                                <div class="num">${client.evidence_count || 0}</div>
                                <div class="lbl">Evidence</div>
                            </div>
                            <div class="quick-stat">
                                <div class="num">${client.opportunities_count || 0}</div>
                                <div class="lbl">Opportunities</div>
                            </div>
                            <div class="quick-stat">
                                <div class="num">${client.blueprint ? '‚úì' : '-'}</div>
                                <div class="lbl">Blueprint</div>
                            </div>
                            <div class="quick-stat">
                                <div class="num">${client.ability_recognition ? '‚úì' : '-'}</div>
                                <div class="lbl">Ability Rec</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="notes-section">
                    <div class="notes-header">
                        <h4>üìù Coach Notes</h4>
                    </div>
                    <textarea
                        id="notes-${client.id}"
                        class="notes-textarea"
                        placeholder="Add notes about this client..."
                        ${editingNotes.has(client.id) ? '' : 'disabled'}
                    >${client.coach_notes || ''}</textarea>
                    <div class="notes-actions">
                        ${editingNotes.has(client.id) ? `
                            <button class="btn primary" onclick="saveNotes(${client.id})">
                                üíæ Save Notes
                            </button>
                            <button class="btn secondary" onclick="cancelEditNotes(${client.id})">
                                ‚úï Cancel
                            </button>
                        ` : `
                            <button class="btn secondary" onclick="startEditNotes(${client.id})">
                                ‚úèÔ∏è Edit Notes
                            </button>
                        `}
                    </div>
                </div>
            `;
        }

        // Render Session Item
        function renderSessionItem(label, date, isComplete) {
            const formattedDate = date ? formatDate(date) : 'Not scheduled';
            return `
                <div class="session-item">
                    <div class="session-icon ${isComplete ? 'complete' : 'pending'}">
                        ${isComplete ? '‚úì' : '‚óã'}
                    </div>
                    <div class="session-name">${label}</div>
                    <div class="session-date">${formattedDate}</div>
                </div>
            `;
        }

        // Format Date
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-GB', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        // Toggle Expand
        function toggleExpand(clientId) {
            if (expandedClients.has(clientId)) {
                expandedClients.delete(clientId);
            } else {
                expandedClients.add(clientId);
            }
            renderClients();
        }

        // Notes Editing
        function startEditNotes(clientId) {
            editingNotes.set(clientId, true);
            renderClients();
            // Focus the textarea
            setTimeout(() => {
                const textarea = document.getElementById(`notes-${clientId}`);
                if (textarea) textarea.focus();
            }, 50);
        }

        function cancelEditNotes(clientId) {
            editingNotes.delete(clientId);
            renderClients();
        }

        async function saveNotes(clientId) {
            const textarea = document.getElementById(`notes-${clientId}`);
            const notes = textarea.value;

            try {
                const response = await fetch(`${API_BASE_URL}/api/crm/syp/coach/clients/${clientId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ coach_notes: notes })
                });

                if (response.ok) {
                    // Update local data
                    const client = clients.find(c => c.id === clientId);
                    if (client) client.coach_notes = notes;

                    editingNotes.delete(clientId);
                    renderClients();
                    console.log('‚úÖ Notes saved');
                } else {
                    throw new Error(`Failed to save: ${response.status}`);
                }
            } catch (error) {
                console.error('Error saving notes:', error);
                alert('Failed to save notes. Please try again.');
            }
        }

        // Show Login Prompt
        function showLoginPrompt() {
            document.getElementById('clientsList').innerHTML = `
                <div class="empty-state">
                    <div class="icon">üîí</div>
                    <div style="margin-bottom: 20px;">Please log in to view clients</div>
                    <a href="login.html" class="btn primary" style="text-decoration: none;">
                        Go to Login
                    </a>
                </div>
            `;
        }

        // Show Error
        function showError(message) {
            document.getElementById('clientsList').innerHTML = `
                <div class="empty-state">
                    <div class="icon">‚ö†Ô∏è</div>
                    <div>${message}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
