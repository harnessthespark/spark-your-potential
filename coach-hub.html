<!DOCTYPE html>
<html lang="en-GB" data-theme="corporate">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Hub - Spark Your Potential</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS + DaisyUI for polished components -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.24/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        spark: {
                            red: '#EF4444',
                            orange: '#F97316',
                            yellow: '#EAB308',
                            gold: '#F59E0B',
                            purple: '#7C3AED',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --purple-dark: #5B21B6;
            --purple-main: #7C3AED;
            --purple-light: #A78BFA;
            --gold: #F59E0B;
            --gold-light: #FCD34D;
            --warm-bg: #FFFBEB;
            --warm-card: #FFFFFF;
            --warm-border: #FDE68A;
            --text-dark: #1F2937;
            --text-muted: #6B7280;
            --success: #10B981;
            --info: #3B82F6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--warm-bg);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--purple-dark) 0%, var(--purple-main) 100%);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header h1 {
            color: white;
            font-size: 1.5em;
            font-weight: 700;
        }

        .header h1 span {
            color: var(--gold-light);
        }

        .data-badge {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .data-badge.live::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .add-client-btn {
            background: var(--gold);
            color: var(--text-dark);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .add-client-btn:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--text-dark);
        }

        .logout-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        /* Today Section */
        .today-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid var(--warm-border);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .today-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .today-card {
            background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--purple-light);
        }

        .today-card h3 {
            font-size: 0.9em;
            color: var(--purple-dark);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .today-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .today-item:last-child {
            margin-bottom: 0;
        }

        .today-time {
            color: var(--purple-main);
            font-weight: 600;
            font-size: 0.85em;
        }

        .empty-state {
            color: var(--text-muted);
            font-size: 0.9em;
            text-align: center;
            padding: 15px;
        }

        /* Client Sections */
        .clients-section {
            margin-bottom: 30px;
        }

        .section-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--warm-border);
        }

        .section-bar h2 {
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-count {
            background: var(--purple-light);
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        /* Client Cards Grid */
        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: white;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid #E5E7EB;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .client-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: var(--purple-light);
        }

        .client-card.career {
            border-left: 4px solid var(--gold);
        }

        .client-card.audhd {
            border-left: 4px solid var(--purple-main);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .client-info h3 {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .programme-badge {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
        }

        .programme-badge.career {
            background: #FEF3C7;
            color: #92400E;
        }

        .programme-badge.audhd {
            background: #EDE9FE;
            color: #5B21B6;
        }

        .client-email {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .stage-badge {
            background: var(--purple-light);
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .stage-badge.complete {
            background: var(--success);
        }

        /* Homework Badge */
        .homework-badge {
            font-size: 0.65em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            background: #DBEAFE;
            color: #1D4ED8;
            margin-left: 4px;
        }

        .homework-badge.complete {
            background: #D1FAE5;
            color: #059669;
        }

        /* Client card with recent activity */
        .client-card.has-activity {
            box-shadow: 0 0 0 2px var(--gold), 0 8px 25px rgba(245, 158, 11, 0.2);
        }

        .client-card.has-activity::before {
            content: 'üîî';
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--gold);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        /* Activity item in Today section */
        .activity-item {
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--gold);
        }

        .activity-item .activity-text {
            flex: 1;
        }

        .activity-item .activity-name {
            font-weight: 600;
            color: var(--text-dark);
        }

        .activity-item .activity-detail {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .activity-item .activity-time {
            color: var(--purple-main);
            font-size: 0.8em;
            font-weight: 500;
            white-space: nowrap;
            margin-left: 10px;
        }

        /* Progress Bar */
        .progress-section {
            margin: 15px 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .progress-bar {
            height: 8px;
            background: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple-main), var(--gold));
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* Action Buttons */
        .card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #E5E7EB;
        }

        .action-btn {
            background: #F3F4F6;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            color: var(--text-dark);
        }

        .action-btn:hover {
            background: var(--purple-light);
            color: white;
        }

        .action-btn.primary {
            background: var(--purple-main);
            color: white;
        }

        .action-btn.primary:hover {
            background: var(--purple-dark);
        }

        /* Slide-out Panel */
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .slide-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            max-width: 90vw;
            height: 100vh;
            background: white;
            z-index: 300;
            box-shadow: -10px 0 40px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        .slide-panel.active {
            right: 0;
        }

        .panel-header {
            background: linear-gradient(135deg, var(--purple-dark), var(--purple-main));
            color: white;
            padding: 25px;
            position: sticky;
            top: 0;
        }

        .panel-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .panel-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .panel-client-name {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .panel-client-email {
            opacity: 0.8;
            font-size: 0.9em;
        }

        .panel-content {
            padding: 25px;
        }

        .panel-section {
            margin-bottom: 25px;
        }

        .panel-section h4 {
            font-size: 0.9em;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-item {
            background: #F9FAFB;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-item:hover {
            background: #EDE9FE;
        }

        .panel-item-title {
            font-weight: 500;
        }

        .panel-item-meta {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .view-full-btn {
            width: 100%;
            background: var(--purple-main);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1em;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
        }

        .view-full-btn:hover {
            background: var(--purple-dark);
        }

        /* Add Client Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 400;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--purple-main);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn-cancel {
            background: #E5E7EB;
            color: var(--text-dark);
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-save {
            background: var(--purple-main);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-save:hover {
            background: var(--purple-dark);
        }

        /* Login Section */
        .login-section {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .login-section h2 {
            color: var(--purple-main);
            margin-bottom: 10px;
        }

        .login-section p {
            color: var(--text-muted);
            margin-bottom: 25px;
        }

        .login-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 15px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--purple-main);
        }

        .password-wrapper {
            position: relative;
            width: 100%;
        }

        .password-wrapper .login-input {
            padding-right: 50px;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-70%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.6;
        }

        .password-toggle:hover {
            opacity: 1;
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--purple-main), var(--purple-dark));
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
        }

        .login-error {
            color: #DC2626;
            font-size: 0.9em;
            margin-top: 10px;
            display: none;
        }

        /* Empty State */
        .section-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .section-empty-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Calendar Styles */
        .calendar-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            border: 1px solid var(--warm-border);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-nav button {
            background: #F3F4F6;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: var(--purple-light);
            color: white;
        }

        .calendar-nav span {
            font-weight: 600;
            min-width: 180px;
            text-align: center;
        }

        .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .day-column {
            min-height: 200px;
        }

        .day-header {
            text-align: center;
            padding: 10px;
            background: linear-gradient(135deg, var(--purple-light) 0%, var(--purple-main) 100%);
            color: white;
            border-radius: 10px 10px 0 0;
            font-size: 0.85em;
        }

        .day-header.today {
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            color: var(--text-dark);
        }

        .day-header .day-name {
            font-weight: 600;
        }

        .day-header .day-date {
            font-size: 1.3em;
            font-weight: 700;
        }

        .day-slots {
            background: #FAFAFA;
            border: 1px solid #E5E7EB;
            border-top: none;
            border-radius: 0 0 10px 10px;
            min-height: 150px;
            padding: 8px;
        }

        .calendar-event {
            background: white;
            border-left: 3px solid var(--purple-main);
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .calendar-event:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .calendar-event.career {
            border-left-color: var(--gold);
        }

        .calendar-event.audhd {
            border-left-color: var(--purple-main);
        }

        .event-time {
            font-weight: 600;
            color: var(--purple-main);
            font-size: 0.9em;
        }

        .event-client {
            font-weight: 500;
            margin-top: 2px;
        }

        .event-type {
            color: var(--text-muted);
            font-size: 0.85em;
        }

        .add-session-btn {
            width: 100%;
            background: transparent;
            border: 2px dashed #D1D5DB;
            border-radius: 6px;
            padding: 10px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }

        .add-session-btn:hover {
            border-color: var(--purple-light);
            color: var(--purple-main);
            background: #F5F3FF;
        }

        .calendar-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .calendar-action-btn {
            background: #F3F4F6;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .calendar-action-btn:hover {
            background: var(--purple-light);
            color: white;
        }

        .calendar-action-btn.primary {
            background: var(--purple-main);
            color: white;
        }

        /* Schedule Session Modal */
        .schedule-modal .time-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Upload Section */
        .upload-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #E5E7EB;
        }

        .upload-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            color: var(--text-dark);
            border: none;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .upload-dropzone {
            border: 2px dashed #D1D5DB;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
            background: #FAFAFA;
        }

        .upload-dropzone:hover,
        .upload-dropzone.dragover {
            border-color: var(--purple-main);
            background: #F5F3FF;
        }

        .upload-dropzone-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .upload-dropzone-text {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .upload-dropzone-text strong {
            color: var(--purple-main);
        }

        .upload-file-list {
            margin-top: 15px;
        }

        .upload-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #F3F4F6;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .upload-file-name {
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-file-remove {
            background: none;
            border: none;
            color: #EF4444;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0 5px;
        }

        .upload-doc-type {
            margin-bottom: 20px;
        }

        .upload-doc-type label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .upload-doc-type select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #E5E7EB;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .upload-doc-type select:focus {
            outline: none;
            border-color: var(--purple-main);
        }

        .upload-progress {
            margin-top: 15px;
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        .upload-progress-bar {
            height: 8px;
            background: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple-main), var(--gold));
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .upload-success {
            display: none;
            background: #D1FAE5;
            color: #065F46;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
        }

        .upload-success.active {
            display: block;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .main-container {
                padding: 15px;
            }

            .clients-grid {
                grid-template-columns: 1fr;
            }

            .slide-panel {
                width: 100%;
                right: -100%;
            }

            .today-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Hub Navigation Tabs */
        .hub-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid var(--warm-border);
            padding: 0 30px;
            gap: 5px;
        }

        .hub-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 0.95em;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .hub-tab:hover {
            color: var(--purple-main);
        }

        .hub-tab.active {
            color: var(--purple-main);
            border-bottom-color: var(--purple-main);
            font-weight: 600;
        }

        .tab-divider {
            color: #E5E7EB;
            padding: 0 5px;
            font-weight: 300;
            align-self: center;
        }

        .tool-frame {
            width: 100%;
            height: calc(100vh - 180px);
            border: none;
            border-radius: 12px;
            background: white;
        }

        /* MailMatrix Styles */
        .mailmatrix-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--warm-border);
        }

        .mailmatrix-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .refresh-btn {
            background: var(--purple-main);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .refresh-btn:hover {
            background: var(--purple-dark);
        }

        .gmail-status {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .gmail-status.connected {
            color: var(--success);
        }

        .gmail-connect-prompt {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 16px;
            border: 2px dashed var(--warm-border);
        }

        .connect-gmail-btn {
            background: #EA4335;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }

        .connect-gmail-btn:hover {
            background: #d33426;
        }

        .email-matrix {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            min-height: 600px;
        }

        .matrix-quadrant {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
        }

        .matrix-quadrant.q1 {
            border-top: 4px solid #EF4444;
        }

        .matrix-quadrant.q2 {
            border-top: 4px solid #3B82F6;
        }

        .matrix-quadrant.q3 {
            border-top: 4px solid #F59E0B;
        }

        .matrix-quadrant.q4 {
            border-top: 4px solid #9CA3AF;
        }

        .quadrant-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #E5E7EB;
        }

        .quadrant-header h3 {
            font-size: 1em;
            margin-bottom: 4px;
        }

        .quadrant-subtitle {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        .email-list {
            flex: 1;
            overflow-y: auto;
            max-height: 250px;
        }

        .email-card {
            background: #F9FAFB;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .email-card:hover {
            background: #F3F4F6;
            transform: translateX(3px);
        }

        .email-sender {
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 4px;
        }

        .email-subject {
            font-size: 0.85em;
            color: var(--text-dark);
            margin-bottom: 6px;
        }

        .email-snippet {
            font-size: 0.8em;
            color: var(--text-muted);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .email-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .email-action-btn {
            padding: 5px 10px;
            font-size: 0.75em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .email-action-btn.done {
            background: var(--success);
            color: white;
        }

        .email-action-btn.move {
            background: #E5E7EB;
            color: var(--text-dark);
        }

        .empty-quadrant {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.9em;
        }

        /* Drag and Drop Styles */
        .email-card[draggable="true"] {
            cursor: grab;
        }

        .email-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .email-list.drag-over {
            background: rgba(124, 58, 237, 0.1);
            border: 2px dashed var(--purple-main);
            border-radius: 8px;
        }

        .matrix-quadrant.q1 .email-list.drag-over {
            background: rgba(239, 68, 68, 0.1);
            border-color: #EF4444;
        }

        .matrix-quadrant.q2 .email-list.drag-over {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22C55E;
        }

        .matrix-quadrant.q3 .email-list.drag-over {
            background: rgba(249, 115, 22, 0.1);
            border-color: #F97316;
        }

        .matrix-quadrant.q4 .email-list.drag-over {
            background: rgba(107, 114, 128, 0.1);
            border-color: #6B7280;
        }

        /* Settings Styles */
        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }

        .settings-card h3 {
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .settings-btn {
            background: var(--purple-main);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .settings-btn.danger {
            background: #EF4444;
        }

        .keyword-group {
            margin-bottom: 15px;
        }

        .keyword-group label {
            display: block;
            font-size: 0.9em;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .keyword-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .hub-tabs {
                overflow-x: auto;
                padding: 0 15px;
            }

            .email-matrix {
                grid-template-columns: 1fr;
            }
        }

        /* Calendar Section */
        .calendar-header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-actions-bar {
            display: flex;
            gap: 10px;
        }

        .calendar-btn {
            background: var(--purple-main);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .calendar-btn:hover {
            background: var(--purple-dark);
        }

        .calendar-embed-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
    </style>
</head>
<body>
    <!-- Login Section (shown when not logged in) -->
    <div id="loginSection" class="login-section">
        <h2>üî• Coach Hub</h2>
        <p>Sign in to manage your coaching clients</p>
        <input type="email" id="usernameInput" class="login-input" placeholder="Email address">
        <div class="password-wrapper">
            <input type="password" id="passwordInput" class="login-input" placeholder="Password">
            <button type="button" class="password-toggle" onclick="togglePassword()">üëÅ</button>
        </div>
        <button onclick="login()" class="login-btn">Sign In</button>
        <div id="loginError" class="login-error"></div>
        <a href="forgot-password.html" style="display: block; margin-top: 15px; color: #8B5CF6; text-decoration: none; font-size: 0.9em;">Forgot password?</a>
    </div>

    <!-- Main Dashboard (shown when logged in) -->
    <div id="dashboard" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1>üî• <span>Coach Hub</span></h1>
                <div id="dataBadge" class="data-badge live">PostgreSQL</div>
            </div>
            <div class="header-right">
                <a href="coach-automations.html" class="add-client-btn" style="background: #4ECDC4; text-decoration: none;">
                    ‚ö° Automations
                </a>
                <button onclick="openAddClientModal()" class="add-client-btn">
                    <span>+</span> Add Client
                </button>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">L</div>
                    <button onclick="logout()" class="logout-btn">Sign Out</button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="hub-tabs">
            <button class="hub-tab active" onclick="switchTab('clients')" data-tab="clients">
                üë• Clients
            </button>
            <button class="hub-tab" onclick="switchTab('mailmatrix')" data-tab="mailmatrix">
                üìß MailMatrix
            </button>
            <button class="hub-tab" onclick="switchTab('calendar')" data-tab="calendar">
                üìÜ Calendar
            </button>
            <span class="tab-divider">|</span>
            <button class="hub-tab" onclick="switchTab('braindump')" data-tab="braindump">
                üß† Brain Dump
            </button>
            <button class="hub-tab" onclick="switchTab('energy')" data-tab="energy">
                ‚ö° Energy
            </button>
            <button class="hub-tab" onclick="switchTab('foundations')" data-tab="foundations">
                üèóÔ∏è Foundations
            </button>
            <button class="hub-tab" onclick="switchTab('todaysplan')" data-tab="todaysplan">
                üìÖ Today's Plan
            </button>
            <button class="hub-tab" onclick="switchTab('beautifulbrain')" data-tab="beautifulbrain">
                üß¨ Beautiful Brain
            </button>
            <button class="hub-tab" onclick="switchTab('sparkcollector')" data-tab="sparkcollector">
                ‚ú® Spark Collector
            </button>
            <span class="tab-divider">|</span>
            <button class="hub-tab" onclick="switchTab('settings')" data-tab="settings">
                ‚öôÔ∏è Settings
            </button>
        </nav>

        <!-- MailMatrix Section -->
        <div id="mailmatrixSection" class="tab-content" style="display: none;">
            <div class="main-container">
                <div class="mailmatrix-header">
                    <h2>üìß MailMatrix - Email Triage</h2>
                    <div class="mailmatrix-actions">
                        <label style="display: flex; align-items: center; gap: 6px; font-size: 0.85em; color: #666; cursor: pointer;">
                            <input type="checkbox" id="includeAllEmails" onchange="loadEmails()">
                            Include promo/social
                        </label>
                        <button onclick="refreshEmails()" class="refresh-btn">üîÑ Refresh</button>
                        <span id="gmailStatus" class="gmail-status">Checking...</span>
                    </div>
                </div>

                <div id="gmailNotConnected" class="gmail-connect-prompt" style="display: none;">
                    <p>Connect your Gmail to use MailMatrix</p>
                    <button onclick="connectGmail()" class="connect-gmail-btn">üîó Connect Gmail</button>
                </div>

                <div id="emailMatrix" class="email-matrix" style="display: none;">
                    <!-- Q1: Urgent & Important -->
                    <div class="matrix-quadrant q1">
                        <div class="quadrant-header">
                            <h3>üî• Q1: Do First</h3>
                            <span class="quadrant-subtitle">Urgent & Important</span>
                        </div>
                        <div id="q1Emails" class="email-list">
                            <div class="empty-quadrant">No emails</div>
                        </div>
                    </div>

                    <!-- Q2: Important Not Urgent -->
                    <div class="matrix-quadrant q2">
                        <div class="quadrant-header">
                            <h3>üìã Q2: Schedule</h3>
                            <span class="quadrant-subtitle">Important, Not Urgent</span>
                        </div>
                        <div id="q2Emails" class="email-list">
                            <div class="empty-quadrant">No emails</div>
                        </div>
                    </div>

                    <!-- Q3: Urgent Not Important -->
                    <div class="matrix-quadrant q3">
                        <div class="quadrant-header">
                            <h3>üëã Q3: Delegate</h3>
                            <span class="quadrant-subtitle">Urgent, Not Important</span>
                        </div>
                        <div id="q3Emails" class="email-list">
                            <div class="empty-quadrant">No emails</div>
                        </div>
                    </div>

                    <!-- Q4: Neither -->
                    <div class="matrix-quadrant q4">
                        <div class="quadrant-header">
                            <h3>üóëÔ∏è Q4: Delete/Defer</h3>
                            <span class="quadrant-subtitle">Neither Urgent nor Important</span>
                        </div>
                        <div id="q4Emails" class="email-list">
                            <div class="empty-quadrant">No emails</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Brain Dump Section -->
        <div id="braindumpSection" class="tab-content" style="display: none;">
            <iframe src="/audhd-braindump.html" class="tool-frame"></iframe>
        </div>

        <!-- Energy Section -->
        <div id="energySection" class="tab-content" style="display: none;">
            <iframe src="/audhd-energy.html" class="tool-frame"></iframe>
        </div>

        <!-- Foundations Section -->
        <div id="foundationsSection" class="tab-content" style="display: none;">
            <iframe src="/audhd-foundations.html" class="tool-frame"></iframe>
        </div>

        <!-- Today's Plan Section -->
        <div id="todaysplanSection" class="tab-content" style="display: none;">
            <iframe src="/todays-plan.html" class="tool-frame"></iframe>
        </div>

        <!-- Beautiful Brain Section -->
        <div id="beautifulbrainSection" class="tab-content" style="display: none;">
            <iframe src="/processing-profile.html" class="tool-frame"></iframe>
        </div>

        <!-- Spark Collector Section -->
        <div id="sparkcollectorSection" class="tab-content" style="display: none;">
            <iframe src="/spark-collector.html" class="tool-frame"></iframe>
        </div>

        <!-- Settings Section -->
        <div id="settingsSection" class="tab-content" style="display: none;">
            <div class="main-container">
                <h2 style="margin-bottom: 20px;">‚öôÔ∏è Settings</h2>

                <div class="settings-card">
                    <h3>üìß Gmail Connection</h3>
                    <div id="gmailSettingsStatus"></div>
                    <button onclick="connectGmail()" class="settings-btn">Connect Gmail</button>
                    <button onclick="disconnectGmail()" class="settings-btn danger" style="margin-left: 10px;">Disconnect</button>
                </div>

                <div class="settings-card" style="margin-top: 20px;">
                    <h3>üè∑Ô∏è Email Keywords</h3>
                    <p style="color: var(--text-muted); font-size: 0.9em; margin-bottom: 15px;">
                        Customise how emails are classified in MailMatrix
                    </p>
                    <div class="keyword-group">
                        <label>Urgent Keywords (comma separated):</label>
                        <input type="text" id="urgentKeywords" placeholder="urgent, asap, deadline, emergency">
                    </div>
                    <div class="keyword-group">
                        <label>Important Keywords:</label>
                        <input type="text" id="importantKeywords" placeholder="invoice, contract, client, meeting">
                    </div>
                    <div class="keyword-group">
                        <label>Low Priority Senders:</label>
                        <input type="text" id="lowPrioritySenders" placeholder="noreply, newsletter, marketing">
                    </div>
                    <button onclick="saveEmailPreferences()" class="settings-btn" style="margin-top: 15px;">Save Preferences</button>
                </div>
            </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendarSection" class="tab-content" style="display: none;">
            <div class="main-container">
                <div class="calendar-header-bar">
                    <h2>üìÜ Calendar & Bookings</h2>
                    <div class="calendar-actions-bar">
                        <button onclick="openGoogleCalendar()" class="calendar-btn">‚ÜóÔ∏è Open Google Calendar</button>
                    </div>
                </div>

                <!-- Booking System Card -->
                <div class="booking-card" style="background: linear-gradient(135deg, var(--purple-main) 0%, var(--purple-dark) 100%); border-radius: 12px; padding: 25px; margin-bottom: 20px; color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h3 style="font-size: 1.3em; margin-bottom: 8px;">üìÖ Appointment Booking System</h3>
                            <p style="opacity: 0.9; font-size: 0.95em;">Manage client sessions, availability, and bookings</p>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <a href="https://sparkhub-be-qtmmb.ondigitalocean.app/secure-admin/crm/appointmentbooking/"
                               target="_blank"
                               style="background: var(--gold); color: var(--text-dark); padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px;">
                                üóìÔ∏è Open Booking System
                            </a>
                            <a href="https://sparkhub-be-qtmmb.ondigitalocean.app/secure-admin/crm/appointmentslot/"
                               target="_blank"
                               style="background: rgba(255,255,255,0.2); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500;">
                                ‚öôÔ∏è Manage Slots
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Google Calendar Embed -->
                <div class="calendar-embed-container">
                    <iframe
                        id="googleCalendarIframe"
                        src="https://calendar.google.com/calendar/embed?src=lisa%40harnessthespark.com&ctz=Europe%2FLondon&mode=WEEK&showTitle=0&showNav=1&showPrint=0&showTabs=1&showCalendars=0"
                        style="border: 0; width: 100%; height: 550px; border-radius: 12px;"
                        frameborder="0"
                        scrolling="no">
                    </iframe>
                </div>

                <!-- Quick Links -->
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <a href="https://sparkhub-be-qtmmb.ondigitalocean.app/secure-admin/crm/coachingsession/"
                       target="_blank"
                       class="quick-link-card"
                       style="background: white; padding: 15px 20px; border-radius: 8px; text-decoration: none; color: var(--text-dark); display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <span style="font-size: 1.5em;">üìù</span>
                        <div>
                            <strong>Session Notes</strong>
                            <p style="font-size: 0.85em; color: var(--text-muted); margin-top: 2px;">View coaching sessions</p>
                        </div>
                    </a>
                    <a href="https://sparkhub-be-qtmmb.ondigitalocean.app/secure-admin/crm/sypclient/"
                       target="_blank"
                       class="quick-link-card"
                       style="background: white; padding: 15px 20px; border-radius: 8px; text-decoration: none; color: var(--text-dark); display: flex; align-items: center; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <span style="font-size: 1.5em;">üë•</span>
                        <div>
                            <strong>SparkHub Clients</strong>
                            <p style="font-size: 0.85em; color: var(--text-muted); margin-top: 2px;">CRM in Django admin</p>
                        </div>
                    </a>
                </div>
            </div>
        </div>

        <!-- Clients Section (original content) -->
        <div id="clientsSection" class="tab-content">
        <main class="main-container">
            <!-- Today Section -->
            <section class="today-section">
                <div class="section-header">
                    <h2 class="section-title">üìÖ Today</h2>
                    <span id="todayDate" style="color: var(--text-muted); font-size: 0.9em;"></span>
                </div>
                <div class="today-grid">
                    <div class="today-card">
                        <h3>üóìÔ∏è Sessions</h3>
                        <div id="todaySessions">
                            <div class="empty-state">No sessions scheduled today</div>
                        </div>
                    </div>
                    <div class="today-card">
                        <h3>üìù Client Activity</h3>
                        <div id="recentActivity">
                            <div class="empty-state">No recent activity</div>
                        </div>
                    </div>
                    <div class="today-card">
                        <h3>‚ö° Quick Actions</h3>
                        <div class="today-item" onclick="openAddClientModal()" style="cursor: pointer;">
                            <span>+ Add new client</span>
                        </div>
                        <div class="today-item" onclick="refreshClients()" style="cursor: pointer;">
                            <span>üîÑ Refresh data</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Calendar Link -->
            <section class="calendar-quick-link" style="background: linear-gradient(135deg, var(--purple-light) 0%, var(--purple-main) 100%); border-radius: 12px; padding: 20px; margin-bottom: 25px; color: white;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h3 style="margin-bottom: 5px;">üìÜ Calendar & Bookings</h3>
                        <p style="opacity: 0.9; font-size: 0.9em;">View schedule and manage appointments</p>
                    </div>
                    <button onclick="switchTab('calendar')" style="background: white; color: var(--purple-main); border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Open Calendar ‚Üí
                    </button>
                </div>
            </section>

            <!-- Pipeline Section -->
            <section class="clients-section" id="pipelineSection">
                <div class="section-bar">
                    <h2>üå± Pipeline <span class="section-count" id="pipelineCount">0</span></h2>
                </div>
                <div class="clients-grid" id="pipelineGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </section>

            <!-- Active Section -->
            <section class="clients-section" id="activeSection">
                <div class="section-bar">
                    <h2>üî• Active <span class="section-count" id="activeCount">0</span></h2>
                </div>
                <div class="clients-grid" id="activeGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </section>

            <!-- Completed Section -->
            <section class="clients-section" id="completedSection">
                <div class="section-bar">
                    <h2>üèÜ Completed <span class="section-count" id="completedCount">0</span></h2>
                </div>
                <div class="clients-grid" id="completedGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </section>
        </main>
        </div><!-- End clientsSection -->
    </div>

    <!-- Slide-out Panel -->
    <div class="panel-overlay" id="panelOverlay" onclick="closePanel()"></div>
    <div class="slide-panel" id="slidePanel">
        <div class="panel-header">
            <button class="panel-close" onclick="closePanel()">√ó</button>
            <div class="panel-client-name" id="panelClientName">Client Name</div>
            <div class="panel-client-email" id="panelClientEmail">email@example.com</div>
        </div>
        <div class="panel-content">
            <div class="panel-section">
                <h4>üìÅ Documents</h4>
                <div id="panelDocs">
                    <!-- Populated dynamically based on programme type -->
                </div>
            </div>

            <div class="upload-section">
                <button class="upload-btn" onclick="openUploadModal()">
                    <span>üì§</span> Upload Missing Document
                </button>
                <p style="text-align: center; margin-top: 8px; font-size: 0.8em; color: var(--text-muted);">
                    Upload agreements, notes, or other files
                </p>
            </div>
        </div>
    </div>

    <!-- Schedule Session Modal -->
    <div class="modal-overlay" id="scheduleModal">
        <div class="modal">
            <h2>üìÖ Schedule Session</h2>
            <div class="form-group">
                <label>Client</label>
                <select id="sessionClient">
                    <option value="">Select a client...</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="sessionDate">
            </div>
            <div class="form-group">
                <label>Time</label>
                <input type="time" id="sessionTime" value="10:00">
            </div>
            <div class="form-group">
                <label>Duration</label>
                <select id="sessionDuration">
                    <option value="60">1 hour</option>
                    <option value="90">1.5 hours</option>
                    <option value="30">30 minutes</option>
                </select>
            </div>
            <div class="form-group">
                <label>Session Type</label>
                <select id="sessionType">
                    <option value="coaching">üíº Coaching Session</option>
                    <option value="discovery">üîç Discovery Call</option>
                    <option value="review">üìã Review/Catch-up</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes (optional)</label>
                <input type="text" id="sessionNotes" placeholder="Any notes for this session...">
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeScheduleModal()">Cancel</button>
                <button class="btn-save" onclick="saveSession()">Schedule</button>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal-overlay" id="addClientModal">
        <div class="modal">
            <h2>‚ûï Add New Client</h2>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="newClientName" placeholder="e.g. John Smith">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="newClientEmail" placeholder="e.g. john@example.com">
            </div>
            <div class="form-group">
                <label>Programme</label>
                <select id="newClientProgramme">
                    <option value="career">üíº Career Booster</option>
                    <option value="audhd">üß† Spark Coaching</option>
                    <option value="blended">‚ú® Blended (Career + Mind)</option>
                    <option value="all">üîë All Access (Testing)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeAddClientModal()">Cancel</button>
                <button class="btn-save" onclick="saveNewClient()">Add Client</button>
            </div>
        </div>
    </div>

    <!-- Upload Document Modal -->
    <div class="modal-overlay" id="uploadModal">
        <div class="modal">
            <h2>üì§ Upload Document</h2>
            <p style="color: var(--text-muted); margin-bottom: 20px;">
                Upload documents for <strong id="uploadClientName">Client</strong>
            </p>

            <div class="upload-doc-type">
                <label>Document Type</label>
                <select id="uploadDocType">
                    <option value="agreement">üìã Coaching Agreement</option>
                    <option value="notes">üìù Session Notes</option>
                    <option value="blueprint">üéØ Career Blueprint</option>
                    <option value="cv">üìÑ CV / Resume</option>
                    <option value="decision">‚öñÔ∏è Decision Framework</option>
                    <option value="mapping">üó∫Ô∏è Mapping Guide</option>
                    <option value="other">üìÅ Other Document</option>
                </select>
            </div>

            <div class="upload-dropzone" id="uploadDropzone" onclick="document.getElementById('fileInput').click()">
                <div class="upload-dropzone-icon">üìÅ</div>
                <div class="upload-dropzone-text">
                    <strong>Click to upload</strong> or drag and drop<br>
                    <small>PDF, DOC, DOCX, HTML, or images (max 10MB)</small>
                </div>
            </div>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf,.doc,.docx,.html,.htm,.jpg,.jpeg,.png,.gif" onchange="handleFileSelect(event)">

            <div class="upload-file-list" id="uploadFileList"></div>

            <div class="upload-progress" id="uploadProgress">
                <div class="upload-progress-bar">
                    <div class="upload-progress-fill" id="uploadProgressFill"></div>
                </div>
                <p style="text-align: center; margin-top: 8px; font-size: 0.85em; color: var(--text-muted);">Uploading...</p>
            </div>

            <div class="upload-success" id="uploadSuccess">
                <strong>‚úÖ Upload Complete!</strong><br>
                <span id="uploadSuccessMessage">Document has been saved.</span>
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeUploadModal()">Cancel</button>
                <button class="btn-save" id="uploadSubmitBtn" onclick="submitUpload()" disabled>Upload Document</button>
            </div>
        </div>
    </div>

    <!-- Client Notes Modal -->
    <div class="modal-overlay" id="notesModal">
        <div class="modal" style="max-width: 600px;">
            <h2>üìù Session Notes</h2>
            <p style="color: var(--text-muted); margin-bottom: 15px;">
                Notes for <strong id="notesClientName">Client</strong>
            </p>
            <div class="form-group">
                <label>Session Notes</label>
                <textarea id="clientNotes" placeholder="Add notes from your coaching sessions..." style="min-height: 200px; width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label>Key Insights</label>
                <textarea id="clientInsights" placeholder="What patterns or insights have you noticed?" style="min-height: 100px; width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
                <label>Next Steps</label>
                <textarea id="clientNextSteps" placeholder="Actions or goals for next session..." style="min-height: 80px; width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: inherit; resize: vertical;"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeNotesModal()">Cancel</button>
                <button class="btn-save" onclick="saveClientNotes()">üíæ Save Notes</button>
            </div>
        </div>
    </div>

    <!-- Edit Client Modal -->
    <div class="modal-overlay" id="editClientModal">
        <div class="modal">
            <h2>‚úèÔ∏è Edit Client</h2>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="editClientName" placeholder="e.g. John Smith">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editClientEmail" placeholder="e.g. john@example.com">
            </div>
            <div class="form-group">
                <label>Programme</label>
                <select id="editClientProgramme">
                    <option value="career">üíº Career Booster</option>
                    <option value="audhd">üß† Spark Coaching</option>
                    <option value="blended">‚ú® Blended (Career + Mind)</option>
                    <option value="all">üîë All Access (Testing)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Current Stage</label>
                <select id="editClientStage">
                    <option value="discovery">Discovery</option>
                    <option value="week-1">Week 1</option>
                    <option value="week-2">Week 2</option>
                    <option value="week-3">Week 3</option>
                    <option value="week-4">Week 4</option>
                    <option value="complete">Complete</option>
                </select>
            </div>
            <input type="hidden" id="editClientId">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeEditClientModal()">Cancel</button>
                <button class="btn-save" onclick="saveEditedClient()">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        // Config - Single backend for auth (SYP Express), SparkHub for CRM
        const SPARKHUB_API = 'https://sparkhub-be-qtmmb.ondigitalocean.app';  // CRM only
        const SYP_API = '';  // Same origin for SYP Express
        const API_BASE = SPARKHUB_API;  // For CRM compatibility

        // Default clients for fallback when API unavailable
        const DEFAULT_CLIENTS = [
            {
                id: 'raj-samuel',
                full_name: 'Raj Samuel',
                name: 'Raj Samuel',
                email: 'rs@rajsamuel.net',
                programme_type: 'career',
                programme_status: 'week-3',
                status: 'week-3',
                enrolled_date: '2025-12-01',
                folder: 'Raj_Samuel'
            },
            {
                id: 'donald-pirie',
                full_name: 'Donald Pirie',
                name: 'Donald Pirie',
                email: 'donaldpirie111@hotmail.co.uk',
                programme_type: 'career',
                programme_status: 'complete',
                status: 'complete',
                enrolled_date: '2024-10-01',
                folder: 'Donald_Pirie'
            },
            {
                id: 'simon-booth-lucking',
                full_name: 'Simon Booth-Lucking',
                name: 'Simon Booth-Lucking',
                email: 'simon@boothlucking.com',
                programme_type: 'career',
                programme_status: 'discovery',
                status: 'discovery',
                enrolled_date: '2025-12-01',
                folder: 'Simon_Booth_Lucking'
            },
            {
                id: 'george-jones',
                full_name: 'George Jones',
                name: 'George Jones',
                email: 'george.jones@demo.sparkhub.io',
                programme_type: 'career',
                programme_status: 'week-4',
                status: 'week-4',
                enrolled_date: '2025-12-05',
                folder: 'George_Jones',
                is_demo: true
            },
            {
                id: 'chloe-cal',
                full_name: 'Chloe Cal',
                name: 'Chloe Cal',
                email: 'chloe@thisiscal.com',
                programme_type: 'audhd',
                programme_status: 'week-2',
                status: 'week-2',
                enrolled_date: '2025-12-01',
                folder: 'Chloe_Cal'
            },
            {
                id: 'deb-briggs',
                full_name: 'Deb Briggs',
                name: 'Deb Briggs',
                email: 'deborah_armstrong@hotmail.com',
                programme_type: 'audhd',
                programme_status: 'week-2',
                status: 'week-2',
                enrolled_date: '2025-12-01',
                folder: 'Deb_Briggs'
            },
            {
                id: 'peter-morgan',
                full_name: 'Peter Morgan',
                name: 'Peter Morgan',
                email: 'pete_morgan69@hotmail.com',
                programme_type: 'blended',
                programme_status: 'week-1',
                status: 'week-1',
                enrolled_date: '2025-12-01',
                folder: 'Peter_Morgan',
                files: {
                    agreement: 'Peter_Morgan/Peter_Morgan_Coaching_Agreement.html',
                    questionnaire: 'Peter_Morgan/Peter_Morgan_Discovery_Questionnaire.html',
                    welcomeCall: 'Peter_Morgan/Peter_Morgan_Welcome_Call_Agenda.html'
                }
            },
            {
                id: 'lisa-gills',
                full_name: 'Lisa Gills',
                name: 'Lisa Gills',
                email: 'lisa.gills@icloud.com',
                programme_type: 'all',
                programme_status: 'week-1',
                status: 'week-1',
                enrolled_date: '2025-12-01',
                folder: 'Lisa_Gills'
            }
        ];

        // Coach email for API calls
        const COACH_EMAIL = 'lisa@harnessthespark.com';

        // Password toggle
        function togglePassword() {
            const input = document.getElementById('passwordInput');
            const btn = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅ';
            }
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================

        function switchTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });

            // Remove active from all tabs
            document.querySelectorAll('.hub-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const sectionId = tabName + 'Section';
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
            }

            // Mark tab as active
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Load content for specific tabs
            if (tabName === 'mailmatrix') {
                checkGmailStatus();
            } else if (tabName === 'settings') {
                loadSettings();
            }
        }

        // ============================================
        // GMAIL / MAILMATRIX FUNCTIONS
        // ============================================

        async function checkGmailStatus() {
            try {
                const response = await fetch(`/api/gmail/status?email=${COACH_EMAIL}`);
                const data = await response.json();

                const statusEl = document.getElementById('gmailStatus');
                const notConnectedEl = document.getElementById('gmailNotConnected');
                const matrixEl = document.getElementById('emailMatrix');

                if (data.connected) {
                    statusEl.textContent = '‚úÖ Connected: ' + (data.gmail_email || 'Gmail');
                    statusEl.classList.add('connected');
                    notConnectedEl.style.display = 'none';
                    matrixEl.style.display = 'grid';
                    loadEmails();
                } else {
                    statusEl.textContent = '‚ùå Not connected';
                    statusEl.classList.remove('connected');
                    notConnectedEl.style.display = 'block';
                    matrixEl.style.display = 'none';
                }
            } catch (error) {
                console.error('Gmail status check failed:', error);
                document.getElementById('gmailStatus').textContent = '‚ö†Ô∏è Error checking status';
            }
        }

        function connectGmail() {
            window.location.href = `/api/gmail/auth?email=${COACH_EMAIL}`;
        }

        async function disconnectGmail() {
            if (!confirm('Disconnect Gmail? You will need to reconnect to use MailMatrix.')) return;

            try {
                await fetch('/api/gmail/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: COACH_EMAIL })
                });
                checkGmailStatus();
            } catch (error) {
                console.error('Disconnect failed:', error);
            }
        }

        async function loadEmails() {
            try {
                const includeAll = document.getElementById('includeAllEmails')?.checked || false;
                const response = await fetch(`/api/gmail/emails?email=${COACH_EMAIL}&max=50&all=${includeAll}`);
                const data = await response.json();

                console.log('üìß Email fetch response:', data);

                if (!data.success) {
                    console.error('Failed to load emails:', data.error);
                    // Show error in Q1 quadrant
                    document.getElementById('q1Emails').innerHTML = `<div class="empty-quadrant" style="color: #EF4444;">Error: ${data.error}</div>`;
                    return;
                }

                console.log(`üìß Got ${data.emails?.length || 0} emails`);

                // Clear existing emails
                ['q1', 'q2', 'q3', 'q4'].forEach(q => {
                    document.getElementById(q + 'Emails').innerHTML = '<div class="empty-quadrant">No emails</div>';
                });

                // Group emails by quadrant
                const quadrants = { Q1: [], Q2: [], Q3: [], Q4: [] };
                data.emails.forEach(email => {
                    const q = email.quadrant || 'Q2';
                    if (quadrants[q]) {
                        quadrants[q].push(email);
                    }
                });

                // Render each quadrant
                Object.entries(quadrants).forEach(([q, emails]) => {
                    const container = document.getElementById(q.toLowerCase() + 'Emails');
                    if (emails.length === 0) {
                        container.innerHTML = '<div class="empty-quadrant">No emails</div>';
                    } else {
                        container.innerHTML = emails.map(email => renderEmailCard(email)).join('');
                    }
                });

                // Initialize drag-and-drop after rendering
                initDragDrop();

            } catch (error) {
                console.error('Load emails failed:', error);
            }
        }

        function renderEmailCard(email) {
            return `
                <div class="email-card"
                     draggable="true"
                     data-email-id="${email.id}"
                     data-quadrant="${email.quadrant || 'Q2'}"
                     ondragstart="handleDragStart(event, '${email.id}')"
                     ondragend="handleDragEnd(event)"
                     onclick="openEmail('${email.id}')">
                    <div class="email-sender">${escapeHtml(email.sender_name || email.sender_email)}</div>
                    <div class="email-subject">${escapeHtml(email.subject || '(No subject)')}</div>
                    <div class="email-snippet">${escapeHtml(email.snippet || '')}</div>
                    <div class="email-actions">
                        <button class="email-action-btn done" onclick="event.stopPropagation(); markEmailDone('${email.id}', 'archive')">‚úì Done</button>
                        <button class="email-action-btn move" onclick="event.stopPropagation(); markEmailDone('${email.id}', 'read')">üëÅ Read</button>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openEmail(messageId) {
            window.open(`https://mail.google.com/mail/u/0/#inbox/${messageId}`, '_blank');
        }

        async function markEmailDone(messageId, action) {
            try {
                await fetch('/api/gmail/mark-done', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: COACH_EMAIL,
                        message_id: messageId,
                        action: action
                    })
                });
                loadEmails(); // Refresh
            } catch (error) {
                console.error('Mark done failed:', error);
            }
        }

        function refreshEmails() {
            loadEmails();
        }

        // ============================================
        // DRAG AND DROP FUNCTIONS
        // ============================================

        let draggedEmailId = null;

        function handleDragStart(event, emailId) {
            draggedEmailId = emailId;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', emailId);
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            draggedEmailId = null;
            // Remove drag-over from all lists
            document.querySelectorAll('.email-list').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(event, targetQuadrant) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const emailId = event.dataTransfer.getData('text/plain') || draggedEmailId;
            if (!emailId) return;

            // Find the card and its current quadrant
            const card = document.querySelector(`[data-email-id="${emailId}"]`);
            const currentQuadrant = card ? card.dataset.quadrant : null;

            if (currentQuadrant === targetQuadrant) return; // No change needed

            console.log(`Moving email ${emailId} from ${currentQuadrant} to ${targetQuadrant}`);

            // Optimistic UI update - move the card immediately
            const targetContainer = document.getElementById(targetQuadrant.toLowerCase() + 'Emails');
            if (card && targetContainer) {
                card.dataset.quadrant = targetQuadrant;
                targetContainer.appendChild(card);

                // Update empty state in source
                const sourceContainer = document.getElementById(currentQuadrant.toLowerCase() + 'Emails');
                if (sourceContainer && sourceContainer.children.length === 0) {
                    sourceContainer.innerHTML = '<div class="empty-quadrant">No emails</div>';
                }

                // Remove empty state from target if present
                const emptyState = targetContainer.querySelector('.empty-quadrant');
                if (emptyState) {
                    emptyState.remove();
                }
            }

            // Save to server
            try {
                await fetch('/api/gmail/move-quadrant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: COACH_EMAIL,
                        message_id: emailId,
                        quadrant: targetQuadrant
                    })
                });
            } catch (error) {
                console.error('Failed to save quadrant move:', error);
                // Reload to restore correct state
                loadEmails();
            }
        }

        // Initialize drag-drop on quadrant containers
        function initDragDrop() {
            ['Q1', 'Q2', 'Q3', 'Q4'].forEach(q => {
                const container = document.getElementById(q.toLowerCase() + 'Emails');
                if (container) {
                    container.addEventListener('dragover', handleDragOver);
                    container.addEventListener('dragleave', handleDragLeave);
                    container.addEventListener('drop', (e) => handleDrop(e, q));
                }
            });
        }

        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================

        async function loadSettings() {
            // Load Gmail status
            try {
                const response = await fetch(`/api/gmail/status?email=${COACH_EMAIL}`);
                const data = await response.json();

                const statusEl = document.getElementById('gmailSettingsStatus');
                if (data.connected) {
                    statusEl.innerHTML = `<p style="color: var(--success);">‚úÖ Connected to: ${data.gmail_email}</p>`;
                } else {
                    statusEl.innerHTML = `<p style="color: #EF4444;">‚ùå Gmail not connected</p>`;
                }
            } catch (error) {
                console.error('Load settings failed:', error);
            }

            // Load email preferences
            try {
                const response = await fetch(`/api/gmail/preferences?email=${COACH_EMAIL}`);
                const data = await response.json();

                if (data.preferences) {
                    const p = data.preferences;
                    document.getElementById('urgentKeywords').value = (p.urgent_keywords || []).join(', ');
                    document.getElementById('importantKeywords').value = (p.important_keywords || []).join(', ');
                    document.getElementById('lowPrioritySenders').value = (p.low_priority_senders || []).join(', ');
                }
            } catch (error) {
                console.error('Load preferences failed:', error);
            }
        }

        async function saveEmailPreferences() {
            const parseKeywords = (str) => str.split(',').map(s => s.trim().toLowerCase()).filter(s => s);

            try {
                await fetch('/api/gmail/preferences', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: COACH_EMAIL,
                        urgent_keywords: parseKeywords(document.getElementById('urgentKeywords').value),
                        important_keywords: parseKeywords(document.getElementById('importantKeywords').value),
                        low_priority_senders: parseKeywords(document.getElementById('lowPrioritySenders').value)
                    })
                });
                alert('Preferences saved!');
            } catch (error) {
                console.error('Save preferences failed:', error);
                alert('Failed to save preferences');
            }
        }

        // ============================================
        // ORIGINAL COACH HUB CODE
        // ============================================

        // State
        let authToken = null;
        let currentUser = null;
        let clients = [];
        let selectedClient = null;

        // Initialise
        window.onload = function() {
            // Check for Gmail OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('gmail') === 'success') {
                alert('‚úÖ Gmail connected successfully!');
                window.history.replaceState({}, '', '/coach-hub.html');
                switchTab('mailmatrix');
            } else if (urlParams.get('gmail') === 'error') {
                alert('‚ùå Gmail connection failed: ' + (urlParams.get('reason') || 'Unknown error'));
                window.history.replaceState({}, '', '/coach-hub.html');
            }
            // Set today's date
            const today = new Date();
            document.getElementById('todayDate').textContent = today.toLocaleDateString('en-GB', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Check for saved session
            const savedUser = localStorage.getItem('syp_user');
            const savedToken = localStorage.getItem('syp_token');

            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    // Only auto-login if user is admin
                    if (currentUser.is_admin) {
                        authToken = savedToken || currentUser.jwt_token || 'syp-session';
                        showDashboard();
                    }
                } catch (e) {
                    console.error('Invalid saved session');
                    localStorage.removeItem('syp_user');
                    localStorage.removeItem('syp_token');
                }
            }
        };

        // Login
        async function login() {
            const email = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorEl = document.getElementById('loginError');

            errorEl.style.display = 'none';

            if (!email || !password) {
                errorEl.textContent = 'Please enter email and password';
                errorEl.style.display = 'block';
                return;
            }

            try {
                // Use SYP Express for auth (single backend)
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email.toLowerCase(), password })
                });

                const data = await response.json();

                if (data.success && data.user) {
                    // Check if user is admin
                    if (!data.user.is_admin) {
                        errorEl.textContent = 'Access denied. Coach login required.';
                        errorEl.style.display = 'block';
                        return;
                    }

                    currentUser = data.user;
                    authToken = data.user.jwt_token || 'syp-session';

                    localStorage.setItem('syp_user', JSON.stringify(currentUser));
                    localStorage.setItem('syp_client_email', email);
                    if (data.user.jwt_token) {
                        localStorage.setItem('syp_token', data.user.jwt_token);
                    }

                    showDashboard();
                } else {
                    errorEl.textContent = data.error || 'Invalid credentials';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = 'Connection error. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        // Logout
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('syp_token');
            localStorage.removeItem('syp_user');
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loginSection').style.display = 'block';
        }

        // Show Dashboard
        async function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';

            // Set user avatar
            if (currentUser?.first_name) {
                document.getElementById('userAvatar').textContent = currentUser.first_name.charAt(0).toUpperCase();
            }

            // Load clients
            await loadClients();
        }

        // Load Clients from PostgreSQL - SYP API FIRST, then SparkHub, then DEFAULT_CLIENTS
        async function loadClients() {
            console.log('üîÑ Loading clients from PostgreSQL...');

            let apiClients = [];
            let apiSuccess = false;
            let dataSource = 'Local';

            // Step 1: Try SYP Express backend first (has homework, blueprints, etc.)
            try {
                console.log('üì° Trying SYP API...');
                const sypResponse = await fetch(`${SYP_API}/api/clients`);

                if (sypResponse.ok) {
                    const sypData = await sypResponse.json();
                    console.log('üì¶ SYP API data:', sypData);

                    if (sypData.success && sypData.clients && sypData.clients.length > 0) {
                        apiClients = sypData.clients;
                        apiSuccess = true;
                        dataSource = 'PostgreSQL (SYP)';
                        console.log('‚úÖ Loaded', apiClients.length, 'clients from SYP PostgreSQL');
                    }
                }
            } catch (sypError) {
                console.warn('‚ö†Ô∏è SYP API error:', sypError.message);
            }

            // Step 2: If SYP didn't work, try SparkHub API
            if (!apiSuccess && authToken) {
                try {
                    console.log('üì° Trying SparkHub API...');
                    const response = await fetch(`${SPARKHUB_API}/api/crm/syp/coach/clients/`, {
                        headers: {
                            'Authorization': `Token ${authToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const sparkClients = Array.isArray(data) ? data : (data.results || []);

                        if (sparkClients.length > 0) {
                            apiClients = sparkClients;
                            apiSuccess = true;
                            dataSource = 'PostgreSQL (SparkHub)';
                            console.log('‚úÖ Loaded', apiClients.length, 'clients from SparkHub');
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è SparkHub API error:', error.message);
                }
            }

            // Step 3: Merge with DEFAULT_CLIENTS (API data takes precedence)
            console.log('üîÄ Merging with DEFAULT_CLIENTS...');
            const mergedMap = new Map();

            // Add DEFAULT_CLIENTS first as base
            DEFAULT_CLIENTS.forEach(client => {
                const key = (client.email || '').toLowerCase();
                mergedMap.set(key, { ...client });
            });

            // Override with API data (API is source of truth for matching emails)
            apiClients.forEach(apiClient => {
                const key = (apiClient.email || '').toLowerCase();
                if (mergedMap.has(key)) {
                    const existing = mergedMap.get(key);
                    mergedMap.set(key, { ...existing, ...apiClient });
                    console.log(`  üîÑ Updated from API: ${apiClient.full_name || apiClient.name}`);
                } else {
                    mergedMap.set(key, apiClient);
                    console.log(`  ‚ûï Added from API: ${apiClient.full_name || apiClient.name}`);
                }
            });

            clients = Array.from(mergedMap.values());
            console.log(`‚úÖ Total clients: ${clients.length} (Source: ${dataSource})`);

            // Update badge
            const badge = document.getElementById('dataBadge');
            if (apiSuccess) {
                badge.className = 'data-badge live';
                badge.textContent = dataSource;
            } else {
                badge.className = 'data-badge cached';
                badge.textContent = 'Local';
            }

            renderClients();
        }

        // Refresh
        function refreshClients() {
            loadClients();
        }

        // Render Clients by Section
        function renderClients() {
            console.log('üé® Rendering clients:', clients.length);
            const pipeline = [];
            const active = [];
            const completed = [];

            clients.forEach(client => {
                const status = client.programme_status || client.status || 'enrolled';
                console.log(`  - ${client.full_name}: ${status}`);

                if (status === 'completed' || status === 'complete') {
                    completed.push(client);
                } else if (status === 'lead' || status === 'pipeline') {
                    pipeline.push(client);
                } else {
                    active.push(client);
                }
            });

            console.log(`üìä Pipeline: ${pipeline.length}, Active: ${active.length}, Completed: ${completed.length}`);

            // Render each section
            renderSection('pipelineGrid', 'pipelineCount', pipeline, 'üå±');
            renderSection('activeGrid', 'activeCount', active, 'üî•');
            renderSection('completedGrid', 'completedCount', completed, 'üèÜ');

            // Update activity section with recent homework updates
            updateActivitySection();
        }

        // Update the Client Activity section with recent homework updates
        function updateActivitySection() {
            const activityContainer = document.getElementById('recentActivity');
            if (!activityContainer) return;

            // Get all clients with recent homework activity (sorted by most recent)
            const recentActivity = clients
                .filter(c => c.homework_updated)
                .sort((a, b) => new Date(b.homework_updated) - new Date(a.homework_updated))
                .slice(0, 5); // Show top 5 most recent

            if (recentActivity.length === 0) {
                activityContainer.innerHTML = '<div class="empty-state">No recent activity</div>';
                return;
            }

            activityContainer.innerHTML = recentActivity.map(client => {
                const name = client.full_name || client.name || 'Unknown';
                const progress = client.homework_progress || 0;
                const updatedDate = new Date(client.homework_updated);
                const timeAgo = getTimeAgo(updatedDate);

                // Escape email for onclick
                const safeEmail = client.email.replace(/'/g, "\\'");
                return `
                    <div class="activity-item" onclick="openClientPanelByEmail('${safeEmail}')" style="cursor: pointer;">
                        <div class="activity-text">
                            <div class="activity-name">${name}</div>
                            <div class="activity-detail">Homework ${progress}% complete</div>
                        </div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                `;
            }).join('');
        }

        // Helper function to get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days === 1) return 'Yesterday';
            return `${days}d ago`;
        }

        // Open client panel by email (for activity clicks)
        function openClientPanelByEmail(email) {
            const client = clients.find(c => c.email === email);
            if (client) {
                openClientPanel(client.id);
            }
        }

        function renderSection(gridId, countId, clientList, emptyIcon) {
            const grid = document.getElementById(gridId);
            const count = document.getElementById(countId);

            count.textContent = clientList.length;

            if (clientList.length === 0) {
                grid.innerHTML = `
                    <div class="section-empty">
                        <div class="section-empty-icon">${emptyIcon}</div>
                        <p>No clients in this section</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = clientList.map(client => createClientCard(client)).join('');
        }

        // Create Client Card HTML
        function createClientCard(client) {
            const name = client.full_name || client.name || 'Unknown';
            const email = client.email || '';
            const programmeType = client.programme_type || 'career';
            const status = client.programme_status || client.status || 'enrolled';
            const progress = calculateProgress(client);
            const homeworkProgress = client.homework_progress || 0;
            const hasRecentHomework = client.homework_updated && isRecent(client.homework_updated);

            const stageLabels = {
                'enrolled': 'Week 1',
                'session_1': 'Session 1',
                'session_2': 'Session 2',
                'session_3': 'Session 3',
                'session_4': 'Session 4',
                'week-1': 'Week 1',
                'week-2': 'Week 2',
                'week-3': 'Week 3',
                'week-4': 'Week 4',
                'complete': 'Complete',
                'completed': 'Complete'
            };

            const stageLabel = stageLabels[status] || status;
            const isComplete = status === 'completed' || status === 'complete';

            // Safely encode the client ID for use in onclick handlers
            // For strings, use single quotes inside onclick; for numbers, use as-is
            const safeId = typeof client.id === 'string'
                ? `'${client.id.replace(/'/g, "\\'")}'`
                : client.id;

            // Homework indicator
            const homeworkBadge = homeworkProgress > 0
                ? `<span class="homework-badge ${homeworkProgress >= 100 ? 'complete' : ''}" title="Homework ${homeworkProgress}% complete">
                     üìù ${homeworkProgress}%${hasRecentHomework ? ' üîî' : ''}
                   </span>`
                : '';

            return `
                <div class="client-card ${programmeType} ${hasRecentHomework ? 'has-activity' : ''}" onclick="openClientPanel(${safeId})">
                    <div class="card-header">
                        <div class="client-info">
                            <h3>
                                ${name}
                                <span class="programme-badge ${programmeType}">
                                    ${programmeType === 'audhd' ? 'üß† Spark' : programmeType === 'blended' ? '‚ú® Blended' : programmeType === 'all' ? 'üîë All' : 'üíº Career'}
                                </span>
                                ${homeworkBadge}
                            </h3>
                            <div class="client-email">${email}</div>
                        </div>
                        <span class="stage-badge ${isComplete ? 'complete' : ''}">${stageLabel}</span>
                    </div>

                    <div class="progress-section">
                        <div class="progress-label">
                            <span>Progress</span>
                            <span>${progress}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <div class="card-actions" onclick="event.stopPropagation()">
                        <button class="action-btn" onclick="openNotes(${safeId})">üìù Notes</button>
                        <button class="action-btn" onclick="openDocs(${safeId})">üìÅ Docs</button>
                        <button class="action-btn" onclick="openSchedule(${safeId})">üìÖ Schedule</button>
                        <button class="action-btn" onclick="editClient(${safeId})">‚úèÔ∏è Edit</button>
                    </div>
                </div>
            `;
        }

        // Check if a date is recent (within last 24 hours)
        function isRecent(dateStr) {
            if (!dateStr) return false;
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            return diff < 24 * 60 * 60 * 1000; // 24 hours
        }

        // Calculate Progress
        function calculateProgress(client) {
            const status = client.programme_status || client.status || 'enrolled';
            const progressMap = {
                'lead': 0,
                'enrolled': 10,
                'session_1': 25,
                'session_2': 50,
                'session_3': 75,
                'session_4': 90,
                'week-1': 25,
                'week-2': 50,
                'week-3': 75,
                'week-4': 90,
                'complete': 100,
                'completed': 100
            };
            return progressMap[status] || 10;
        }

        // Open Client Panel
        function openClientPanel(clientId) {
            // Use == for type-flexible comparison (API returns numbers, onclick passes strings)
            selectedClient = clients.find(c => c.id == clientId || String(c.id) === String(clientId));

            if (!selectedClient) {
                console.error('‚ùå Client not found for ID:', clientId, 'Available IDs:', clients.map(c => c.id));
                return;
            }
            console.log('‚úÖ Opening panel for:', selectedClient.full_name);

            document.getElementById('panelClientName').textContent = selectedClient.full_name || selectedClient.name;
            document.getElementById('panelClientEmail').textContent = selectedClient.email;

            // Update documents based on programme type
            const programmeType = selectedClient.programme_type || 'career';
            const panelDocs = document.getElementById('panelDocs');

            if (programmeType === 'audhd' || programmeType === 'nd') {
                // Spark/ND Coaching documents - only show what exists
                panelDocs.innerHTML = `
                    <div class="panel-item" onclick="openDoc('agreement')">
                        <div>
                            <div class="panel-item-title">üìÑ Coaching Agreement</div>
                            <div class="panel-item-meta">View signed agreement</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                    <div class="panel-item" onclick="openDoc('dashboard')">
                        <div>
                            <div class="panel-item-title">üìä Client Dashboard</div>
                            <div class="panel-item-meta">View session progress</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                `;
            } else {
                // Career Coaching documents
                // Get homework progress for this client
                const hwProgress = selectedClient.homework_progress || 0;
                const hwUpdated = selectedClient.homework_updated
                    ? new Date(selectedClient.homework_updated).toLocaleDateString('en-GB')
                    : 'Not started';

                panelDocs.innerHTML = `
                    <div class="panel-item" onclick="openDoc('questionnaire')">
                        <div>
                            <div class="panel-item-title">üìù Questionnaire Responses</div>
                            <div class="panel-item-meta">View/edit responses</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                    <div class="panel-item" onclick="openDoc('homework')" style="background: ${hwProgress > 0 ? '#FFFBEB' : ''}; border-left: 3px solid ${hwProgress > 0 ? '#F59E0B' : 'transparent'};">
                        <div>
                            <div class="panel-item-title">üìã Week 2 Homework ${hwProgress > 0 ? '<span style="font-size: 0.8em; background: #DBEAFE; color: #1D4ED8; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">' + hwProgress + '%</span>' : ''}</div>
                            <div class="panel-item-meta">${hwProgress > 0 ? 'Last updated: ' + hwUpdated : 'Not started yet'}</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                    <div class="panel-item" onclick="openDoc('insights')">
                        <div>
                            <div class="panel-item-title">üí° Insights Report</div>
                            <div class="panel-item-meta">Career insights editor</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                    <div class="panel-item" onclick="openDoc('blueprint')">
                        <div>
                            <div class="panel-item-title">üéØ Career Blueprint</div>
                            <div class="panel-item-meta">View blueprint</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                    <div class="panel-item" onclick="openDoc('cv-builder')">
                        <div>
                            <div class="panel-item-title">üìÑ CV Builder</div>
                            <div class="panel-item-meta">Interactive CV</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                    <div class="panel-item" onclick="openDoc('decision')">
                        <div>
                            <div class="panel-item-title">‚öñÔ∏è Decision Framework</div>
                            <div class="panel-item-meta">Opportunity scoring</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                    <div class="panel-item" onclick="openDoc('mapping')">
                        <div>
                            <div class="panel-item-title">üó∫Ô∏è Mapping Guide</div>
                            <div class="panel-item-meta">CV & LinkedIn mapping</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                    <div class="panel-item" onclick="openDoc('agreement')">
                        <div>
                            <div class="panel-item-title">üìã Coaching Agreement</div>
                            <div class="panel-item-meta">View signed agreement</div>
                        </div>
                        <span>‚Üí</span>
                    </div>
                `;
            }

            document.getElementById('panelOverlay').classList.add('active');
            document.getElementById('slidePanel').classList.add('active');
        }

        // Close Panel
        function closePanel() {
            document.getElementById('panelOverlay').classList.remove('active');
            document.getElementById('slidePanel').classList.remove('active');
            selectedClient = null;
        }

        // Open Full Profile
        function openFullProfile() {
            if (selectedClient) {
                // Navigate to client profile page
                window.open(`client-profile.html?id=${selectedClient.id}`, '_blank');
            }
        }

        // Document Actions
        function openDoc(type) {
            if (!selectedClient) return;

            const folder = selectedClient.full_name?.replace(/\s+/g, '_') || 'Unknown';
            const programmeType = selectedClient.programme_type || 'career';
            const clientId = selectedClient.id;

            // Document types that can be uploaded to PostgreSQL
            const uploadableTypes = ['agreement', 'notes', 'blueprint', 'cv', 'decision', 'mapping'];

            // Map menu type to PostgreSQL document_type
            const typeMapping = {
                'agreement': 'agreement',
                'notes': 'notes',
                'blueprint': 'blueprint',
                'cv-builder': 'cv',
                'decision': 'decision',
                'mapping': 'mapping'
            };

            let docs = {};

            // Check if this is a demo client (use static files instead of API-driven editors)
            const isDemo = selectedClient.is_demo === true;

            if (programmeType === 'audhd' || programmeType === 'nd') {
                // Spark/ND documents - use correct filename pattern
                docs = {
                    'agreement': `${folder}/${folder}_Spark_Coaching_Agreement.html`,
                    'dashboard': `audhd-dashboard.html`
                };
            } else {
                // Career documents - all standard naming conventions
                // Demo clients use static files; real clients use API editors
                docs = {
                    'questionnaire': isDemo
                        ? `${folder}/${folder}_Questionnaire_Responses.html`
                        : `questionnaire-editor.html?client_id=${clientId}`,
                    'insights': isDemo
                        ? `${folder}/${folder}_Career_Insights_Report.html`
                        : `insights-editor.html?client_id=${clientId}`,
                    'homework': `${folder}/${folder}_Week2_Homework.html`,
                    'blueprint': `${folder}/${folder}_Career_Blueprint.html`,
                    'cv-builder': `${folder}/${folder}_Interactive_CV_Builder.html`,
                    'decision': `${folder}/${folder}_Decision_Framework.html`,
                    'mapping': `${folder}/${folder}_Mapping_Guide.html`,
                    'agreement': `${folder}/${folder}_Coaching_Agreement.html`
                };
            }

            // For uploadable types, use document-viewer to check PostgreSQL first
            if (typeMapping[type] && docs[type]) {
                const pgType = typeMapping[type];
                const fallback = encodeURIComponent(docs[type]);
                window.open(`document-viewer.html?client_id=${clientId}&type=${pgType}&fallback=${fallback}`, '_blank');
            } else if (docs[type]) {
                window.open(docs[type], '_blank');
            } else {
                alert(`Document "${type}" not yet available for ${selectedClient.full_name}`);
            }
        }

        function openNotes(clientId) {
            const client = clients.find(c => c.id == clientId) || selectedClient;
            if (!client) return;

            selectedClient = client;
            document.getElementById('notesClientName').textContent = client.full_name || client.name;

            // Load saved notes from localStorage
            const savedNotes = localStorage.getItem(`coach_notes_${clientId}`);
            if (savedNotes) {
                const notes = JSON.parse(savedNotes);
                document.getElementById('clientNotes').value = notes.notes || '';
                document.getElementById('clientInsights').value = notes.insights || '';
                document.getElementById('clientNextSteps').value = notes.nextSteps || '';
            } else {
                document.getElementById('clientNotes').value = '';
                document.getElementById('clientInsights').value = '';
                document.getElementById('clientNextSteps').value = '';
            }

            document.getElementById('notesModal').classList.add('active');
        }

        function closeNotesModal() {
            document.getElementById('notesModal').classList.remove('active');
        }

        async function saveClientNotes() {
            if (!selectedClient) return;

            const notesText = document.getElementById('clientNotes').value;
            const insightsText = document.getElementById('clientInsights').value;
            const nextStepsText = document.getElementById('clientNextSteps').value;

            const notes = {
                notes: notesText,
                insights: insightsText,
                nextSteps: nextStepsText,
                updatedAt: new Date().toISOString()
            };

            // Save to localStorage as backup
            localStorage.setItem(`coach_notes_${selectedClient.id}`, JSON.stringify(notes));

            // Also save to PostgreSQL if client has API ID
            if (selectedClient.api_id || selectedClient.id) {
                try {
                    const clientId = selectedClient.api_id || selectedClient.id;
                    // Combine notes into single coach_notes field for API
                    const combinedNotes = `NOTES:\n${notesText}\n\nINSIGHTS:\n${insightsText}\n\nNEXT STEPS:\n${nextStepsText}`;

                    const response = await fetch(`${API_BASE}/api/crm/syp/clients/${clientId}/`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Token ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            coach_notes: combinedNotes
                        })
                    });

                    if (response.ok) {
                        console.log('‚úÖ Notes saved to PostgreSQL');
                    } else {
                        console.log('API save failed, notes saved locally');
                    }
                } catch (error) {
                    console.log('API unavailable, notes saved locally');
                }
            }

            closeNotesModal();
            alert('‚úÖ Notes saved for ' + (selectedClient.full_name || selectedClient.name));
        }

        function openDocs(clientId) {
            const client = clients.find(c => c.id == clientId);
            if (client) {
                openClientPanel(clientId);
            }
        }

        function openSchedule(clientId) {
            const client = clients.find(c => c.id == clientId) || selectedClient;
            if (!client) return;

            selectedClient = client;

            // Open schedule modal with client pre-selected
            const select = document.getElementById('sessionClient');
            select.value = clientId;

            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('sessionDate').value = tomorrow.toISOString().split('T')[0];

            document.getElementById('scheduleModal').classList.add('active');
        }

        function editClient(clientId) {
            const client = clients.find(c => c.id == clientId);
            if (!client) {
                console.error('Client not found:', clientId);
                return;
            }

            selectedClient = client;

            // Populate form - use programme_status (the correct field)
            document.getElementById('editClientId').value = client.id;
            document.getElementById('editClientName').value = client.full_name || client.name || '';
            document.getElementById('editClientEmail').value = client.email || '';
            document.getElementById('editClientProgramme').value = client.programme_type || 'career';
            document.getElementById('editClientStage').value = client.programme_status || client.status || 'discovery';

            document.getElementById('editClientModal').classList.add('active');
        }

        function closeEditClientModal() {
            document.getElementById('editClientModal').classList.remove('active');
        }

        async function saveEditedClient() {
            const clientId = document.getElementById('editClientId').value;
            const name = document.getElementById('editClientName').value.trim();
            const email = document.getElementById('editClientEmail').value.trim();
            const programme = document.getElementById('editClientProgramme').value;
            const stage = document.getElementById('editClientStage').value;

            if (!name || !email) {
                alert('Please fill in name and email');
                return;
            }

            // Get original email for API lookup (in case email changed)
            const originalEmail = selectedClient?.email || email;

            // Update locally
            const clientIndex = clients.findIndex(c => c.id == clientId || c.email === originalEmail);
            if (clientIndex > -1) {
                clients[clientIndex].full_name = name;
                clients[clientIndex].name = name;
                clients[clientIndex].email = email;
                clients[clientIndex].programme_type = programme;
                clients[clientIndex].programme_status = stage;
                clients[clientIndex].status = stage;
            }

            let saved = false;

            // Try SYP Express API first (uses email)
            try {
                console.log('üì° Saving to SYP API...');
                const sypResponse = await fetch(`${SYP_API}/api/clients/${encodeURIComponent(originalEmail)}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        full_name: name,
                        email: email,
                        programme_type: programme,
                        programme_status: stage
                    })
                });

                if (sypResponse.ok) {
                    console.log('‚úÖ Saved to SYP PostgreSQL');
                    saved = true;
                }
            } catch (error) {
                console.log('SYP API unavailable');
            }

            // Also try SparkHub API (uses numeric ID)
            if (!saved) {
                try {
                    console.log('üì° Trying SparkHub API...');
                    const response = await fetch(`${SPARKHUB_API}/api/crm/syp/clients/${clientId}/`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Token ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            full_name: name,
                            email: email,
                            programme_type: programme,
                            programme_status: stage
                        })
                    });

                    if (response.ok) {
                        console.log('‚úÖ Saved to SparkHub PostgreSQL');
                        saved = true;
                    }
                } catch (error) {
                    console.log('SparkHub API unavailable');
                }
            }

            closeEditClientModal();
            renderClients();

            if (saved) {
                alert('‚úÖ Client updated and saved to database!');
            } else {
                alert('‚ö†Ô∏è Client updated locally (database unavailable)');
            }
        }

        // Add Client Modal
        function openAddClientModal() {
            document.getElementById('addClientModal').classList.add('active');
        }

        function closeAddClientModal() {
            document.getElementById('addClientModal').classList.remove('active');
            document.getElementById('newClientName').value = '';
            document.getElementById('newClientEmail').value = '';
        }

        async function saveNewClient() {
            const name = document.getElementById('newClientName').value.trim();
            const email = document.getElementById('newClientEmail').value.trim();
            const programme = document.getElementById('newClientProgramme').value;

            if (!name || !email) {
                alert('Please fill in all fields');
                return;
            }

            // Generate a temporary password for the new client
            const tempPassword = 'Spark' + Math.random().toString(36).substring(2, 8) + '!';

            try {
                // Use SYP Express API (not SparkHub Django)
                const response = await fetch('/api/admin/create-client', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        name: name,
                        password: tempPassword,
                        programmeAccess: programme,
                        adminKey: 'spark-admin-2025'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    closeAddClientModal();
                    await loadClients();
                    // Show the temporary password so coach can share with client
                    alert(`‚úÖ Client created successfully!\n\nEmail: ${email}\nTemporary Password: ${tempPassword}\n\nPlease share these credentials with the client.`);
                } else {
                    alert('Error: ' + (result.error || 'Failed to add client'));
                }
            } catch (error) {
                console.error('Add client error:', error);
                alert('Connection error. Please try again.');
            }
        }

        // ========== UPLOAD FUNCTIONALITY ==========

        let uploadedFiles = [];

        function openUploadModal() {
            if (!selectedClient) {
                alert('Please select a client first');
                return;
            }

            // Reset modal state
            uploadedFiles = [];
            document.getElementById('uploadFileList').innerHTML = '';
            document.getElementById('uploadProgress').classList.remove('active');
            document.getElementById('uploadSuccess').classList.remove('active');
            document.getElementById('uploadSubmitBtn').disabled = true;
            document.getElementById('uploadClientName').textContent = selectedClient.full_name || 'Client';

            // Set appropriate document type based on programme
            const docTypeSelect = document.getElementById('uploadDocType');
            if (selectedClient.programme_type === 'audhd' || selectedClient.programme_type === 'nd') {
                docTypeSelect.innerHTML = `
                    <option value="agreement">üìã Coaching Agreement</option>
                    <option value="notes">üìù Session Notes</option>
                    <option value="other">üìÅ Other Document</option>
                `;
            } else {
                docTypeSelect.innerHTML = `
                    <option value="agreement">üìã Coaching Agreement</option>
                    <option value="notes">üìù Session Notes</option>
                    <option value="blueprint">üéØ Career Blueprint</option>
                    <option value="cv">üìÑ CV / Resume</option>
                    <option value="decision">‚öñÔ∏è Decision Framework</option>
                    <option value="mapping">üó∫Ô∏è Mapping Guide</option>
                    <option value="other">üìÅ Other Document</option>
                `;
            }

            document.getElementById('uploadModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            uploadedFiles = [];
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                addFileToList(files[i]);
            }
            event.target.value = ''; // Reset input
        }

        function addFileToList(file) {
            // Check file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                return;
            }

            // Check for duplicates
            if (uploadedFiles.some(f => f.name === file.name)) {
                alert(`File "${file.name}" is already added.`);
                return;
            }

            uploadedFiles.push(file);
            renderFileList();
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            renderFileList();
        }

        function renderFileList() {
            const listEl = document.getElementById('uploadFileList');

            if (uploadedFiles.length === 0) {
                listEl.innerHTML = '';
                document.getElementById('uploadSubmitBtn').disabled = true;
                return;
            }

            listEl.innerHTML = uploadedFiles.map((file, index) => `
                <div class="upload-file-item">
                    <div class="upload-file-name">
                        <span>${getFileIcon(file.name)}</span>
                        <span>${file.name}</span>
                        <small style="color: var(--text-muted);">(${formatFileSize(file.size)})</small>
                    </div>
                    <button class="upload-file-remove" onclick="removeFile(${index})">√ó</button>
                </div>
            `).join('');

            document.getElementById('uploadSubmitBtn').disabled = false;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'üìï',
                'doc': 'üìÑ',
                'docx': 'üìÑ',
                'html': 'üåê',
                'htm': 'üåê',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è',
                'png': 'üñºÔ∏è',
                'gif': 'üñºÔ∏è'
            };
            return icons[ext] || 'üìÅ';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function submitUpload() {
            if (uploadedFiles.length === 0 || !selectedClient) return;

            const docType = document.getElementById('uploadDocType').value;
            const folder = selectedClient.full_name?.replace(/\s+/g, '_') || 'Unknown';

            // Show progress
            document.getElementById('uploadProgress').classList.add('active');
            document.getElementById('uploadSubmitBtn').disabled = true;

            let progressFill = document.getElementById('uploadProgressFill');
            progressFill.style.width = '0%';

            try {
                // Document type labels for filenames
                const docTypeLabels = {
                    'agreement': 'Coaching_Agreement',
                    'notes': 'Session_Notes',
                    'blueprint': 'Blueprint',
                    'cv': 'Interactive_CV_Builder',
                    'decision': 'Decision_Framework',
                    'mapping': 'Mapping_Guide',
                    'questionnaire': 'Questionnaire_Responses',
                    'other': 'Document'
                };

                const expectedFilename = `${folder}_${docTypeLabels[docType]}`;
                let uploadedCount = 0;

                for (const file of uploadedFiles) {
                    // Read file content for small files (HTML, text)
                    let fileContent = '';
                    if (file.size < 500000 && (file.name.endsWith('.html') || file.name.endsWith('.txt'))) {
                        fileContent = await readFileAsText(file);
                    }

                    // Upload to PostgreSQL API
                    try {
                        const response = await fetch(`${API_BASE}/api/crm/syp/coach/client-documents/`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Token ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                client_id: selectedClient.id,
                                document_type: docType,
                                original_filename: file.name,
                                stored_filename: `${expectedFilename}.${file.name.split('.').pop()}`,
                                file_path: `${folder}/${expectedFilename}.${file.name.split('.').pop()}`,
                                file_size: file.size,
                                mime_type: file.type || 'application/octet-stream',
                                file_content: fileContent,
                                description: `Uploaded via Coach Hub on ${new Date().toLocaleDateString('en-GB')}`
                            })
                        });

                        if (response.ok) {
                            uploadedCount++;
                            console.log('‚úÖ Document saved to PostgreSQL:', file.name);
                        } else {
                            console.error('‚ùå Failed to save to PostgreSQL:', await response.text());
                        }
                    } catch (apiError) {
                        console.error('API error:', apiError);
                    }

                    // Update progress
                    progressFill.style.width = `${(uploadedCount / uploadedFiles.length) * 100}%`;
                }

                // Also create local download for the file
                uploadedFiles.forEach(file => {
                    // Store file info in localStorage for reference
                    const uploads = JSON.parse(localStorage.getItem('syp_uploads') || '[]');
                    uploads.push({
                        clientId: selectedClient.id,
                        clientName: selectedClient.full_name,
                        folder: folder,
                        docType: docType,
                        originalName: file.name,
                        expectedPath: `${folder}/${expectedFilename}.${file.name.split('.').pop()}`,
                        uploadedAt: new Date().toISOString(),
                        savedToPostgres: true
                    });
                    localStorage.setItem('syp_uploads', JSON.stringify(uploads));

                    // Create a download link so user can save the file locally too
                    const url = URL.createObjectURL(file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${expectedFilename}.${file.name.split('.').pop()}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });

                // Show success
                document.getElementById('uploadProgress').classList.remove('active');
                document.getElementById('uploadSuccess').classList.add('active');
                document.getElementById('uploadSuccessMessage').innerHTML = `
                    ‚úÖ Saved to PostgreSQL!<br>
                    <small>Also downloaded for local backup</small>
                `;

                // Close modal after delay
                setTimeout(() => {
                    closeUploadModal();
                }, 3000);

            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed. Please try again.');
                document.getElementById('uploadProgress').classList.remove('active');
                document.getElementById('uploadSubmitBtn').disabled = false;
            }
        }

        // Helper to read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file);
            });
        }

        // Drag and drop support
        const dropzone = document.getElementById('uploadDropzone');
        if (dropzone) {
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                for (let i = 0; i < files.length; i++) {
                    addFileToList(files[i]);
                }
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePanel();
                closeAddClientModal();
                closeUploadModal();
                closeScheduleModal();
            }
        });

        // ========== CALENDAR FUNCTIONALITY ==========

        let currentWeekStart = getMonday(new Date());
        let scheduledSessions = JSON.parse(localStorage.getItem('syp_sessions') || '[]');

        function getMonday(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        }

        function formatDateKey(date) {
            return date.toISOString().split('T')[0];
        }

        function renderCalendar() {
            const weekGrid = document.getElementById('weekGrid');
            const weekLabel = document.getElementById('weekLabel');

            // Calculate week range
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            weekLabel.textContent = `${currentWeekStart.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })} - ${weekEnd.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;

            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = '';

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentWeekStart);
                dayDate.setDate(dayDate.getDate() + i);
                const dateKey = formatDateKey(dayDate);
                const isToday = dayDate.getTime() === today.getTime();

                // Get sessions for this day
                const daySessions = scheduledSessions.filter(s => s.date === dateKey);

                html += `
                    <div class="day-column">
                        <div class="day-header ${isToday ? 'today' : ''}">
                            <div class="day-name">${days[i]}</div>
                            <div class="day-date">${dayDate.getDate()}</div>
                        </div>
                        <div class="day-slots">
                            ${daySessions.map(session => `
                                <div class="calendar-event ${session.programmeType || 'career'}" onclick="viewSession('${session.id}')">
                                    <div class="event-time">${session.time}</div>
                                    <div class="event-client">${session.clientName}</div>
                                    <div class="event-type">${getSessionTypeLabel(session.type)}</div>
                                </div>
                            `).join('')}
                            <button class="add-session-btn" onclick="quickAddSession('${dateKey}')">+ Add</button>
                        </div>
                    </div>
                `;
            }

            weekGrid.innerHTML = html;
        }

        function getSessionTypeLabel(type) {
            const labels = {
                'coaching': 'üíº Coaching',
                'discovery': 'üîç Discovery',
                'review': 'üìã Review'
            };
            return labels[type] || type;
        }

        function prevWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            renderCalendar();
        }

        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            renderCalendar();
        }

        function goToToday() {
            currentWeekStart = getMonday(new Date());
            renderCalendar();
        }

        // Schedule Modal Functions
        function openScheduleModal(presetDate) {
            // Populate client dropdown
            const select = document.getElementById('sessionClient');
            select.innerHTML = '<option value="">Select a client...</option>';
            clients.forEach(c => {
                select.innerHTML += `<option value="${c.id}" data-type="${c.programme_type || 'career'}">${c.full_name || c.name}</option>`;
            });

            // Set date if provided
            if (presetDate) {
                document.getElementById('sessionDate').value = presetDate;
            } else {
                document.getElementById('sessionDate').value = formatDateKey(new Date());
            }

            document.getElementById('scheduleModal').classList.add('active');
        }

        function closeScheduleModal() {
            document.getElementById('scheduleModal').classList.remove('active');
            // Reset form
            document.getElementById('sessionClient').value = '';
            document.getElementById('sessionTime').value = '10:00';
            document.getElementById('sessionNotes').value = '';
        }

        function quickAddSession(dateKey) {
            openScheduleModal(dateKey);
        }

        function saveSession() {
            const clientId = document.getElementById('sessionClient').value;
            const clientSelect = document.getElementById('sessionClient');
            const selectedOption = clientSelect.options[clientSelect.selectedIndex];
            const clientName = selectedOption.text;
            const programmeType = selectedOption.dataset.type || 'career';
            const date = document.getElementById('sessionDate').value;
            const time = document.getElementById('sessionTime').value;
            const duration = document.getElementById('sessionDuration').value;
            const type = document.getElementById('sessionType').value;
            const notes = document.getElementById('sessionNotes').value;

            if (!clientId || !date) {
                alert('Please select a client and date');
                return;
            }

            const session = {
                id: 'session_' + Date.now(),
                clientId,
                clientName,
                programmeType,
                date,
                time,
                duration,
                type,
                notes,
                createdAt: new Date().toISOString()
            };

            scheduledSessions.push(session);
            localStorage.setItem('syp_sessions', JSON.stringify(scheduledSessions));

            closeScheduleModal();
            renderCalendar();
            updateTodaySessions();
        }

        function viewSession(sessionId) {
            const session = scheduledSessions.find(s => s.id === sessionId);
            if (session) {
                const action = confirm(
                    `üìÖ ${session.clientName}\n` +
                    `${session.date} at ${session.time}\n` +
                    `${getSessionTypeLabel(session.type)}\n` +
                    `${session.notes ? 'Notes: ' + session.notes : ''}\n\n` +
                    `Click OK to delete this session, Cancel to close.`
                );

                if (action) {
                    scheduledSessions = scheduledSessions.filter(s => s.id !== sessionId);
                    localStorage.setItem('syp_sessions', JSON.stringify(scheduledSessions));
                    renderCalendar();
                    updateTodaySessions();
                }
            }
        }

        function updateTodaySessions() {
            const todayKey = formatDateKey(new Date());
            const todaySessions = scheduledSessions.filter(s => s.date === todayKey);

            const container = document.getElementById('todaySessions');

            if (todaySessions.length === 0) {
                container.innerHTML = '<div class="empty-state">No sessions scheduled today</div>';
            } else {
                container.innerHTML = todaySessions.map(s => `
                    <div class="today-item">
                        <span>${s.clientName}</span>
                        <span class="today-time">${s.time}</span>
                    </div>
                `).join('');
            }
        }

        // ========== GOOGLE CALENDAR INTEGRATION ==========

        let googleCalendarId = localStorage.getItem('syp_google_calendar_id') || null;
        let calendarViewMode = localStorage.getItem('syp_calendar_view') || 'google';

        function initGoogleCalendar() {
            if (googleCalendarId) {
                embedGoogleCalendar(googleCalendarId);
            }
            updateCalendarViewToggle();
        }

        function connectGoogleCalendar() {
            const calId = prompt(
                "Enter your Google Calendar ID to embed your schedule.\n\n" +
                "To find your Calendar ID:\n" +
                "1. Open Google Calendar\n" +
                "2. Click the 3 dots next to your calendar ‚Üí Settings\n" +
                "3. Scroll to 'Integrate calendar'\n" +
                "4. Copy the Calendar ID (looks like: email@gmail.com or a long string)\n\n" +
                "Or enter your Gmail address if you want your primary calendar:",
                googleCalendarId || ''
            );

            if (calId && calId.trim()) {
                googleCalendarId = calId.trim();
                localStorage.setItem('syp_google_calendar_id', googleCalendarId);
                embedGoogleCalendar(googleCalendarId);
            }
        }

        function embedGoogleCalendar(calId) {
            // Make calendar public embed URL
            const embedUrl = `https://calendar.google.com/calendar/embed?src=${encodeURIComponent(calId)}&ctz=Europe%2FLondon&mode=WEEK&showTitle=0&showNav=1&showDate=1&showPrint=0&showTabs=0&showCalendars=0&showTz=0&bgcolor=%23FFFFFF`;

            document.getElementById('googleCalendarEmbed').innerHTML = `
                <iframe
                    src="${embedUrl}"
                    style="border: 0; width: 100%; height: 500px; border-radius: 12px;"
                    frameborder="0"
                    scrolling="no">
                </iframe>
                <p style="text-align: center; margin-top: 10px; font-size: 0.85em; color: var(--text-muted);">
                    ‚úÖ Connected to Google Calendar ‚Ä¢
                    <a href="#" onclick="disconnectGoogleCalendar(); return false;" style="color: var(--purple-main);">Disconnect</a>
                </p>
            `;
        }

        function disconnectGoogleCalendar() {
            if (confirm('Disconnect Google Calendar?')) {
                googleCalendarId = null;
                localStorage.removeItem('syp_google_calendar_id');
                document.getElementById('googleCalendarEmbed').innerHTML = `
                    <p style="text-align: center; padding: 40px; color: var(--text-muted);">
                        Click "Connect Google Calendar" to embed your calendar here.
                    </p>
                `;
            }
        }

        function openGoogleCalendar() {
            if (googleCalendarId) {
                window.open(`https://calendar.google.com/calendar/r?cid=${encodeURIComponent(googleCalendarId)}`, '_blank');
            } else {
                window.open('https://calendar.google.com', '_blank');
            }
        }

        function toggleCalendarView() {
            const googleView = document.getElementById('googleCalendarView');
            const manualView = document.getElementById('manualCalendarView');
            const toggle = document.getElementById('calendarViewToggle');
            const label = document.getElementById('calendarViewLabel');

            if (calendarViewMode === 'google') {
                calendarViewMode = 'manual';
                googleView.style.display = 'none';
                manualView.style.display = 'block';
                toggle.textContent = 'üìÜ';
                label.textContent = 'Manual Schedule';
                renderCalendar();
            } else {
                calendarViewMode = 'google';
                googleView.style.display = 'block';
                manualView.style.display = 'none';
                toggle.textContent = 'üìã';
                label.textContent = 'Google Calendar';
            }

            localStorage.setItem('syp_calendar_view', calendarViewMode);
        }

        function updateCalendarViewToggle() {
            if (calendarViewMode === 'manual') {
                toggleCalendarView(); // Switch to manual view
                toggleCalendarView(); // This will set it back to manual correctly
            }
        }

        function exportCalendar() {
            // Generate ICS file
            let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Spark Your Potential//Coach Hub//EN\n';

            scheduledSessions.forEach(session => {
                const startDate = session.date.replace(/-/g, '');
                const startTime = session.time.replace(':', '') + '00';
                const endHour = parseInt(session.time.split(':')[0]) + Math.floor(parseInt(session.duration) / 60);
                const endMin = parseInt(session.time.split(':')[1]) + (parseInt(session.duration) % 60);
                const endTime = String(endHour).padStart(2, '0') + String(endMin).padStart(2, '0') + '00';

                ics += `BEGIN:VEVENT
DTSTART:${startDate}T${startTime}
DTEND:${startDate}T${endTime}
SUMMARY:${getSessionTypeLabel(session.type)} - ${session.clientName}
DESCRIPTION:${session.notes || 'Coaching session'}
END:VEVENT
`;
            });

            ics += 'END:VCALENDAR';

            const blob = new Blob([ics], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'syp-schedule.ics';
            a.click();
        }

        // Initialise calendar on dashboard load
        const originalShowDashboard = showDashboard;
        showDashboard = async function() {
            await originalShowDashboard();
            initGoogleCalendar();
            renderCalendar();
            updateTodaySessions();
        };
    </script>
</body>
</html>
