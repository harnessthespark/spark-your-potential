<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Spark Your Potential</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 40px;
            color: #333;
        }
        .container { max-width: 1000px; margin: 0 auto; }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        .header h1 {
            font-size: 2.5em;
            font-weight: 800;
            margin-bottom: 10px;
        }
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
        }
        .user-name {
            font-size: 1.3em;
            color: #FFB627;
            margin-top: 15px;
            font-weight: 600;
        }

        /* User Menu */
        .user-menu {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-email {
            color: white;
            opacity: 0.8;
            font-size: 0.9em;
        }
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Login Section */
        .login-section {
            background: white;
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .login-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        .login-section p {
            color: #666;
            margin-bottom: 25px;
        }
        .email-input {
            width: 100%;
            max-width: 400px;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 15px;
        }
        .email-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* Dashboard Content */
        .dashboard-content { display: none; }
        .dashboard-content.visible { display: block; }

        /* Tool Cards Grid */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .tool-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }

        .tool-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        .tool-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .tool-description {
            color: #666;
            font-size: 0.95em;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        .tool-status {
            font-size: 0.85em;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 15px;
        }
        .status-complete {
            background: #e5ffe5;
            color: #4CAF50;
        }
        .status-pending {
            background: #fff3e0;
            color: #FF9800;
        }
        .status-locked {
            background: #f5f5f5;
            color: #999;
        }

        .tool-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .tool-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #f0f0f0;
            color: #555;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .btn-disabled {
            background: #e0e0e0;
            color: #999;
            cursor: not-allowed;
        }

        /* Quick Stats */
        .stats-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px 30px;
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            color: white;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #FFB627;
        }
        .stat-label {
            font-size: 0.85em;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* Footer */
        .footer {
            text-align: center;
            color: white;
            opacity: 0.6;
            margin-top: 40px;
            font-size: 0.9em;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body { padding: 20px; }
            .header h1 { font-size: 1.8em; }
            .stats-bar { flex-direction: column; gap: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- User Menu (shown when logged in) -->
        <div class="user-menu" id="userMenu" style="display: none;">
            <a href="index.html" class="logout-btn" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);">‚Üê Home</a>
            <a href="audhd-dashboard.html" class="logout-btn" style="background: linear-gradient(135deg, #8B5CF6 0%, #EC4899 100%); border: none;">üß† ND Portal</a>
            <a href="book.html" class="logout-btn" style="background: linear-gradient(135deg, #E63946 0%, #D81B60 100%); border: none;">‚ö° Book</a>
            <span class="user-email" id="userEmail"></span>
            <button class="logout-btn" onclick="logout()">Log out</button>
        </div>

        <div class="header">
            <img src="White.png" alt="Harness the Spark" style="height: 60px; margin-bottom: 20px;">
            <h1>‚ö° Your Career Toolkit</h1>
            <div class="subtitle">Spark Your Potential</div>
            <div class="user-name" id="userName"></div>
        </div>

        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <h2>Welcome Back</h2>
            <p>Enter your credentials to access your career toolkit</p>
            <form onsubmit="login(); return false;" autocomplete="on">
                <input type="text" name="username" class="email-input" id="emailInput" placeholder="Username" autocomplete="username">
                <br>
                <input type="password" name="password" class="email-input" id="passwordInput" placeholder="Password" style="margin-top: 10px;" autocomplete="current-password">
                <br>
                <button type="submit" class="login-btn">Login</button>
            </form>
            <p id="loginError" style="color: #e74c3c; margin-top: 15px; display: none;"></p>
            <div style="margin-top: 30px; padding-top: 30px; border-top: 1px solid #e0e0e0;">
                <p style="color: #888; margin-bottom: 15px;">Want to see how it works first?</p>
                <button type="button" class="login-btn" style="background: linear-gradient(135deg, #FF6B35 0%, #FFB627 100%);" onclick="loadDemo()">
                    Try Demo
                </button>
            </div>
        </div>

        <!-- Coach Mode - Client Management (visible only to Lisa) -->
        <div class="coach-mode" id="coachMode" style="display: none;">
            <div style="background: linear-gradient(135deg, #FF6B35 0%, #FFB627 100%); color: white; border-radius: 15px; padding: 30px; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <h2 style="font-size: 1.8em; margin-bottom: 5px;">üî• Coach Mode</h2>
                        <p style="opacity: 0.9;">Manage all your coaching clients</p>
                        <div id="dataSourceIndicator" style="margin-top: 8px; font-size: 0.85em; padding: 4px 10px; background: rgba(255,255,255,0.2); border-radius: 12px; display: inline-block;">
                            <span id="dataSourceIcon">üì¶</span> <span id="dataSourceText">Loading...</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button onclick="refreshClients()" style="background: rgba(255,255,255,0.3); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 0.9em;" title="Refresh from database">
                            üîÑ Refresh
                        </button>
                        <button onclick="addNewClient()" style="background: white; color: #FF6B35; border: none; padding: 12px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
                            + Add Career Client
                        </button>
                        <button onclick="addAuDHDClient()" style="background: white; color: #8B5CF6; border: none; padding: 12px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
                            + Add ND Client
                        </button>
                    </div>
                </div>

                <!-- Programme Filter -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button onclick="filterClients('all')" id="filterAll" class="filter-btn active" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid rgba(255,255,255,0.5); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85em;">
                        All Clients
                    </button>
                    <button onclick="filterClients('career')" id="filterCareer" class="filter-btn" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85em;">
                        ‚ö° Career Booster
                    </button>
                    <button onclick="filterClients('audhd')" id="filterAudhd" class="filter-btn" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85em;">
                        üß† ND Coaching
                    </button>
                </div>

                <!-- Client List -->
                <div id="clientList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Client cards will be populated here -->
                </div>

                <!-- Admin Tools Toggle -->
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="toggleAdminTools()" id="adminToolsToggle" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 0.9em;">
                        üîê Admin Tools ‚ñº
                    </button>
                </div>

                <!-- Admin Tools Panel (hidden by default) -->
                <div id="adminToolsPanel" style="display: none; margin-top: 20px; background: rgba(255,255,255,0.95); border-radius: 12px; padding: 25px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">

                        <!-- Create Client Account -->
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">‚ûï Create Client Account</h4>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 0.85em; color: #555; margin-bottom: 5px;">Client Name</label>
                                <input type="text" id="adminClientName" placeholder="e.g., John Smith" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 0.85em; color: #555; margin-bottom: 5px;">Client Email</label>
                                <input type="email" id="adminClientEmail" placeholder="client@email.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 0.85em; color: #555; margin-bottom: 5px;">Password (leave blank to auto-generate)</label>
                                <input type="text" id="adminClientPassword" placeholder="Create a password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-size: 0.85em; color: #555; margin-bottom: 5px;">Programme Access</label>
                                <select id="adminProgrammeAccess" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em; background: white;">
                                    <option value="career">üíº Career Booster Only</option>
                                    <option value="audhd">üß† ND Coaching Only</option>
                                    <option value="both">‚ú® Both Programmes</option>
                                    <option value="testimonial">üéÅ Testimonial Access (Self-Service)</option>
                                </select>
                            </div>
                            <button onclick="createClientAccount()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
                                Create Account
                            </button>
                            <div id="createAccountMessage" style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none;"></div>
                        </div>

                        <!-- Reset Password -->
                        <div style="background: #f8f9fa; border-radius: 10px; padding: 20px;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">üîÑ Reset Client Password</h4>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 0.85em; color: #555; margin-bottom: 5px;">Client Email</label>
                                <input type="email" id="resetClientEmail" placeholder="client@email.com" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; font-size: 0.85em; color: #555; margin-bottom: 5px;">New Password (leave blank to auto-generate)</label>
                                <input type="text" id="resetClientPassword" placeholder="New password" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em;">
                            </div>
                            <button onclick="resetClientPassword()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%;">
                                Reset Password
                            </button>
                            <div id="resetPasswordMessage" style="margin-top: 10px; padding: 10px; border-radius: 6px; display: none;"></div>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Journey View (shown when client selected) -->
            <div id="journeyView" style="display: none; background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                    <div>
                        <h3 id="journeyClientName" style="color: #667eea; font-size: 1.5em;"></h3>
                        <p id="journeyClientStatus" style="color: #666;"></p>
                    </div>
                    <button onclick="closeJourneyView()" style="background: #f0f0f0; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‚Üê Back</button>
                </div>

                <!-- 4-Week Journey Timeline -->
                <div id="journeyTimeline" style="display: flex; gap: 10px; justify-content: space-between; margin-bottom: 30px;">
                    <!-- Week cards will be populated here -->
                </div>

                <!-- Week Actions -->
                <div id="weekActions" style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <!-- Actions for current week -->
                </div>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div class="dashboard-content" id="dashboardContent">
            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="blueprintCount">0</div>
                    <div class="stat-label">Blueprints</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="toolsComplete">0/5</div>
                    <div class="stat-label">Tools Used</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lastUpdated">-</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            </div>

            <!-- Tools Grid -->
            <div class="tools-grid">
                <!-- Step 1: Questionnaire -->
                <div class="tool-card" id="questionnaireCard">
                    <div class="tool-icon">üìù</div>
                    <div class="tool-title">Discovery Questionnaire</div>
                    <div class="tool-status status-complete" id="questionnaireStatus">‚úì Completed</div>
                    <div class="tool-description">
                        Deep reflection questions about your patterns, superpowers, and career journey. Your answers fuel the analysis.
                    </div>
                    <div class="tool-actions">
                        <button class="tool-btn btn-primary" onclick="openQuestionnaire()">View Responses</button>
                    </div>
                </div>

                <!-- Step 2: Career Insights Report - ¬£99 Deliverable -->
                <div class="tool-card" style="border: 2px solid #667eea;">
                    <div class="tool-icon">üìä</div>
                    <div class="tool-title">Career Insights Report</div>
                    <div class="tool-status status-complete" id="reportStatus">‚úì Completed</div>
                    <div class="tool-description">
                        Lisa's deep-dive analysis of your questionnaire responses. Your core pattern, unique thread, and career direction.
                    </div>
                    <div class="tool-actions">
                        <button class="tool-btn btn-primary" onclick="openInsightsReport()">View Report</button>
                    </div>
                </div>

                <!-- Step 3: Career Blueprint - Built through coaching -->
                <div class="tool-card" id="blueprintCard">
                    <div class="tool-icon">üìò</div>
                    <div class="tool-title">Transformation Blueprint</div>
                    <div class="tool-status status-complete" id="blueprintStatus">‚úì Completed</div>
                    <div class="tool-description">
                        Your complete positioning document built through coaching sessions. Evidence, belief moments, unique thread.
                    </div>
                    <div class="tool-actions">
                        <button class="tool-btn btn-primary" id="openBlueprintBtn" onclick="openBlueprint()">View Blueprint</button>
                    </div>
                </div>

                <!-- CV Builder -->
                <div class="tool-card" id="cvCard">
                    <div class="tool-icon">üìù</div>
                    <div class="tool-title">CV Builder</div>
                    <div class="tool-status status-locked" id="cvStatus">Requires Blueprint</div>
                    <div class="tool-description">
                        Build your CV with fields pre-filled from your Blueprint. Edit and refine your positioning.
                    </div>
                    <div class="tool-actions">
                        <button class="tool-btn btn-disabled" id="openCvBtn" onclick="openCVBuilder()" disabled>Open Builder</button>
                        <button class="tool-btn btn-secondary btn-disabled" id="exportCvBtn" onclick="exportCV()" disabled>Export PDF</button>
                    </div>
                </div>

                <!-- Mapping Guide -->
                <div class="tool-card">
                    <div class="tool-icon">üó∫Ô∏è</div>
                    <div class="tool-title">Mapping Guide</div>
                    <div class="tool-status status-pending">Reference</div>
                    <div class="tool-description">
                        A visual guide showing where your Blueprint content goes across LinkedIn, CV, and interviews.
                    </div>
                    <div class="tool-actions">
                        <button class="tool-btn btn-primary" onclick="openMappingGuide()">View Guide</button>
                    </div>
                </div>

                <!-- Decision Framework -->
                <div class="tool-card">
                    <div class="tool-icon">‚öñÔ∏è</div>
                    <div class="tool-title">Decision Framework</div>
                    <div class="tool-status status-locked" id="decisionStatus">Requires Blueprint</div>
                    <div class="tool-description">
                        Evaluate opportunities against your red flags and green flags. Score roles objectively.
                    </div>
                    <div class="tool-actions">
                        <button class="tool-btn btn-disabled" id="openDecisionBtn" onclick="openDecisionFramework()" disabled>Open Scorecard</button>
                    </div>
                </div>

                <!-- AI Prompt Library -->
                <div class="tool-card">
                    <div class="tool-icon">ü§ñ</div>
                    <div class="tool-title">AI Prompt Library</div>
                    <div class="tool-status status-pending">Ready</div>
                    <div class="tool-description">
                        Ready-to-use AI prompts for cover letters, LinkedIn posts, interview prep, and more.
                    </div>
                    <div class="tool-actions">
                        <button class="tool-btn btn-primary" onclick="openPromptLibrary()">Browse Prompts</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Spark Your Potential by Harness the Spark | harnessthespark.com
        </div>
    </div>

    <script>
        // =============================================================================
        // CONFIGURATION - SparkHub Backend (PostgreSQL)
        // =============================================================================
        const API_BASE_URL = 'https://sparkhub-be-qtmmb.ondigitalocean.app';

        // State
        let currentUser = null;
        let currentBlueprint = null;
        let authToken = null;
        let cachedClients = null; // Cache for API data

        // Status mapping between backend and frontend
        const STATUS_MAP = {
            'discovery': 'pre-programme',
            'enrolled': 'pre-programme',
            'session_1': 'week-1',
            'session_2': 'week-2',
            'session_3': 'week-3',
            'completed': 'complete',
            'alumni': 'complete'
        };

        const STATUS_MAP_REVERSE = {
            'pre-programme': 'enrolled',
            'week-1': 'session_1',
            'week-2': 'session_2',
            'week-3': 'session_3',
            'week-4': 'session_3',  // week-4 maps to session_3 in backend
            'complete': 'completed'
        };

        // Default clients - only shown when authenticated as coach
        // These are fallback clients when PostgreSQL API is unavailable
        const DEFAULT_CLIENTS = {
            'sarah.mitchell@demo.com': {
                id: 'client-sarah-demo',
                name: 'Sarah Mitchell',
                email: 'sarah.mitchell@demo.com',
                phone: '',
                folder: 'sarah_mitchell_demo_client',
                status: 'complete',
                isDemo: true,
                enrolledDate: '2024-09-01',
                completedDate: '2024-10-15',
                progress: {
                    questionnaire: true,
                    insightsReport: true,
                    blueprint: true,
                    decisionFramework: true,
                    cvBuilder: true,
                    mappingGuide: true
                }
            },
            'donaldpirie111@hotmail.co.uk': {
                id: 'client-donald',
                name: 'Donald Pirie',
                email: 'donaldpirie111@hotmail.co.uk',
                phone: '',
                folder: 'Donald',
                status: 'complete',
                enrolledDate: '2024-10-01',
                completedDate: '2024-11-28',
                progress: {
                    questionnaire: true,
                    insightsReport: true,
                    blueprint: true,
                    decisionFramework: true,
                    cvBuilder: true,
                    mappingGuide: true
                }
            },
            'rs@rajsamuel.net': {
                id: 'client-raj',
                name: 'Raj Samuel',
                email: 'rs@rajsamuel.net',
                phone: '',
                folder: 'Raj_Samuel',
                status: 'pre-programme',
                enrolledDate: '2025-12-01',
                completedDate: null,
                agreementSigned: false,
                signedDocuments: [],
                progress: {
                    questionnaire: false,
                    insightsReport: false,
                    blueprint: false,
                    decisionFramework: false,
                    cvBuilder: false,
                    mappingGuide: false
                }
            },
            'simon@boothlucking.com': {
                id: 'client-simon',
                name: 'Simon Booth-Lucking',
                email: 'simon@boothlucking.com',
                phone: '',
                folder: 'Simon_Booth_Lucking',
                status: 'complete',  // Full self-service access
                enrolledDate: '2025-12-05',
                completedDate: null,
                agreementSigned: false,
                signedDocuments: [],
                programmeType: 'testimonial-access',
                notes: 'Testimonial exchange client - self-service access to all tools (no coaching)',
                progress: {
                    questionnaire: true,
                    insightsReport: false,
                    blueprint: false,
                    decisionFramework: false,
                    cvBuilder: false,
                    mappingGuide: false
                }
            }
        };

        // Week descriptions for journey display (Career clients)
        const WEEK_INFO = {
            'pre-programme': { label: 'Pre-Programme', icon: 'üìã', description: 'Welcome & Questionnaire' },
            'week-1': { label: 'Week 1', icon: 'üå±', description: 'Foundation - Patterns & Evidence' },
            'week-2': { label: 'Week 2', icon: 'üß≠', description: 'Direction - Insights & Decisions' },
            'week-3': { label: 'Week 3', icon: 'üéØ', description: 'Positioning - Brand & Headlines' },
            'week-4': { label: 'Week 4', icon: 'üöÄ', description: 'Implementation - CV & LinkedIn' },
            'complete': { label: 'Complete', icon: 'üèÜ', description: 'Programme Finished' }
        };

        // AuDHD stage descriptions (for AuDHD coaching clients)
        const AUDHD_STAGE_INFO = {
            'pre-programme': { label: 'Pre-Programme', icon: 'üìã', description: 'Welcome & Initial Assessment' },
            'week-1': { label: 'Session 1', icon: 'üß†', description: 'Brain Foundations' },
            'week-2': { label: 'Session 2', icon: '‚ö°', description: 'Energy Management' },
            'week-3': { label: 'Session 3', icon: 'üéØ', description: 'Strategy & Systems' },
            'week-4': { label: 'Session 4', icon: 'üîÑ', description: 'Integration & Practice' },
            'complete': { label: 'Complete', icon: 'üèÜ', description: 'Programme Finished' }
        };

        // Programme type labels and colours
        const PROGRAMME_TYPES = {
            'career': { label: 'Career', colour: '#667eea', icon: 'üíº' },
            'audhd': { label: 'AuDHD', colour: '#8B5CF6', icon: 'üß†' },
            'life': { label: 'Life', colour: '#10B981', icon: 'üå±' },
            'exec': { label: 'Executive', colour: '#F59E0B', icon: 'üëî' },
            'testimonial-access': { label: 'Testimonial', colour: '#6B7280', icon: 'üìù' }
        };

        // Get stage info based on programme type
        function getStageInfo(status, programmeType) {
            if (programmeType === 'audhd') {
                return AUDHD_STAGE_INFO[status] || AUDHD_STAGE_INFO['pre-programme'];
            }
            return WEEK_INFO[status] || WEEK_INFO['pre-programme'];
        }

        // Check for existing session - restore from localStorage
        window.onload = async function() {
            const savedUser = localStorage.getItem('syp_user');
            const savedToken = localStorage.getItem('syp_token');

            if (savedUser && savedToken) {
                // Restore session from localStorage
                currentUser = JSON.parse(savedUser);
                authToken = savedToken;
                console.log('‚úÖ Session restored from localStorage');
                showDashboard();
            }
        };

        // Login with password - connects to SparkHub PostgreSQL backend
        async function login() {
            const username = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorEl = document.getElementById('loginError');

            errorEl.style.display = 'none';

            if (!username) {
                errorEl.textContent = 'Please enter your username';
                errorEl.style.display = 'block';
                return;
            }

            if (!password) {
                errorEl.textContent = 'Please enter your password';
                errorEl.style.display = 'block';
                return;
            }

            try {
                // Authenticate against SparkHub backend
                const response = await fetch(`${API_BASE_URL}/api/accounts/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                console.log('Login response:', data);

                if (response.ok && data.success !== false) {
                    // Store JWT token
                    authToken = data.token || data.access;
                    localStorage.setItem('syp_token', authToken);

                    // Create user object from response
                    currentUser = {
                        id: data.user?.id || data.id,
                        name: data.user?.first_name || data.first_name || username,
                        email: data.user?.email || data.email || '',
                        isStaff: data.user?.is_staff || data.is_staff || false
                    };
                    localStorage.setItem('syp_user', JSON.stringify(currentUser));

                    console.log('‚úÖ Login successful:', currentUser.name);
                    showDashboard();
                } else {
                    // Handle error response - SparkHub returns {success: false, message: "..."}
                    errorEl.textContent = data.message || data.detail || data.error || 'Invalid credentials';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = 'Could not connect to server. Please try again.';
                errorEl.style.display = 'block';
            }
        }

        // Show dashboard after login
        async function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardContent').classList.add('visible');
            document.getElementById('userName').textContent = `Welcome, ${currentUser.name || currentUser.email}`;

            // Show user menu
            document.getElementById('userMenu').style.display = 'flex';
            document.getElementById('userEmail').textContent = currentUser.email;

            // Show Coach Mode if Lisa is logged in
            if (isCoach()) {
                showCoachMode();
            }

            // Fetch user's blueprint
            await loadBlueprint();
        }

        // Load blueprint data
        async function loadBlueprint() {
            // For static demo site (no backend), assume blueprint is complete
            // This allows all tools to work with the static HTML files
            if (!window.location.hostname.includes('localhost') || currentUser.id.startsWith('demo')) {
                // Static hosting or demo mode - skip API call, unlock all tools
                currentBlueprint = {
                    id: 'static-blueprint',
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                updateDashboardState(true);
                return;
            }

            // Only try API if running with backend server
            try {
                const response = await fetch(`/api/blueprint/${currentUser.id}`);
                const data = await response.json();

                if (data.success && data.blueprint) {
                    currentBlueprint = data.blueprint;
                    updateDashboardState(true);
                } else {
                    updateDashboardState(false);
                }
            } catch (error) {
                console.error('Error loading blueprint:', error);
                // Fallback: assume complete for demo purposes
                updateDashboardState(true);
            }
        }

        // Update dashboard based on blueprint status
        function updateDashboardState(hasBlueprint) {
            const blueprintStatus = document.getElementById('blueprintStatus');
            const openBlueprintBtn = document.getElementById('openBlueprintBtn');
            const cvStatus = document.getElementById('cvStatus');
            const openCvBtn = document.getElementById('openCvBtn');
            const exportCvBtn = document.getElementById('exportCvBtn');
            const decisionStatus = document.getElementById('decisionStatus');
            const openDecisionBtn = document.getElementById('openDecisionBtn');

            if (hasBlueprint) {
                // Blueprint complete - unlock everything
                blueprintStatus.textContent = '‚úì Completed';
                blueprintStatus.className = 'tool-status status-complete';
                openBlueprintBtn.disabled = false;
                openBlueprintBtn.classList.remove('btn-disabled');
                openBlueprintBtn.classList.add('btn-primary');

                // Unlock CV Builder
                cvStatus.textContent = 'Ready';
                cvStatus.className = 'tool-status status-pending';
                openCvBtn.disabled = false;
                openCvBtn.classList.remove('btn-disabled');
                openCvBtn.classList.add('btn-primary');
                exportCvBtn.disabled = false;
                exportCvBtn.classList.remove('btn-disabled');

                // Unlock Decision Framework
                decisionStatus.textContent = 'Ready';
                decisionStatus.className = 'tool-status status-pending';
                openDecisionBtn.disabled = false;
                openDecisionBtn.classList.remove('btn-disabled');
                openDecisionBtn.classList.add('btn-primary');

                // Update stats
                document.getElementById('blueprintCount').textContent = '1';
                document.getElementById('toolsComplete').textContent = '6/6';

                const date = new Date(currentBlueprint.updated_at || currentBlueprint.created_at);
                document.getElementById('lastUpdated').textContent = date.toLocaleDateString('en-GB');
            } else {
                // No blueprint yet
                blueprintStatus.textContent = 'Requires Report';
                blueprintStatus.className = 'tool-status status-locked';
            }
        }

        // Navigation functions - Load user-specific documents
        function getUserPrefix() {
            // Return document prefix based on logged-in user
            if (!currentUser) return 'templates';

            const email = currentUser.email.toLowerCase();
            if (email.includes('donald')) {
                return 'Donald/Donald_Pirie';
            } else if (email.includes('raj') || email.includes('rajsamuel')) {
                return 'Raj_Samuel/Raj_Samuel';
            }
            // Default to templates
            return 'templates';
        }

        function openQuestionnaire() {
            const prefix = getUserPrefix();
            if (prefix.includes('Donald')) {
                window.open('Donald/donald-questionnaire-responses.html', '_blank');
            } else if (prefix.includes('Raj_Samuel')) {
                window.open('Raj_Samuel/Raj_Samuel_Discovery_Questionnaire.html', '_blank');
            } else {
                window.open('templates/discovery_questionnaire.html', '_blank');
            }
        }

        function openInsightsReport() {
            const prefix = getUserPrefix();
            if (prefix.includes('Donald')) {
                window.open('Donald/Donald_Pirie_Career_Insights_Report.html', '_blank');
            } else if (prefix.includes('Raj_Samuel')) {
                alert('Insights Report will be available after Week 1 session.');
            } else {
                alert('Please log in to view your Insights Report.');
            }
        }

        function openBlueprint() {
            const prefix = getUserPrefix();
            if (prefix.includes('Donald')) {
                window.open('Donald/Donald_Pirie_Career_Blueprint_LIVE.html', '_blank');
            } else if (prefix.includes('Raj_Samuel')) {
                alert('Blueprint will be available after completing the programme.');
            } else {
                alert('Please log in to view your Blueprint.');
            }
        }

        function viewBlueprint() {
            openBlueprint();
        }

        function openCVBuilder() {
            const prefix = getUserPrefix();
            if (prefix.includes('Donald')) {
                window.open('Donald/Donald_Interactive_CV_Builder.html', '_blank');
            } else if (prefix.includes('Raj_Samuel')) {
                alert('CV Builder will be available after Week 2 session.');
            } else {
                alert('Please log in to access the CV Builder.');
            }
        }

        function openMappingGuide() {
            const prefix = getUserPrefix();
            if (prefix.includes('Donald')) {
                window.open('Donald/Donald_Blueprint_CV_LinkedIn_Mapping_Guide_1.html', '_blank');
            } else if (prefix.includes('Raj_Samuel')) {
                alert('Mapping Guide will be available after Week 3 session.');
            } else {
                alert('Please log in to access the Mapping Guide.');
            }
        }

        function openDecisionFramework() {
            const prefix = getUserPrefix();
            if (prefix.includes('Donald')) {
                window.open('Donald/Donald_Decision_Framework_Updated_1.html', '_blank');
            } else if (prefix.includes('Raj_Samuel')) {
                alert('Decision Framework will be available after Week 2 session.');
            } else {
                alert('Please log in to access the Decision Framework.');
            }
        }

        function openPromptLibrary() {
            window.open('AI_Prompt_Library.html', '_blank');
        }

        function exportCV() {
            alert('PDF export coming soon! For now, use your browser\'s Print function (Ctrl/Cmd + P) to save as PDF.');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem('syp_user');
                localStorage.removeItem('syp_token');
                localStorage.removeItem('syp_clients');  // Clear cached clients
                currentUser = null;
                currentBlueprint = null;
                authToken = null;
                cachedClients = null;
                window.location.reload();
            }
        }

        // Load Coach Mode (Lisa) - Authenticates with SparkHub PostgreSQL backend
        async function loadCoach() {
            const errorEl = document.getElementById('loginError');

            try {
                // Try to authenticate as admin/coach
                const response = await fetch(`${API_BASE_URL}/api/accounts/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',  // Lisa's admin account
                        password: prompt('Enter admin password:') || ''
                    })
                });

                if (response.ok) {
                    const data = await response.json();

                    // Store JWT token for API calls
                    authToken = data.token || data.access;
                    localStorage.setItem('syp_token', authToken);

                    currentUser = {
                        id: data.user?.id || data.id || 'coach-lisa',
                        name: data.user?.first_name || 'Lisa',
                        email: data.user?.email || 'lisa@harnessthespark.com',
                        isStaff: true
                    };
                    localStorage.setItem('syp_user', JSON.stringify(currentUser));

                    currentBlueprint = {
                        id: 'coach-blueprint',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };

                    console.log('‚úÖ Coach mode authenticated with PostgreSQL backend');

                    // Show dashboard with coach mode
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('dashboardContent').classList.add('visible');
                    document.getElementById('userName').textContent = `Welcome, ${currentUser.name}`;

                    // Show user menu
                    document.getElementById('userMenu').style.display = 'flex';
                    document.getElementById('userEmail').textContent = currentUser.email + ' (Coach)';

                    // Show Coach Mode panel - will fetch clients from PostgreSQL
                    showCoachMode();

                    // Update state to show blueprint is complete (all tools unlocked)
                    updateDashboardState(true);
                } else {
                    // Authentication failed - show error, do NOT fall back to offline mode
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Coach authentication failed:', response.status, errorData);
                    errorEl.textContent = errorData.detail || 'Authentication failed. Please check your credentials.';
                    errorEl.style.display = 'block';
                }
            } catch (error) {
                console.error('‚ùå Coach auth error:', error);
                // Show error - do NOT allow unauthenticated coach access
                errorEl.textContent = 'Could not connect to server. Please try again later.';
                errorEl.style.display = 'block';
            }
        }

        // SECURITY: loadCoachOffline() REMOVED - Coach Mode requires authentication
        // Previous version allowed unauthenticated access which was a security vulnerability

        // Load demo - Works without server!
        function loadDemo() {
            // Create demo user locally (no server needed)
            currentUser = {
                id: 'demo-user',
                name: 'Demo User',
                email: 'demo@example.com'
            };

            currentBlueprint = {
                id: 'demo-blueprint',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            localStorage.setItem('syp_user', JSON.stringify(currentUser));

            // Show dashboard with demo data
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardContent').classList.add('visible');
            document.getElementById('userName').textContent = `Demo: ${currentUser.name}`;

            // Show user menu
            document.getElementById('userMenu').style.display = 'flex';
            document.getElementById('userEmail').textContent = currentUser.email + ' (demo)';

            // Update state to show blueprint is complete (all tools unlocked)
            updateDashboardState(true);
        }

        // ============================================================
        // COACH MODE FUNCTIONS
        // ============================================================

        // Check if current user is an authenticated coach
        // SECURITY: Requires valid auth token AND staff flag
        function isCoach() {
            if (!authToken) return false;
            if (!currentUser) return false;
            if (!currentUser.isStaff) return false;
            return true;
        }

        // Show coach mode interface
        // SECURITY: Only accessible to authenticated staff users
        function showCoachMode() {
            if (!isCoach()) {
                console.warn('‚ö†Ô∏è Coach mode access denied - not authenticated as staff');
                return;
            }
            console.log('‚úÖ Coach mode activated for authenticated staff user');
            document.getElementById('coachMode').style.display = 'block';

            // Don't clear cache - renderClientList() always starts with DEFAULT_CLIENTS anyway
            // This ensures offline mode still works with all 3 default clients

            renderClientList();
        }

        // Refresh clients from database
        async function refreshClients() {
            // Clear cache to force fresh fetch from API
            // Note: renderClientList() always starts with DEFAULT_CLIENTS, so they won't be lost
            localStorage.removeItem('syp_clients');
            cachedClients = null;
            await renderClientList();
        }

        // Update data source indicator
        function updateDataSourceIndicator(isLive) {
            const icon = document.getElementById('dataSourceIcon');
            const text = document.getElementById('dataSourceText');

            if (isLive) {
                icon.textContent = 'üü¢';
                text.textContent = 'Live (PostgreSQL)';
            } else {
                icon.textContent = 'üì¶';
                text.textContent = 'Cached (Local)';
            }
        }

        // Render the client list cards
        // VERSION: 2025-12-01-v2 - Debug client loading
        async function renderClientList() {
            const container = document.getElementById('clientList');

            // Show loading state
            container.innerHTML = '<div style="color: white; text-align: center; padding: 20px;">Loading clients...</div>';

            // ALWAYS start with DEFAULT_CLIENTS - these must NEVER be lost
            let clients = {};

            // Step 1: Copy all DEFAULT_CLIENTS first (guaranteed base)
            Object.keys(DEFAULT_CLIENTS).forEach(email => {
                clients[email] = { ...DEFAULT_CLIENTS[email] };
            });
            console.log('üì¶ Step 1 - DEFAULT_CLIENTS loaded:', Object.keys(clients).length, Object.keys(clients));

            // Step 2: Try to fetch from API and merge (API data overwrites defaults for matching emails)
            try {
                const apiClients = await getStoredClients();
                const apiCount = Object.keys(apiClients).length;
                console.log('üì¶ Step 2 - API returned:', apiCount, 'clients');

                if (apiCount > 0) {
                    // Merge API clients on top of defaults (API wins for duplicates, defaults remain for non-matches)
                    Object.keys(apiClients).forEach(email => {
                        clients[email] = { ...apiClients[email] };
                    });
                    console.log('üì¶ Step 2 - After merge:', Object.keys(clients).length, Object.keys(clients));
                }
            } catch (error) {
                console.error('üì¶ API error, using DEFAULT_CLIENTS only:', error);
                updateDataSourceIndicator(false);
            }

            // Step 3: Final safety check - ensure DEFAULT_CLIENTS are present
            Object.keys(DEFAULT_CLIENTS).forEach(email => {
                if (!clients[email]) {
                    console.warn('‚ö†Ô∏è Missing default client, restoring:', email);
                    clients[email] = { ...DEFAULT_CLIENTS[email] };
                }
            });

            // Step 4: Also include AuDHD clients from localStorage (for offline-added clients)
            try {
                const audhdClients = JSON.parse(localStorage.getItem('audhd_clients') || '{}');
                Object.keys(audhdClients).forEach(email => {
                    if (!clients[email]) {
                        clients[email] = { ...audhdClients[email] };
                        console.log('üì¶ Added AuDHD client from localStorage:', email);
                    }
                });
            } catch (e) {
                console.error('Error loading AuDHD clients from localStorage:', e);
            }

            // Apply programme filter if active
            let clientList = Object.values(clients);
            if (currentFilter && currentFilter !== 'all') {
                clientList = clientList.filter(c => {
                    const type = c.programmeType || c.programme || 'career';
                    return type === currentFilter;
                });
            }
            console.log('üì¶ Final client list:', clientList.length, clientList.map(c => c.name));

            // Should never be empty now since DEFAULT_CLIENTS always has entries
            if (clientList.length === 0) {
                container.innerHTML = `
                    <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 30px; text-align: center; grid-column: 1 / -1;">
                        <div style="font-size: 2em; margin-bottom: 15px;">üëã</div>
                        <h4 style="color: #333; margin-bottom: 10px;">No clients yet</h4>
                        <p style="color: #666; margin-bottom: 20px;">Click "+ Add New Client" to add your first client to the programme.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = clientList.map(client => {
                const programmeType = client.programmeType || 'career';
                const programmeInfo = PROGRAMME_TYPES[programmeType] || PROGRAMME_TYPES['career'];
                const stageInfo = getStageInfo(client.status, programmeType);

                return `
                <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px; cursor: pointer; position: relative; ${client.isDemo ? 'border: 2px dashed #ffc107;' : ''} ${programmeType === 'audhd' ? 'border-left: 4px solid #8B5CF6;' : ''}" onclick="viewClientJourney('${client.email}')">
                    <button onclick="event.stopPropagation(); deleteClient('${client.email}', '${client.name}')"
                            style="position: absolute; top: 10px; right: 10px; background: rgba(220, 53, 69, 0.1); border: none; border-radius: 6px; padding: 5px 8px; cursor: pointer; font-size: 0.85em; color: #dc3545; transition: all 0.2s;"
                            onmouseover="this.style.background='rgba(220, 53, 69, 0.2)'"
                            onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'"
                            title="Delete client">
                        üóëÔ∏è
                    </button>
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; padding-right: 35px;">
                        <h4 style="color: #333; margin: 0;">
                            ${client.name}
                            ${client.isDemo ? '<span style="font-size: 0.7em; background: #ffc107; color: #333; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">DEMO</span>' : ''}
                        </h4>
                        <div style="display: flex; gap: 6px; align-items: center;">
                            <span style="background: ${programmeInfo.colour}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7em; font-weight: 600;">
                                ${programmeInfo.icon} ${programmeInfo.label}
                            </span>
                            <span style="background: ${getStatusColour(client.status)}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75em;">
                                ${stageInfo.label || client.status}
                            </span>
                        </div>
                    </div>
                    <p style="color: #666; font-size: 0.85em; margin-bottom: 8px;">${client.email}</p>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        ${client.agreementSigned ?
                            '<span style="font-size: 0.75em; background: #d4edda; color: #155724; padding: 2px 8px; border-radius: 4px;">‚úì Agreement Signed</span>' :
                            '<span style="font-size: 0.75em; background: #fff3cd; color: #856404; padding: 2px 8px; border-radius: 4px;">‚è≥ Agreement Pending</span>'
                        }
                    </div>
                    <p style="color: #888; font-size: 0.8em;">
                        ${stageInfo.icon || 'üìã'} ${stageInfo.description || ''}
                    </p>
                    <div style="margin-top: 10px; height: 4px; background: #e0e0e0; border-radius: 2px;">
                        <div style="height: 100%; width: ${getProgressPercentage(client.status)}%; background: ${getStatusColour(client.status)}; border-radius: 2px;"></div>
                    </div>
                </div>
            `}).join('');
        }

        // Get status colour
        function getStatusColour(status) {
            const colours = {
                'pre-programme': '#9b59b6',
                'week-1': '#3498db',
                'week-2': '#2ecc71',
                'week-3': '#f39c12',
                'week-4': '#e74c3c',
                'complete': '#27ae60'
            };
            return colours[status] || '#667eea';
        }

        // Get progress percentage
        function getProgressPercentage(status) {
            const percentages = {
                'pre-programme': 10,
                'week-1': 30,
                'week-2': 50,
                'week-3': 70,
                'week-4': 90,
                'complete': 100
            };
            return percentages[status] || 0;
        }

        // View client journey
        function viewClientJourney(email) {
            const clients = getStoredClientsSync();
            const client = clients[email];
            if (!client) return;

            const programmeType = client.programmeType || 'career';
            const programmeInfo = PROGRAMME_TYPES[programmeType] || PROGRAMME_TYPES['career'];
            const currentStageInfo = getStageInfo(client.status, programmeType);

            document.getElementById('journeyView').style.display = 'block';
            document.getElementById('journeyClientName').textContent = client.name;
            document.getElementById('journeyClientStatus').innerHTML = `
                <span style="background: ${programmeInfo.colour}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.85em; margin-right: 10px;">
                    ${programmeInfo.icon} ${programmeInfo.label}
                </span>
                Enrolled: ${client.enrolledDate} | Current: ${currentStageInfo.label}
            `;

            // Render timeline
            const timeline = document.getElementById('journeyTimeline');
            const stages = ['pre-programme', 'week-1', 'week-2', 'week-3', 'week-4', 'complete'];
            const currentIndex = stages.indexOf(client.status);

            timeline.innerHTML = stages.map((stage, index) => {
                const info = getStageInfo(stage, programmeType);
                const isComplete = index < currentIndex || client.status === 'complete';
                const isCurrent = index === currentIndex;
                const isLocked = index > currentIndex;

                return `
                    <div style="flex: 1; text-align: center; padding: 15px 10px; border-radius: 10px;
                         background: ${isComplete ? '#e8f5e9' : isCurrent ? '#e3f2fd' : '#f5f5f5'};
                         border: 2px solid ${isComplete ? '#4caf50' : isCurrent ? '#2196f3' : '#e0e0e0'};
                         opacity: ${isLocked ? '0.5' : '1'};">
                        <div style="font-size: 1.8em; margin-bottom: 8px;">${isComplete ? '‚úÖ' : info.icon}</div>
                        <div style="font-weight: 600; color: ${isComplete ? '#4caf50' : isCurrent ? '#2196f3' : '#666'}; font-size: 0.9em;">
                            ${info.label}
                        </div>
                        <div style="font-size: 0.75em; color: #888; margin-top: 5px;">
                            ${info.description.split(' - ')[0]}
                        </div>
                    </div>
                `;
            }).join('');

            // Render week actions
            renderWeekActions(client);
        }

        // Render actions for the current week (using worksheets, not automation)
        function renderWeekActions(client) {
            const container = document.getElementById('weekActions');
            const status = client.status;
            const programmeType = client.programmeType || 'career';

            // Generate folder name from client name
            const clientFolder = client.folder || client.name.replace(/\s+/g, '_');

            // AuDHD-specific actions
            if (programmeType === 'audhd') {
                const audhdActions = {
                    'pre-programme': `
                        <h4 style="color: #8B5CF6; margin-bottom: 15px;">üìã Pre-Programme Setup</h4>
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <h5 style="color: #666; margin: 0 0 10px 0; font-size: 0.9em;">üìÑ Client Documents</h5>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${client.agreementSigned ?
                                    `<a href="${clientFolder}/${clientFolder}_AuDHD_Coaching_Agreement.html" target="_blank" style="font-size: 0.8em; background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 4px; text-decoration: none;">‚úì View Signed Agreement</a>` :
                                    `<a href="${clientFolder}/${clientFolder}_AuDHD_Coaching_Agreement.html" target="_blank" style="font-size: 0.8em; background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 4px; text-decoration: none;">‚è≥ Agreement Pending</a>`
                                }
                            </div>
                        </div>
                        <div style="display: grid; gap: 10px;">
                            <a href="audhd-foundations.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">üß† View AuDHD Foundations</a>
                            <button onclick="advanceClient('${client.email}', 'week-1')" class="action-btn advance">‚úÖ Complete Setup ‚Üí Session 1</button>
                        </div>
                    `,
                    'week-1': `
                        <h4 style="color: #8B5CF6; margin-bottom: 15px;">üß† Session 1: Brain Foundations</h4>
                        <p style="color: #666; margin-bottom: 15px;">Understanding your AuDHD brain, patterns, and strengths.</p>
                        <div style="display: grid; gap: 10px;">
                            <a href="audhd-foundations.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">üß† AuDHD Foundations</a>
                            <a href="audhd-braindump.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">üìã Brain Dump Tool</a>
                            <button onclick="advanceClient('${client.email}', 'week-2')" class="action-btn advance">‚úÖ Complete Session 1 ‚Üí Session 2</button>
                        </div>
                    `,
                    'week-2': `
                        <h4 style="color: #8B5CF6; margin-bottom: 15px;">‚ö° Session 2: Energy Management</h4>
                        <p style="color: #666; margin-bottom: 15px;">Tracking energy patterns and building sustainable systems.</p>
                        <div style="display: grid; gap: 10px;">
                            <a href="audhd-energy.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">‚ö° Energy Tracker</a>
                            <a href="audhd-braindump.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">üìã Brain Dump Tool</a>
                            <button onclick="advanceClient('${client.email}', 'week-3')" class="action-btn advance">‚úÖ Complete Session 2 ‚Üí Session 3</button>
                        </div>
                    `,
                    'week-3': `
                        <h4 style="color: #8B5CF6; margin-bottom: 15px;">üéØ Session 3: Strategy & Systems</h4>
                        <p style="color: #666; margin-bottom: 15px;">Building personalised strategies and decision frameworks.</p>
                        <div style="display: grid; gap: 10px;">
                            <a href="audhd-decision-framework.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">‚öñÔ∏è Decision Framework</a>
                            <a href="audhd-session-notes.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">üìù Session Notes</a>
                            <button onclick="advanceClient('${client.email}', 'week-4')" class="action-btn advance">‚úÖ Complete Session 3 ‚Üí Session 4</button>
                        </div>
                    `,
                    'week-4': `
                        <h4 style="color: #8B5CF6; margin-bottom: 15px;">üîÑ Session 4: Integration & Practice</h4>
                        <p style="color: #666; margin-bottom: 15px;">Putting it all together and building lasting habits.</p>
                        <div style="display: grid; gap: 10px;">
                            <a href="audhd-foundations.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">üß† Review Foundations</a>
                            <a href="audhd-energy.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">‚ö° Review Energy Patterns</a>
                            <a href="audhd-session-notes.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">üìù Final Session Notes</a>
                            <button onclick="advanceClient('${client.email}', 'complete')" class="action-btn advance">üèÜ Mark Programme Complete</button>
                        </div>
                    `,
                    'complete': `
                        <h4 style="color: #27ae60; margin-bottom: 15px;">üèÜ Programme Complete!</h4>
                        <p style="color: #666; margin-bottom: 15px;">Client has completed the AuDHD Coaching programme.</p>
                        <div style="display: grid; gap: 10px;">
                            <a href="audhd-foundations.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">üß† View AuDHD Foundations</a>
                            <a href="audhd-energy.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">‚ö° View Energy Tracker</a>
                            <a href="audhd-braindump.html?client=${encodeURIComponent(client.email)}" target="_blank" class="action-btn">üìã View Brain Dumps</a>
                            <a href="client-portal.html?client=${encodeURIComponent(client.email)}" class="action-btn" style="text-decoration: none;">üë§ Open Client Portal</a>
                        </div>
                    `
                };

                container.innerHTML = `
                    <style>
                        .action-btn {
                            display: block;
                            width: 100%;
                            padding: 12px 20px;
                            background: #f0f0f0;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                            text-align: left;
                            cursor: pointer;
                            font-size: 0.95em;
                            color: #333;
                            text-decoration: none;
                            transition: all 0.2s;
                        }
                        .action-btn:hover { background: #e8e8e8; }
                        .action-btn.advance {
                            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
                            color: white;
                            border: none;
                            font-weight: 600;
                        }
                        .action-btn.advance:hover { opacity: 0.9; }
                    </style>
                    ${audhdActions[status] || '<p>No actions available for this status.</p>'}
                `;
                return;
            }

            // Career programme actions (default)
            const actions = {
                'pre-programme': `
                    <h4 style="color: #9b59b6; margin-bottom: 15px;">üìã Pre-Programme Setup</h4>

                    <!-- Documents Section -->
                    <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                        <h5 style="color: #666; margin: 0 0 10px 0; font-size: 0.9em;">üìÑ Client Documents</h5>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${client.agreementSigned ?
                                `<a href="${clientFolder}/${clientFolder}_Coaching_Agreement.html" target="_blank" style="font-size: 0.8em; background: #d4edda; color: #155724; padding: 4px 10px; border-radius: 4px; text-decoration: none;">‚úì View Signed Agreement</a>` :
                                `<a href="${clientFolder}/${clientFolder}_Coaching_Agreement.html" target="_blank" style="font-size: 0.8em; background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 4px; text-decoration: none;">‚è≥ Agreement Pending</a>`
                            }
                            <a href="${clientFolder}/${clientFolder}_Programme_Outline.html" target="_blank" style="font-size: 0.8em; background: #e7f3ff; color: #0066cc; padding: 4px 10px; border-radius: 4px; text-decoration: none;">üìñ Programme Outline</a>
                        </div>
                    </div>

                    <div style="display: grid; gap: 10px;">
                        <a href="${clientFolder}/${clientFolder}_Discovery_Questionnaire.html" target="_blank" class="action-btn">üìù Send Questionnaire Link</a>
                        <button onclick="openClientQuestionnaire('${client.email}')" class="action-btn">üëÅÔ∏è View Responses</button>
                        <button onclick="openQuestionnaireEditor('${client.id}')" class="action-btn" style="background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%); color: white;">‚úèÔ∏è Edit Responses (PostgreSQL)</button>
                        <button onclick="advanceClient('${client.email}', 'week-1')" class="action-btn advance">‚úÖ Mark Questionnaire Complete ‚Üí Week 1</button>
                    </div>
                `,
                'week-1': `
                    <h4 style="color: #3498db; margin-bottom: 15px;">üå± Week 1: Foundation Session</h4>
                    <p style="color: #666; margin-bottom: 15px;">Work through patterns, evidence collection, and thread discovery.</p>
                    <div style="display: grid; gap: 10px;">
                        <button onclick="openClientBlueprint('${client.email}')" class="action-btn">üìò Open Blueprint (Week 1)</button>
                        <button onclick="advanceClient('${client.email}', 'week-2')" class="action-btn advance">‚úÖ Complete Week 1 ‚Üí Week 2</button>
                    </div>
                `,
                'week-2': `
                    <h4 style="color: #2ecc71; margin-bottom: 15px;">üß≠ Week 2: Direction Session</h4>
                    <p style="color: #666; margin-bottom: 15px;">Career insights, decision framework, charges & drains.</p>
                    <div style="display: grid; gap: 10px;">
                        <button onclick="openClientInsights('${client.email}')" class="action-btn">üìä Open Career Insights Report</button>
                        <button onclick="openClientDecision('${client.email}')" class="action-btn">‚öñÔ∏è Open Decision Framework</button>
                        <button onclick="openClientBlueprint('${client.email}')" class="action-btn">üìò Update Blueprint (Week 2)</button>
                        <button onclick="advanceClient('${client.email}', 'week-3')" class="action-btn advance">‚úÖ Complete Week 2 ‚Üí Week 3</button>
                    </div>
                `,
                'week-3': `
                    <h4 style="color: #f39c12; margin-bottom: 15px;">üéØ Week 3: Positioning Session</h4>
                    <p style="color: #666; margin-bottom: 15px;">One-sentence intro, LinkedIn headlines, elevator pitches.</p>
                    <div style="display: grid; gap: 10px;">
                        <button onclick="openClientBlueprint('${client.email}')" class="action-btn">üìò Update Blueprint (Week 3)</button>
                        <button onclick="openClientMapping('${client.email}')" class="action-btn">üó∫Ô∏è Open Mapping Guide</button>
                        <button onclick="advanceClient('${client.email}', 'week-4')" class="action-btn advance">‚úÖ Complete Week 3 ‚Üí Week 4</button>
                    </div>
                `,
                'week-4': `
                    <h4 style="color: #e74c3c; margin-bottom: 15px;">üöÄ Week 4: Implementation Session</h4>
                    <p style="color: #666; margin-bottom: 15px;">CV Builder, LinkedIn updates, AI prompts.</p>
                    <div style="display: grid; gap: 10px;">
                        <button onclick="openClientCV('${client.email}')" class="action-btn">üìù Open CV Builder</button>
                        <button onclick="openClientMapping('${client.email}')" class="action-btn">üó∫Ô∏è Open Mapping Guide</button>
                        <a href="AI_Prompt_Library.html" target="_blank" class="action-btn">ü§ñ AI Prompt Library</a>
                        <button onclick="advanceClient('${client.email}', 'complete')" class="action-btn advance">üèÜ Mark Programme Complete</button>
                    </div>
                `,
                'complete': `
                    <h4 style="color: #27ae60; margin-bottom: 15px;">üèÜ Programme Complete!</h4>
                    <p style="color: #666; margin-bottom: 15px;">Client has completed the Career Booster programme.</p>
                    <div style="display: grid; gap: 10px;">
                        <button onclick="openClientBlueprint('${client.email}')" class="action-btn">üìò View Final Blueprint</button>
                        <button onclick="openClientCV('${client.email}')" class="action-btn">üìù View CV Builder</button>
                        <button onclick="openAllClientDocs('${client.email}')" class="action-btn">üìÅ View All Documents</button>
                        <a href="client-portal.html?client=${encodeURIComponent(client.email)}" class="action-btn" style="text-decoration: none;">üë§ Open Client Portal</a>
                    </div>
                `
            };

            container.innerHTML = `
                <style>
                    .action-btn {
                        display: block;
                        width: 100%;
                        padding: 12px 20px;
                        background: #f0f0f0;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        text-align: left;
                        cursor: pointer;
                        font-size: 0.95em;
                        color: #333;
                        text-decoration: none;
                        transition: all 0.2s;
                    }
                    .action-btn:hover { background: #e8e8e8; }
                    .action-btn.advance {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        font-weight: 600;
                    }
                    .action-btn.advance:hover { opacity: 0.9; }
                </style>
                ${actions[status] || '<p>No actions available for this status.</p>'}
            `;
        }

        // Advance client to next stage - saves to PostgreSQL
        async function advanceClient(email, newStatus) {
            const clients = getStoredClientsSync();
            const client = clients[email];
            if (!client) return;

            // Convert frontend status to backend status
            const backendStatus = STATUS_MAP_REVERSE[newStatus] || newStatus;

            // If we have auth token and client has an ID (from PostgreSQL), update via API
            const isPostgreSQLId = client.id && (typeof client.id === 'number' || !String(client.id).startsWith('client-'));
            if (authToken && isPostgreSQLId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/crm/syp/coach/clients/${client.id}/advance-stage/`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            status: backendStatus
                        })
                    });

                    if (response.ok) {
                        const updatedClient = await response.json();
                        console.log('‚úÖ Client status updated in PostgreSQL:', updatedClient.programme_status);

                        // Refresh clients from API to get latest data
                        await renderClientList();
                        viewClientJourney(email);
                        alert(`‚úÖ ${client.name} advanced to ${WEEK_INFO[newStatus].label}`);
                        return;
                    } else {
                        console.error('Failed to update client status:', response.status);
                    }
                } catch (error) {
                    console.error('Error updating client status:', error);
                }
            }

            // Fallback to localStorage update (for default clients like Donald)
            console.log('üì¶ Updating client status in localStorage');
            clients[email].status = newStatus;
            if (newStatus === 'complete') {
                clients[email].completedDate = new Date().toISOString().split('T')[0];
            }
            saveStoredClients(clients);
            viewClientJourney(email);
            await renderClientList();
            alert(`‚úÖ ${client.name} advanced to ${WEEK_INFO[newStatus].label}`);
        }

        // Add new client - saves to PostgreSQL
        async function addNewClient() {
            const name = prompt('Client Name:');
            if (!name) return;

            const email = prompt('Client Email:');
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            const phone = prompt('Client Phone (optional):') || '';

            const clients = getStoredClientsSync();
            if (clients[email]) {
                alert('A client with this email already exists');
                return;
            }

            // If we have auth token, create via API
            if (authToken) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/crm/syp/coach/clients/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            full_name: name,
                            email: email,
                            phone: phone,
                            programme_status: 'enrolled',
                            enrolled_date: new Date().toISOString().split('T')[0]
                        })
                    });

                    if (response.ok) {
                        const newClient = await response.json();
                        console.log('‚úÖ Client created in PostgreSQL:', newClient.id);

                        // Refresh clients from API
                        await renderClientList();
                        alert(`‚úÖ ${name} added to PostgreSQL! You can now send them the questionnaire link.`);
                        return;
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        console.error('Failed to create client:', response.status, errorData);
                        alert(`Failed to create client: ${errorData.detail || errorData.email || 'Unknown error'}`);
                        return;
                    }
                } catch (error) {
                    console.error('Error creating client:', error);
                }
            }

            // Fallback to localStorage
            console.log('üì¶ Creating client in localStorage');
            const folderName = name.replace(/\s+/g, '_');

            clients[email] = {
                id: 'client-' + Date.now(),
                name: name,
                email: email,
                phone: phone,
                folder: folderName,
                status: 'pre-programme',
                enrolledDate: new Date().toISOString().split('T')[0],
                completedDate: null,
                progress: {
                    questionnaire: false,
                    insightsReport: false,
                    blueprint: false,
                    decisionFramework: false,
                    cvBuilder: false,
                    mappingGuide: false
                }
            };

            saveStoredClients(clients);
            await renderClientList();
            alert(`‚úÖ ${name} added locally! Connect to PostgreSQL to sync.`);
        }

        // Close journey view
        function closeJourneyView() {
            document.getElementById('journeyView').style.display = 'none';
        }

        // Delete client - removes from PostgreSQL and/or localStorage
        async function deleteClient(email, name) {
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete ${name}?\n\nThis will permanently remove them from the system.`)) {
                return;
            }

            const clients = getStoredClientsSync();
            const client = clients[email];
            if (!client) {
                alert('Client not found');
                return;
            }

            // If client has a PostgreSQL ID (not a local-only client), delete from API
            // Handle both numeric IDs from PostgreSQL and string IDs like 'client-xxx'
            const isPostgreSQLClient = authToken && client.id && (typeof client.id === 'number' || !String(client.id).startsWith('client-'));
            if (isPostgreSQLClient) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/crm/syp/coach/clients/${client.id}/`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Accept': 'application/json'
                        }
                    });

                    if (response.ok || response.status === 204) {
                        console.log('‚úÖ Client deleted from PostgreSQL:', email);
                    } else {
                        console.error('Failed to delete client from API:', response.status);
                        // Continue to remove from local cache anyway
                    }
                } catch (error) {
                    console.error('Error deleting client from API:', error);
                    // Continue to remove from local cache anyway
                }
            }

            // Remove from local storage/cache
            delete clients[email];
            saveStoredClients(clients);
            cachedClients = clients;

            // Close journey view if it was open for this client
            closeJourneyView();

            // Refresh the client list
            await renderClientList();

            alert(`‚úÖ ${name} has been deleted.`);
        }

        // Storage helpers - PostgreSQL via SparkHub API
        // SECURITY: Requires authentication to access client data
        async function getStoredClients() {
            console.log('üîç getStoredClients called');
            console.log('üîç authToken:', authToken ? 'present' : 'missing');
            console.log('üîç currentUser:', currentUser);
            console.log('üîç isStaff:', currentUser?.isStaff);

            // SECURITY: Must be authenticated to see any client data
            if (!authToken || !currentUser || !currentUser.isStaff) {
                console.warn('‚ö†Ô∏è Not authenticated or not staff - returning DEFAULT_CLIENTS only');
                updateDataSourceIndicator(false);
                // Still return DEFAULT_CLIENTS for authenticated coaches even if API unavailable
                return { ...DEFAULT_CLIENTS };
            }

            // Try to fetch from PostgreSQL API
            try {
                const response = await fetch(`${API_BASE_URL}/api/crm/syp/coach/clients/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    const apiClients = await response.json();
                    console.log('‚úÖ Fetched clients from PostgreSQL:', apiClients.length);

                    // Transform API response to frontend format
                    const clients = {};
                    apiClients.forEach(client => {
                        const frontendStatus = STATUS_MAP[client.programme_status] || 'pre-programme';
                        // Determine programme type from programme_type field (audhd, career, exec)
                        const programmeType = client.programme_type || 'career';
                        const isAuDHD = programmeType === 'audhd';
                        clients[client.email] = {
                            id: client.id,
                            name: client.full_name,
                            email: client.email,
                            phone: client.phone,
                            folder: client.full_name.replace(/\s+/g, '_'),
                            status: frontendStatus,
                            programme: isAuDHD ? 'audhd' : 'career',
                            programmeType: programmeType,
                            enrolledDate: client.enrolled_date,
                            session1Date: client.session_1_date,
                            session2Date: client.session_2_date,
                            session3Date: client.session_3_date,
                            completedDate: client.completed_date,
                            coachNotes: client.coach_notes,
                            agreementSigned: client.agreement_signed || false,
                            signedDocuments: client.signed_documents || [],
                            progress: {
                                questionnaire: client.ability_recognition !== null,
                                insightsReport: frontendStatus !== 'pre-programme',
                                blueprint: client.blueprint !== null,
                                decisionFramework: ['week-2', 'week-3', 'week-4', 'complete'].includes(frontendStatus),
                                cvBuilder: ['week-4', 'complete'].includes(frontendStatus),
                                mappingGuide: ['week-3', 'week-4', 'complete'].includes(frontendStatus)
                            }
                        };
                    });

                    // ALWAYS merge with DEFAULT_CLIENTS to ensure they're never lost
                    // API data overwrites defaults for duplicate emails, but defaults remain if no API match
                    const mergedClients = { ...DEFAULT_CLIENTS, ...clients };

                    // Cache merged data in localStorage for offline use (still requires auth to access)
                    localStorage.setItem('syp_clients', JSON.stringify(mergedClients));
                    cachedClients = mergedClients;

                    // Update data source indicator to show live
                    updateDataSourceIndicator(true);

                    return mergedClients;
                } else if (response.status === 401) {
                    console.warn('‚ö†Ô∏è Auth token expired, clearing session');
                    authToken = null;
                    localStorage.removeItem('syp_token');
                    // Still return DEFAULT_CLIENTS so UI doesn't break
                    console.log('üì¶ Returning DEFAULT_CLIENTS after 401');
                    return { ...DEFAULT_CLIENTS };
                } else {
                    console.warn('‚ö†Ô∏è API returned non-ok status:', response.status);
                }
            } catch (error) {
                console.error('Error fetching clients from API:', error);
            }

            // Fallback to cached data + defaults
            console.log('üì¶ Using cached clients from localStorage (offline mode)');
            updateDataSourceIndicator(false);

            let clients = { ...DEFAULT_CLIENTS };
            const stored = localStorage.getItem('syp_clients');
            if (stored) {
                try {
                    const storedClients = JSON.parse(stored);
                    // Merge stored on top of defaults
                    Object.keys(storedClients).forEach(email => {
                        clients[email] = { ...storedClients[email] };
                    });
                } catch (parseError) {
                    console.error('Error parsing cached clients:', parseError);
                }
            }

            // Final safety: ensure DEFAULT_CLIENTS are always present
            Object.keys(DEFAULT_CLIENTS).forEach(email => {
                if (!clients[email]) {
                    clients[email] = { ...DEFAULT_CLIENTS[email] };
                }
            });

            cachedClients = clients;
            console.log('üì¶ Returning clients from cache:', Object.keys(clients).length);
            return clients;
        }

        // Sync version for rendering (uses cache)
        // Returns cached clients or DEFAULT_CLIENTS as fallback
        function getStoredClientsSync() {
            // If we have a cache, use it
            if (cachedClients && Object.keys(cachedClients).length > 0) {
                return cachedClients;
            }

            // Start with default clients
            let clients = { ...DEFAULT_CLIENTS };

            // Merge with stored clients if available
            const stored = localStorage.getItem('syp_clients');
            if (stored) {
                try {
                    const storedClients = JSON.parse(stored);
                    Object.keys(storedClients).forEach(email => {
                        clients[email] = { ...storedClients[email] };
                    });
                } catch (e) {
                    console.error('Error parsing stored clients:', e);
                }
            }

            // Ensure DEFAULT_CLIENTS are always present
            Object.keys(DEFAULT_CLIENTS).forEach(email => {
                if (!clients[email]) {
                    clients[email] = { ...DEFAULT_CLIENTS[email] };
                }
            });

            return clients;
        }

        function saveStoredClients(clients) {
            // Always save to localStorage as cache
            localStorage.setItem('syp_clients', JSON.stringify(clients));
            cachedClients = clients;
        }

        // Client document openers (based on folder structure)
        function openClientQuestionnaire(email) {
            const clients = getStoredClientsSync();
            const client = clients[email];
            if (client.folder === 'Donald') {
                window.open('/donald-questionnaire', '_blank');
            } else if (client.folder === 'sarah_mitchell_demo_client') {
                window.open('sarah_mitchell_demo_client/Sarah_Mitchell_Questionnaire.html', '_blank');
            } else if (client.folder) {
                window.open(`${client.folder}/${client.folder}_Questionnaire_Responses.html`, '_blank');
            } else {
                window.open('ability-recognition-visual.html', '_blank');
            }
        }

        // Open PostgreSQL-backed questionnaire editor
        function openQuestionnaireEditor(clientId) {
            if (!clientId || clientId === 'undefined' || clientId === 'null') {
                alert('This client does not have a PostgreSQL ID yet. Please use the static View Responses option.');
                return;
            }
            window.open(`questionnaire-editor.html?client_id=${clientId}`, '_blank');
        }

        function openClientBlueprint(email) {
            const clients = getStoredClientsSync();
            const client = clients[email];
            if (client.folder === 'Donald') {
                window.open('Donald/Donald_Pirie_Career_Blueprint_LIVE.html', '_blank');
            } else if (client.folder === 'sarah_mitchell_demo_client') {
                window.open('sarah_mitchell_demo_client/Sarah_Mitchell_Blueprint.html', '_blank');
            } else if (client.folder) {
                window.open(`${client.folder}/${client.folder}_Career_Blueprint.html`, '_blank');
            }
        }

        function openClientInsights(email) {
            const clients = getStoredClientsSync();
            const client = clients[email];
            if (client.folder === 'Donald') {
                window.open('Donald/Donald_Pirie_Career_Insights_Report.html', '_blank');
            } else if (client.folder === 'sarah_mitchell_demo_client') {
                window.open('sarah_mitchell_demo_client/Sarah_Mitchell_Career_Insights_Report.html', '_blank');
            } else if (client.folder) {
                window.open(`${client.folder}/${client.folder}_Career_Insights_Report.html`, '_blank');
            }
        }

        function openClientDecision(email) {
            const clients = getStoredClientsSync();
            const client = clients[email];
            if (client.folder === 'Donald') {
                window.open('Donald/Donald_Decision_Framework_Updated_1.html', '_blank');
            } else if (client.folder === 'sarah_mitchell_demo_client') {
                window.open('sarah_mitchell_demo_client/Sarah_Mitchell_Decision_Framework.html', '_blank');
            } else if (client.folder) {
                window.open(`${client.folder}/${client.folder}_Decision_Framework.html`, '_blank');
            }
        }

        function openClientCV(email) {
            const clients = getStoredClientsSync();
            const client = clients[email];
            if (client.folder === 'Donald') {
                window.open('Donald/Donald_Interactive_CV_Builder.html', '_blank');
            } else if (client.folder === 'sarah_mitchell_demo_client') {
                window.open('sarah_mitchell_demo_client/Sarah_Mitchell_CV_Builder.html', '_blank');
            } else if (client.folder) {
                window.open(`${client.folder}/${client.folder}_CV_Builder.html`, '_blank');
            }
        }

        function openClientMapping(email) {
            const clients = getStoredClientsSync();
            const client = clients[email];
            if (client.folder === 'Donald') {
                window.open('Donald/Donald_Blueprint_CV_LinkedIn_Mapping_Guide_1.html', '_blank');
            } else if (client.folder === 'sarah_mitchell_demo_client') {
                window.open('sarah_mitchell_demo_client/Sarah_Mitchell_Mapping_Guide.html', '_blank');
            } else if (client.folder) {
                window.open(`${client.folder}/${client.folder}_Mapping_Guide.html`, '_blank');
            }
        }

        function openAllClientDocs(email) {
            const clients = getStoredClientsSync();
            const client = clients[email];
            if (client.folder) {
                // Open folder listing (in production, this would show a document list)
                alert(`Documents for ${client.name}:\n\n- Career Blueprint\n- Career Insights Report\n- Decision Framework\n- CV Builder\n- Mapping Guide\n- AI Prompt Library`);
            }
        }

        // ============================================================
        // ADMIN TOOLS FUNCTIONS
        // ============================================================

        // Toggle admin tools panel visibility
        function toggleAdminTools() {
            const panel = document.getElementById('adminToolsPanel');
            const toggle = document.getElementById('adminToolsToggle');

            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                toggle.innerHTML = 'üîê Admin Tools ‚ñ≤';
            } else {
                panel.style.display = 'none';
                toggle.innerHTML = 'üîê Admin Tools ‚ñº';
            }
        }

        // Generate random password
        function generatePassword() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            let password = '';
            for (let i = 0; i < 8; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return password;
        }

        // Create client account with password
        async function createClientAccount() {
            const name = document.getElementById('adminClientName').value.trim();
            const email = document.getElementById('adminClientEmail').value.trim();
            let password = document.getElementById('adminClientPassword').value || generatePassword();
            const programmeAccess = document.getElementById('adminProgrammeAccess').value;
            const messageEl = document.getElementById('createAccountMessage');

            // Validation
            if (!name) {
                showMessage(messageEl, 'Please enter a client name', 'error');
                return;
            }
            if (!email || !email.includes('@')) {
                showMessage(messageEl, 'Please enter a valid email', 'error');
                return;
            }

            try {
                // Create user account via SYP server's own API (NOT SparkHub - no beta codes needed)
                const SYP_SERVER = window.location.origin;
                const response = await fetch(`${SYP_SERVER}/api/admin/create-client`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        name: name,
                        password: password,
                        programmeAccess: programmeAccess,
                        adminKey: 'spark-admin-2025'
                    })
                });

                if (response.ok) {
                    const data = await response.json();

                    // Also add to SYP client list in SparkHub CRM
                    await addClientToSYP(name, email);

                    // Programme access labels
                    const accessLabels = {
                        'career': 'üíº Career Booster',
                        'audhd': 'üß† ND Coaching',
                        'both': '‚ú® Both Programmes'
                    };

                    showMessage(messageEl, `
                        <strong>‚úì Account created!</strong><br>
                        <strong>Name:</strong> ${name}<br>
                        <strong>Email:</strong> ${email}<br>
                        <strong>Password:</strong> <code style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px;">${password}</code><br>
                        <strong>Access:</strong> ${accessLabels[programmeAccess] || programmeAccess}<br>
                        <strong>Login URL:</strong> <a href="login.html" target="_blank">login.html</a><br>
                        <em style="font-size: 0.85em;">Share these credentials with your client.</em>
                    `, 'success');

                    // Clear form
                    document.getElementById('adminClientName').value = '';
                    document.getElementById('adminClientEmail').value = '';
                    document.getElementById('adminClientPassword').value = '';
                    document.getElementById('adminProgrammeAccess').value = 'career';

                    // Refresh client list
                    await renderClientList();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessage(messageEl, `Error: ${errorData.error || 'Could not create account'}`, 'error');
                }
            } catch (error) {
                console.error('Create account error:', error);
                showMessage(messageEl, 'Could not connect to server. Try again later.', 'error');
            }
        }

        // Add client to SYP system (separate from user account)
        async function addClientToSYP(name, email) {
            try {
                await fetch(`${API_BASE_URL}/api/crm/syp/coach/clients/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        full_name: name,
                        email: email,
                        programme_status: 'enrolled',
                        enrolled_date: new Date().toISOString().split('T')[0]
                    })
                });
            } catch (error) {
                console.log('Could not add to SYP client list:', error);
            }
        }

        // Reset client password
        async function resetClientPassword() {
            const email = document.getElementById('resetClientEmail').value.trim();
            let password = document.getElementById('resetClientPassword').value || generatePassword();
            const messageEl = document.getElementById('resetPasswordMessage');

            if (!email || !email.includes('@')) {
                showMessage(messageEl, 'Please enter a valid email', 'error');
                return;
            }

            try {
                // Reset password via SparkHub API
                const response = await fetch(`${API_BASE_URL}/api/accounts/admin/reset-password/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        email: email,
                        new_password: password
                    })
                });

                if (response.ok) {
                    showMessage(messageEl, `
                        <strong>‚úì Password reset!</strong><br>
                        <strong>Email:</strong> ${email}<br>
                        <strong>New Password:</strong> <code style="background: #e0e0e0; padding: 2px 6px; border-radius: 3px;">${password}</code><br>
                        <em style="font-size: 0.85em;">Share the new password with your client.</em>
                    `, 'success');

                    // Clear form
                    document.getElementById('resetClientEmail').value = '';
                    document.getElementById('resetClientPassword').value = '';
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessage(messageEl, `Error: ${errorData.detail || errorData.error || 'Could not reset password'}`, 'error');
                }
            } catch (error) {
                console.error('Reset password error:', error);
                showMessage(messageEl, 'Could not connect to server. Try again later.', 'error');
            }
        }

        // Helper to show messages
        function showMessage(element, message, type) {
            element.innerHTML = message;
            element.style.display = 'block';
            element.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
            element.style.color = type === 'success' ? '#155724' : '#721c24';
        }

        // ============================================================
        // AUDHD CLIENT FUNCTIONS
        // ============================================================

        // Current filter state
        let currentFilter = 'all';

        // AuDHD programme info
        const AUDHD_PROGRAMME_INFO = {
            4: { name: 'Foundations', sessions: 4 },
            8: { name: 'Deep Dive', sessions: 8 },
            12: { name: 'Transformation', sessions: 12 }
        };

        // AuDHD session statuses
        const AUDHD_SESSION_INFO = {
            'session-1': { label: 'Session 1', description: 'Foundations' },
            'session-2': { label: 'Session 2', description: 'Communication' },
            'session-3': { label: 'Session 3', description: 'Energy' },
            'session-4': { label: 'Session 4', description: 'Emotional' },
            'session-5': { label: 'Session 5', description: 'Processing' },
            'session-6': { label: 'Session 6', description: 'Relationships' },
            'session-7': { label: 'Session 7', description: 'Daily Rhythms' },
            'session-8': { label: 'Session 8', description: 'Integration' },
            'session-9': { label: 'Session 9', description: 'Relationship Needs' },
            'session-10': { label: 'Session 10', description: 'Support Systems' },
            'session-11': { label: 'Session 11', description: 'Daily Rhythms' },
            'session-12': { label: 'Session 12', description: 'Integration' },
            'complete': { label: 'Complete', description: 'Programme Finished' }
        };

        // Default AuDHD clients (localStorage)
        const DEFAULT_AUDHD_CLIENTS = {};

        // Add new AuDHD client
        async function addAuDHDClient() {
            const name = prompt('Client Name:');
            if (!name) return;

            const email = prompt('Client Email:');
            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            const programmeChoice = prompt('Programme length:\n1 = Foundations (4 sessions)\n2 = Deep Dive (8 sessions)\n3 = Transformation (12 sessions)\n\nEnter 1, 2, or 3:');
            let programmeLength = 8; // default
            if (programmeChoice === '1') programmeLength = 4;
            else if (programmeChoice === '3') programmeLength = 12;

            // Check if client already exists
            const existingClients = getStoredClientsSync();
            if (existingClients[email]) {
                alert('A client with this email already exists');
                return;
            }

            // Try to save to PostgreSQL API first
            if (authToken) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/crm/syp/coach/clients/`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            full_name: name,
                            email: email,
                            programme_type: 'audhd',
                            programme_status: 'discovery',
                            enrolled_date: new Date().toISOString().split('T')[0]
                        })
                    });

                    if (response.ok) {
                        const newClient = await response.json();
                        console.log('‚úÖ AuDHD client saved to PostgreSQL:', newClient);
                        await renderClientList();
                        alert(`‚úÖ ${name} added to AuDHD Coaching programme!`);
                        return;
                    } else {
                        console.warn('Failed to save to API, falling back to localStorage');
                    }
                } catch (error) {
                    console.error('Error saving AuDHD client to API:', error);
                }
            }

            // Fallback to localStorage
            let audhdClients = JSON.parse(localStorage.getItem('audhd_clients') || '{}');
            audhdClients[email] = {
                id: 'audhd-' + Date.now(),
                name: name,
                email: email,
                programmeType: 'audhd',
                programmeLength: programmeLength,
                status: 'pre-programme',
                enrolledDate: new Date().toISOString().split('T')[0],
                completedDate: null,
                agreementSigned: false,
                notes: ''
            };

            localStorage.setItem('audhd_clients', JSON.stringify(audhdClients));
            await renderClientList();
            alert(`‚úÖ ${name} added to AuDHD Coaching programme (offline mode)!`);
        }

        // Filter clients by programme type
        function filterClients(filter) {
            currentFilter = filter;

            // Update button styles
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.style.background = 'rgba(255,255,255,0.1)';
                btn.style.borderColor = 'rgba(255,255,255,0.3)';
            });

            const activeBtn = document.getElementById('filter' + filter.charAt(0).toUpperCase() + filter.slice(1));
            if (activeBtn) {
                activeBtn.style.background = 'rgba(255,255,255,0.3)';
                activeBtn.style.borderColor = 'rgba(255,255,255,0.5)';
            }

            renderClientList();
        }

        // Get all clients (career + AuDHD) - override the original renderClientList
        const originalRenderClientList = renderClientList;
        renderClientList = async function() {
            const container = document.getElementById('clientList');
            container.innerHTML = '<div style="color: white; text-align: center; padding: 20px;">Loading clients...</div>';

            // Get career clients
            let careerClients = { ...DEFAULT_CLIENTS };
            try {
                const apiClients = await getStoredClients();
                if (Object.keys(apiClients).length > 0) {
                    careerClients = { ...DEFAULT_CLIENTS, ...apiClients };
                }
            } catch (error) {
                console.log('Using DEFAULT_CLIENTS only');
            }

            // Mark career clients
            Object.values(careerClients).forEach(c => c.programme = c.programme || 'career');

            // Get AuDHD clients from localStorage
            let audhdClients = JSON.parse(localStorage.getItem('audhd_clients') || '{}');

            // Combine all clients
            let allClients = { ...careerClients };
            Object.keys(audhdClients).forEach(email => {
                allClients[email] = audhdClients[email];
            });

            // Filter based on current filter
            let filteredClients = Object.values(allClients);
            if (currentFilter === 'career') {
                filteredClients = filteredClients.filter(c => c.programme !== 'audhd');
            } else if (currentFilter === 'audhd') {
                filteredClients = filteredClients.filter(c => c.programme === 'audhd');
            }

            if (filteredClients.length === 0) {
                container.innerHTML = `
                    <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 30px; text-align: center; grid-column: 1 / -1;">
                        <div style="font-size: 2em; margin-bottom: 15px;">üëã</div>
                        <h4 style="color: #333; margin-bottom: 10px;">No ${currentFilter === 'all' ? '' : currentFilter + ' '}clients yet</h4>
                        <p style="color: #666; margin-bottom: 20px;">Click the appropriate "+ Add" button to add your first client.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredClients.map(client => {
                const isAuDHD = client.programme === 'audhd';
                const statusInfo = isAuDHD ? AUDHD_SESSION_INFO[client.status] : WEEK_INFO[client.status];
                const statusLabel = statusInfo?.label || client.status;
                const statusDesc = statusInfo?.description || '';

                // Calculate progress
                let progress = 0;
                if (isAuDHD) {
                    const currentSession = client.currentSession || 1;
                    const totalSessions = client.programmeLength || 8;
                    progress = Math.round((currentSession / totalSessions) * 100);
                } else {
                    progress = getProgressPercentage(client.status);
                }

                const colour = isAuDHD ? '#8B5CF6' : getStatusColour(client.status);
                const programmeBadge = isAuDHD
                    ? `<span style="font-size: 0.7em; background: #8B5CF6; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">üß† AuDHD ${client.programmeLength || 8}s</span>`
                    : `<span style="font-size: 0.7em; background: #FF6B35; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">‚ö° Career</span>`;

                return `
                    <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px; cursor: pointer; position: relative; ${client.isDemo ? 'border: 2px dashed #ffc107;' : ''}" onclick="${isAuDHD ? `viewAuDHDClient('${client.email}')` : `viewClientJourney('${client.email}')`}">
                        <button onclick="event.stopPropagation(); deleteClient('${client.email}', '${client.name}')"
                                style="position: absolute; top: 10px; right: 10px; background: rgba(220, 53, 69, 0.1); border: none; border-radius: 6px; padding: 5px 8px; cursor: pointer; font-size: 0.85em; color: #dc3545; transition: all 0.2s;"
                                onmouseover="this.style.background='rgba(220, 53, 69, 0.2)'"
                                onmouseout="this.style.background='rgba(220, 53, 69, 0.1)'"
                                title="Delete client">
                            üóëÔ∏è
                        </button>
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; padding-right: 35px;">
                            <h4 style="color: #333; margin: 0;">
                                ${client.name}
                                ${programmeBadge}
                                ${client.isDemo ? '<span style="font-size: 0.7em; background: #ffc107; color: #333; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">DEMO</span>' : ''}
                            </h4>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <span style="background: ${colour}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.75em;">
                                ${statusLabel}
                            </span>
                        </div>
                        <p style="color: #666; font-size: 0.85em; margin-bottom: 8px;">${client.email}</p>
                        <p style="color: #888; font-size: 0.8em;">
                            ${isAuDHD ? 'üß†' : (WEEK_INFO[client.status]?.icon || 'üìã')} ${statusDesc}
                        </p>
                        <div style="margin-top: 10px; height: 4px; background: #e0e0e0; border-radius: 2px;">
                            <div style="height: 100%; width: ${progress}%; background: ${colour}; border-radius: 2px;"></div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        // View AuDHD client (opens their portal)
        function viewAuDHDClient(email) {
            // Store selected client for the portal
            localStorage.setItem('viewing_audhd_client', email);
            window.open('audhd-dashboard.html?client=' + encodeURIComponent(email), '_blank');
        }

        // Override delete to handle AuDHD clients too
        const originalDeleteClient = deleteClient;
        deleteClient = async function(email, name) {
            if (!confirm(`Are you sure you want to delete ${name}?\n\nThis will permanently remove them from the system.`)) {
                return;
            }

            // Check if AuDHD client
            let audhdClients = JSON.parse(localStorage.getItem('audhd_clients') || '{}');
            if (audhdClients[email]) {
                delete audhdClients[email];
                localStorage.setItem('audhd_clients', JSON.stringify(audhdClients));
                await renderClientList();
                alert(`‚úÖ ${name} has been deleted.`);
                return;
            }

            // Otherwise use original delete for career clients
            await originalDeleteClient(email, name);
        };
    </script>
</body>
</html>
