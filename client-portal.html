<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Career Toolkit - Spark Your Potential</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #fff;
        }
        .container { max-width: 1000px; margin: 0 auto; }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.2em;
            font-weight: 800;
            margin-bottom: 8px;
            color: #fff;
        }
        .header h1 span { color: #FFB627; }
        .header .subtitle {
            font-size: 1em;
            color: #aaa;
            margin-bottom: 8px;
        }
        .header .welcome {
            font-size: 1.1em;
            color: #4ECDC4;
            font-weight: 600;
        }

        /* Stats Bar */
        .stats-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .stat-item .stat-value {
            font-size: 1.8em;
            font-weight: 800;
            color: #FFB627;
        }
        .stat-item .stat-label {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 4px;
        }

        /* Login Section */
        .login-section {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 450px;
            margin: 60px auto;
        }
        .login-section h2 {
            color: #1a1a2e;
            margin-bottom: 10px;
            font-size: 1.5em;
        }
        .login-section p {
            color: #666;
            margin-bottom: 25px;
        }
        .email-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 15px;
            font-family: inherit;
        }
        .email-input:focus {
            outline: none;
            border-color: #4ECDC4;
        }
        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(78, 205, 196, 0.4);
        }
        .login-error {
            background: #ffe0e0;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            font-size: 0.9em;
        }

        /* Portal Content */
        .portal-content {
            display: none;
        }
        .portal-content.visible {
            display: block;
        }

        /* ============================================
           TRANSFORMATION JOURNEY - 3-Step Flow
           ============================================ */
        .transformation-section {
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }
        .transformation-header {
            text-align: center;
            margin-bottom: 25px;
        }
        .transformation-header h2 {
            color: #fff;
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .transformation-header p {
            color: #aaa;
            font-size: 0.95em;
        }

        /* 3-Step Flow Container */
        .transformation-flow {
            display: flex;
            align-items: stretch;
            gap: 0;
            position: relative;
        }

        /* Step Card */
        .step-card {
            flex: 1;
            background: rgba(255,255,255,0.95);
            border-radius: 16px;
            padding: 25px 20px;
            text-align: center;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid transparent;
        }
        .step-card:hover:not(.locked) {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        /* Step Number Badge */
        .step-number {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.85em;
            color: white;
        }
        .step-1 .step-number { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .step-2 .step-number { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .step-3 .step-number { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }

        /* Step States */
        .step-card.completed {
            border-color: #4ECDC4;
        }
        .step-card.completed .step-number {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
        }
        .step-card.current {
            border-color: #FFB627;
            box-shadow: 0 0 20px rgba(255, 182, 39, 0.3);
        }
        .step-card.current .step-number {
            background: linear-gradient(135deg, #FFB627 0%, #FF6B35 100%);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 182, 39, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(255, 182, 39, 0); }
        }
        .step-card.locked {
            opacity: 0.4;
            filter: grayscale(60%);
        }

        /* Arrow Connectors */
        .step-arrow {
            display: flex;
            align-items: center;
            padding: 0 8px;
            color: rgba(255,255,255,0.4);
            font-size: 1.8em;
        }
        .step-arrow.active {
            color: #4ECDC4;
        }

        /* Step Content */
        .step-icon {
            font-size: 2.5em;
            margin: 15px 0 12px 0;
        }
        .step-label {
            font-size: 0.7em;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            margin-bottom: 6px;
        }
        .step-title {
            font-size: 1.05em;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 10px;
        }
        .step-description {
            font-size: 0.8em;
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        .step-btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .step-1 .step-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .step-2 .step-btn { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .step-3 .step-btn { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .step-card.completed .step-btn { background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%); }
        .step-card.locked .step-btn { background: #ccc; cursor: not-allowed; }

        /* Responsive */
        @media (max-width: 700px) {
            .transformation-flow {
                flex-direction: column;
                gap: 20px;
            }
            .step-arrow {
                transform: rotate(90deg);
                padding: 5px 0;
                justify-content: center;
            }
        }

        /* ============================================
           SUPPORTING TOOLS GRID
           ============================================ */
        .tools-section {
            margin-top: 20px;
        }
        .tools-section-header {
            color: #fff;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding-left: 5px;
        }
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 800px) {
            .tools-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 550px) {
            .tools-grid { grid-template-columns: 1fr; }
        }

        /* Tool Card */
        .tool-card {
            background: rgba(255,255,255,0.95);
            border-radius: 16px;
            padding: 25px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 3px solid transparent;
        }
        .tool-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .tool-card.completed {
            border-color: #4ECDC4;
        }
        .tool-card.locked {
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(50%);
        }
        .tool-card .tool-icon {
            font-size: 2.2em;
            margin-bottom: 12px;
        }
        .tool-card h3 {
            color: #1a1a2e;
            font-size: 1.1em;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .tool-card .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .status-completed {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status-ready {
            background: #fff3e0;
            color: #e65100;
        }
        .status-locked {
            background: #f5f5f5;
            color: #999;
        }
        .status-reference {
            background: #e3f2fd;
            color: #1565c0;
        }
        .tool-card p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        .tool-card .tool-btn {
            display: inline-block;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 600;
            transition: transform 0.2s;
            border: none;
            cursor: pointer;
        }
        .tool-card .tool-btn:hover {
            transform: translateY(-1px);
        }
        .tool-card .tool-btn.secondary {
            background: #e0e0e0;
            color: #555;
            margin-left: 8px;
        }
        .tool-card.locked .tool-btn {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Journey Section */
        .journey-section {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }
        .journey-section h3 {
            color: #fff;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        .journey-steps {
            display: flex;
            gap: 10px;
        }
        .journey-step {
            flex: 1;
            text-align: center;
            padding: 15px 8px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
        }
        .journey-step.completed {
            background: rgba(78, 205, 196, 0.2);
            border-color: #4ECDC4;
        }
        .journey-step.current {
            background: rgba(255, 182, 39, 0.2);
            border-color: #FFB627;
        }
        .journey-step.locked {
            opacity: 0.4;
        }
        .journey-step .icon {
            font-size: 1.5em;
            margin-bottom: 6px;
        }
        .journey-step .label {
            font-size: 0.75em;
            color: #fff;
            font-weight: 500;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #aaa;
        }
        .footer a {
            color: #4ECDC4;
            text-decoration: none;
        }
        .logout-link {
            display: inline-block;
            margin-top: 15px;
            color: #888;
            cursor: pointer;
            font-size: 0.9em;
        }
        .logout-link:hover {
            color: #fff;
        }

        /* Agreement Section */
        .agreement-section {
            display: none;
            background: rgba(255,255,255,0.98);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto 30px auto;
            color: #333;
        }
        .agreement-section.visible {
            display: block;
        }
        .agreement-section h2 {
            color: #1a1a2e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .agreement-section .intro {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        .agreement-content {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9em;
            line-height: 1.7;
        }
        .agreement-content h3 {
            color: #4ECDC4;
            font-size: 1.1em;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #4ECDC4;
        }
        .agreement-content h3:first-child {
            margin-top: 0;
        }
        .agreement-content ul {
            margin: 10px 0 10px 20px;
        }
        .agreement-content li {
            margin-bottom: 8px;
        }
        .programme-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .programme-box h4 {
            margin-bottom: 10px;
        }
        .signature-section {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .signature-section h4 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        .checkbox-field {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .checkbox-field input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
        }
        .checkbox-field label {
            font-size: 0.9em;
            cursor: pointer;
            color: #333;
        }
        .signature-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Brush Script MT', cursive;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 15px;
        }
        .signature-input:focus {
            outline: none;
            border-color: #4ECDC4;
        }
        .signature-canvas-container {
            position: relative;
            margin-bottom: 15px;
        }
        .signature-canvas {
            width: 100%;
            height: 100px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            background: #fafafa;
            cursor: crosshair;
        }
        .clear-signature {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
        }
        .sign-btn {
            width: 100%;
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .sign-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(78, 205, 196, 0.4);
        }
        .sign-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .sign-btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Section -->
        <div class="login-section" id="loginSection">
            <h2>‚ö° Your Career Toolkit</h2>
            <p>Enter your email to access your documents</p>
            <div class="login-error" id="loginError"></div>
            <input type="email" class="email-input" id="emailInput" placeholder="your@email.com" onkeypress="if(event.key==='Enter') clientLogin()">
            <button class="login-btn" onclick="clientLogin()">Access My Toolkit</button>
        </div>

        <!-- Agreement Section (shown if not signed) -->
        <div class="agreement-section" id="agreementSection">
            <h2>üìã Coaching Agreement</h2>
            <p class="intro">Welcome, <span id="agreementClientName"></span>! Before we begin your Career Booster journey, please review and sign the coaching agreement below.</p>

            <div class="agreement-content">
                <h3>1. What Coaching Is (and Isn't)</h3>
                <p>Coaching is a collaborative process designed to help you develop insight, build strategies, and make meaningful change. I'll ask questions, share tools, and offer structure ‚Äî but ultimately, you're responsible for what you take from it and how you use it.</p>
                <p><strong>This is not therapy or medical advice.</strong> I don't diagnose or treat mental health conditions. If you feel you need therapeutic or clinical support, I'll help signpost you to it ‚Äî but it's outside the scope of this coaching.</p>

                <h3>2. Programme & Services</h3>
                <div class="programme-box">
                    <h4>4-Week Career Booster Programme - ¬£400 ex VAT (¬£480 inc VAT)</h4>
                    <ul>
                        <li>4 x 1-hour sessions over 4 weeks</li>
                        <li>Focus on the AI tool, report, and core narrative</li>
                        <li>Key deliverables: report, CV content framework, positioning statement</li>
                        <li>Email support between sessions (response within 48 hours on working days)</li>
                        <li>Access to proprietary AI questionnaire tool</li>
                    </ul>
                </div>
                <p>Sessions will take place online (Zoom) at mutually agreed times.</p>

                <h3>3. Cancellation & Rescheduling</h3>
                <ul>
                    <li>If you're more than 15 minutes late or miss a session without 24 hours' notice, the session may be forfeited unless it's an emergency</li>
                    <li>I'll always do my best to be flexible where possible</li>
                    <li>If I need to reschedule, I'll give as much notice as I can (ideally 24 hours)</li>
                </ul>

                <h3>4. Payment Terms</h3>
                <p>The full fee is <strong>¬£480 inc VAT (¬£400 ex VAT)</strong>. Payment is required prior to the first session.</p>

                <h3>5. Confidentiality</h3>
                <p>Everything shared in sessions is confidential. I operate within the spirit of the ICF Code of Ethics.</p>
                <p><strong>Exceptions:</strong> If I'm concerned about your safety or someone else's, or if you give permission for me to discuss something (e.g., with Access to Work or an employer).</p>

                <h3>6. Intellectual Property</h3>
                <p>The AI questionnaire tool, methodology, frameworks, and materials remain my intellectual property. The content you create (your career narrative, CV content, etc.) is yours to use as you wish.</p>

                <h3>7. Liability</h3>
                <p>You're responsible for your own actions, choices, and results from coaching. I'm not liable for any outcomes, decisions, or impacts of the coaching process.</p>
            </div>

            <div class="signature-section">
                <h4>Your Signature</h4>

                <div class="checkbox-field">
                    <input type="checkbox" id="agreeTerms">
                    <label for="agreeTerms">I have read and agree to the terms of this Coaching Agreement</label>
                </div>

                <div class="checkbox-field">
                    <input type="checkbox" id="agreeRecording">
                    <label for="agreeRecording">I consent to sessions being recorded for training/accreditation purposes (optional)</label>
                </div>

                <p style="font-size: 0.85em; color: #666; margin-bottom: 10px;">Type your name or draw your signature below:</p>
                <input type="text" class="signature-input" id="signatureInput" placeholder="Type your full name">

                <div class="signature-canvas-container">
                    <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                    <button type="button" class="clear-signature" onclick="clearSignature()">Clear</button>
                </div>

                <button class="sign-btn" id="signBtn" onclick="submitAgreement()" disabled>
                    ‚úçÔ∏è Sign & Continue to Toolkit
                </button>
            </div>
        </div>

        <!-- Portal Content -->
        <div class="portal-content" id="portalContent">
            <!-- Header -->
            <div class="header">
                <h1><span>‚ö°</span> Your Career Toolkit</h1>
                <p class="subtitle">Spark Your Potential</p>
                <p class="welcome">Welcome, <span id="clientName"></span></p>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="statBlueprints">0</div>
                    <div class="stat-label">Blueprints</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statTools">0/6</div>
                    <div class="stat-label">Tools Used</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="statDate">-</div>
                    <div class="stat-label">Last Updated</div>
                </div>
            </div>

            <!-- Journey Timeline -->
            <div class="journey-section">
                <h3>üìÖ Your Journey</h3>
                <div class="journey-steps" id="journeySteps"></div>
            </div>

            <!-- Transformation Journey - 3-Step Flow -->
            <div class="transformation-section">
                <div class="transformation-header">
                    <h2>üöÄ Your Transformation Journey</h2>
                    <p>Three steps from self-discovery to career clarity</p>
                </div>
                <div class="transformation-flow" id="transformationFlow">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Supporting Tools -->
            <div class="tools-section">
                <h3 class="tools-section-header">üß∞ Your Career Tools</h3>
                <div class="tools-grid" id="toolsGrid"></div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p>Need help? Contact Lisa: <a href="mailto:lisa@harnessthespark.com">lisa@harnessthespark.com</a></p>
                <p class="logout-link" onclick="logout()">Log Out</p>
            </div>
        </div>
    </div>

    <script>
        // Client data with specific file paths
        const CLIENTS = {
            'sarah.mitchell@example.com': {
                name: 'Sarah Mitchell',
                email: 'sarah.mitchell@example.com',
                folder: 'sarah_mitchell_demo_client',
                status: 'week-2',
                isDemo: true,
                agreementSigned: true,
                files: {
                    questionnaire: 'ability-recognition-visual.html',
                    insights: 'sarah_mitchell_demo_client/Sarah_Mitchell_Career_Insights_Report.html',
                    blueprint: 'sarah_mitchell_demo_client/Sarah_Mitchell_Blueprint.html',
                    cvBuilder: 'sarah_mitchell_demo_client/Sarah_Mitchell_CV_Builder.html',
                    mappingGuide: 'sarah_mitchell_demo_client/Sarah_Mitchell_Mapping_Guide.html',
                    decisionFramework: 'sarah_mitchell_demo_client/Sarah_Mitchell_Decision_Framework.html'
                }
            },
            'donaldpirie111@hotmail.co.uk': {
                name: 'Donald Pirie',
                email: 'donaldpirie111@hotmail.co.uk',
                folder: 'Donald',
                status: 'complete',
                agreementSigned: true,
                files: {
                    questionnaire: 'Donald/donald-questionnaire-responses.html',
                    insights: 'Donald/Donald_Pirie_Career_Insights_Report.html',
                    blueprint: 'Donald/Donald_Pirie_Career_Blueprint_LIVE.html',
                    cvBuilder: 'Donald/Donald_Interactive_CV_Builder.html',
                    mappingGuide: 'Donald/Donald_Blueprint_CV_LinkedIn_Mapping_Guide.html',
                    decisionFramework: 'Donald/Donald_Decision_Framework_Updated.html'
                }
            },
            'rs@rajsamuel.net': {
                name: 'Raj Samuel',
                email: 'rs@rajsamuel.net',
                folder: 'Raj_Samuel',
                status: 'pre-programme',
                agreementSigned: true,
                files: {
                    questionnaire: 'Raj_Samuel/Raj_Samuel_Discovery_Questionnaire.html',
                    insights: 'Raj_Samuel/Raj_Samuel_Career_Insights_Report.html',
                    blueprint: 'Raj_Samuel/Raj_Samuel_Blueprint.html',
                    cvBuilder: 'Raj_Samuel/Raj_Samuel_CV_Builder.html',
                    mappingGuide: 'Raj_Samuel/Raj_Samuel_Mapping_Guide.html',
                    decisionFramework: 'Raj_Samuel/Raj_Samuel_Decision_Framework.html'
                }
            }
        };

        const STAGES = [
            { id: 'pre-programme', label: 'Pre-Programme', icon: 'üìã' },
            { id: 'week-1', label: 'Week 1', icon: 'üå±' },
            { id: 'week-2', label: 'Week 2', icon: 'üß≠' },
            { id: 'week-3', label: 'Week 3', icon: 'üéØ' },
            { id: 'week-4', label: 'Week 4', icon: 'üöÄ' },
            { id: 'complete', label: 'Complete', icon: 'üèÜ' }
        ];

        let currentClient = null;

        // Check for saved session
        window.onload = function() {
            const savedEmail = localStorage.getItem('syp_client_email');
            if (savedEmail && CLIENTS[savedEmail.toLowerCase()]) {
                showPortal(CLIENTS[savedEmail.toLowerCase()]);
            }
        };

        // Client login
        function clientLogin() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            const errorEl = document.getElementById('loginError');

            if (!email) {
                errorEl.textContent = 'Please enter your email address';
                errorEl.style.display = 'block';
                return;
            }

            const client = CLIENTS[email];
            if (!client) {
                errorEl.textContent = 'Email not found. Please check your email or contact Lisa.';
                errorEl.style.display = 'block';
                return;
            }

            localStorage.setItem('syp_client_email', email);
            showPortal(client);
        }

        // Show portal
        function showPortal(client) {
            currentClient = client;
            document.getElementById('loginSection').style.display = 'none';

            // Check if agreement is signed
            if (!hasSignedAgreement(client)) {
                // Show agreement section
                document.getElementById('agreementSection').classList.add('visible');
                document.getElementById('portalContent').classList.remove('visible');

                // Set client name in agreement
                document.getElementById('agreementClientName').textContent = client.name;

                // Setup agreement form
                setupAgreementForm();
                return;
            }

            // Agreement signed - show toolkit
            document.getElementById('agreementSection').classList.remove('visible');
            document.getElementById('portalContent').classList.add('visible');

            // Update header
            document.getElementById('clientName').textContent = client.name.split(' ')[0];

            // Calculate stats
            const stageIndex = STAGES.findIndex(s => s.id === client.status);
            const toolsUnlocked = getToolsUnlocked(stageIndex);

            document.getElementById('statBlueprints').textContent = stageIndex >= 2 ? '1' : '0';
            document.getElementById('statTools').textContent = `${toolsUnlocked}/6`;
            document.getElementById('statDate').textContent = new Date().toLocaleDateString('en-GB');

            // Render journey
            renderJourney(client);

            // Render transformation flow (3-step journey)
            renderTransformationJourney(client);

            // Render supporting tools
            renderTools(client);
        }

        function getToolsUnlocked(stageIndex) {
            if (stageIndex >= 5) return 6; // complete
            if (stageIndex >= 3) return 6; // week-3+
            if (stageIndex >= 2) return 4; // week-2
            if (stageIndex >= 1) return 3; // week-1
            return 2; // pre-programme
        }

        // Render journey timeline
        function renderJourney(client) {
            const container = document.getElementById('journeySteps');
            const currentIndex = STAGES.findIndex(s => s.id === client.status);

            container.innerHTML = STAGES.map((stage, index) => {
                let className = 'journey-step';
                let icon = stage.icon;

                if (index < currentIndex || client.status === 'complete') {
                    className += ' completed';
                    icon = '‚úÖ';
                } else if (index === currentIndex) {
                    className += ' current';
                } else {
                    className += ' locked';
                }

                return `
                    <div class="${className}">
                        <div class="icon">${icon}</div>
                        <div class="label">${stage.label}</div>
                    </div>
                `;
            }).join('');
        }

        // Render transformation journey (3-step flow)
        function renderTransformationJourney(client) {
            const container = document.getElementById('transformationFlow');
            const stageIndex = STAGES.findIndex(s => s.id === client.status);
            const folder = client.folder;
            const nameUnderscored = client.name.replace(/\s+/g, '_');
            const files = client.files || {};

            // Determine step states based on programme stage
            // Step 1 (Questionnaire): Available from pre-programme
            // Step 2 (Insights): Available from week-1
            // Step 3 (Blueprint): Available from week-1, built through sessions

            const steps = [
                {
                    num: 1,
                    label: 'Step 1',
                    title: 'Discovery',
                    subtitle: 'Questionnaire',
                    icon: 'üîç',
                    description: 'Deep reflection on your patterns, superpowers, and career journey. Your answers fuel everything that follows.',
                    file: files.questionnaire || 'ability-recognition-visual.html',
                    btnText: stageIndex >= 1 ? 'View Responses' : 'Start Questionnaire',
                    unlockStage: 0
                },
                {
                    num: 2,
                    label: 'Step 2',
                    title: 'Insights',
                    subtitle: 'Career Report',
                    icon: 'üí°',
                    description: "Lisa's expert analysis of your responses. Uncover your core pattern, unique thread, and career direction.",
                    file: files.insights || `${folder}/${nameUnderscored}_Career_Insights_Report.html`,
                    btnText: 'View Report',
                    unlockStage: 1
                },
                {
                    num: 3,
                    label: 'Step 3',
                    title: 'Blueprint',
                    subtitle: 'Your Positioning',
                    icon: 'üéØ',
                    description: 'Your complete positioning document built through coaching. Evidence, belief moments, and your unique thread.',
                    file: files.blueprint || `${folder}/${nameUnderscored}_Blueprint.html`,
                    btnText: 'View Blueprint',
                    unlockStage: 1
                }
            ];

            container.innerHTML = steps.map((step, index) => {
                const isUnlocked = stageIndex >= step.unlockStage || client.status === 'complete';
                const isComplete = stageIndex > step.unlockStage || client.status === 'complete';
                const isCurrent = stageIndex === step.unlockStage && !isComplete;

                let cardClass = `step-card step-${step.num}`;
                if (isComplete) cardClass += ' completed';
                else if (isCurrent) cardClass += ' current';
                else if (!isUnlocked) cardClass += ' locked';

                const arrow = index < steps.length - 1 ? `
                    <div class="step-arrow ${isComplete ? 'active' : ''}">‚Üí</div>
                ` : '';

                return `
                    <div class="${cardClass}">
                        <div class="step-number">${isComplete ? '‚úì' : step.num}</div>
                        <div class="step-icon">${step.icon}</div>
                        <div class="step-label">${step.label}</div>
                        <div class="step-title">${step.title}</div>
                        <div class="step-description">${step.description}</div>
                        <a href="${isUnlocked ? step.file : '#'}" class="step-btn" ${!isUnlocked ? 'onclick="return false;"' : ''}>${step.btnText}</a>
                    </div>
                    ${arrow}
                `;
            }).join('');
        }

        // Render supporting tools grid (excludes the 3 main transformation steps)
        function renderTools(client) {
            const container = document.getElementById('toolsGrid');
            const stageIndex = STAGES.findIndex(s => s.id === client.status);
            const folder = client.folder;
            const nameUnderscored = client.name.replace(/\s+/g, '_');

            // Use client-specific file paths if available, otherwise fall back to generated names
            const files = client.files || {};

            // Only supporting tools - the main 3 (Questionnaire, Insights, Blueprint) are in the transformation flow
            const tools = [
                {
                    icon: 'üìÑ',
                    title: 'CV Builder',
                    description: 'Build your CV with fields pre-filled from your Blueprint. Edit and refine your positioning.',
                    file: files.cvBuilder || `${folder}/${nameUnderscored}_CV_Builder.html`,
                    btnText: 'Open Builder',
                    secondaryBtn: 'Export PDF',
                    unlockStage: 3,
                    statusWhenComplete: 'ready'
                },
                {
                    icon: 'üó∫Ô∏è',
                    title: 'Mapping Guide',
                    description: 'A visual guide showing where your Blueprint content goes across LinkedIn, CV, and interviews.',
                    file: files.mappingGuide || `${folder}/${nameUnderscored}_Mapping_Guide.html`,
                    btnText: 'View Guide',
                    unlockStage: 3,
                    statusWhenComplete: 'reference'
                },
                {
                    icon: '‚öñÔ∏è',
                    title: 'Decision Framework',
                    description: 'Evaluate opportunities against your red flags and green flags. Score roles objectively.',
                    file: files.decisionFramework || `${folder}/${nameUnderscored}_Decision_Framework.html`,
                    btnText: 'Open Scorecard',
                    unlockStage: 2,
                    statusWhenComplete: 'ready'
                }
            ];

            container.innerHTML = tools.map(tool => {
                const isUnlocked = stageIndex >= tool.unlockStage || client.status === 'complete';
                const isComplete = stageIndex > tool.unlockStage || client.status === 'complete';

                let cardClass = 'tool-card';
                let statusClass = 'status-locked';
                let statusText = 'üîí Locked';

                if (!isUnlocked) {
                    cardClass += ' locked';
                } else if (isComplete) {
                    cardClass += ' completed';
                    if (tool.statusWhenComplete === 'completed') {
                        statusClass = 'status-completed';
                        statusText = '‚úì Completed';
                    } else if (tool.statusWhenComplete === 'ready') {
                        statusClass = 'status-ready';
                        statusText = 'Ready';
                    } else {
                        statusClass = 'status-reference';
                        statusText = 'Reference';
                    }
                } else {
                    statusClass = 'status-ready';
                    statusText = 'Ready';
                }

                return `
                    <div class="${cardClass}">
                        <div class="tool-icon">${tool.icon}</div>
                        <h3>${tool.title}</h3>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <p>${tool.description}</p>
                        <a href="${isUnlocked ? tool.file : '#'}" class="tool-btn" ${!isUnlocked ? 'onclick="return false;"' : ''}>${tool.btnText}</a>
                        ${tool.secondaryBtn && isUnlocked ? `<button class="tool-btn secondary">${tool.secondaryBtn}</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Logout
        function logout() {
            localStorage.removeItem('syp_client_email');
            currentClient = null;
            document.getElementById('portalContent').classList.remove('visible');
            document.getElementById('agreementSection').classList.remove('visible');
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('emailInput').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // =============================================
        // AGREEMENT SIGNING FUNCTIONALITY
        // =============================================

        let signatureCanvas = null;
        let signatureCtx = null;
        let isDrawing = false;
        let hasDrawnSignature = false;

        // Initialize signature canvas
        function initSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            if (!signatureCanvas) return;

            signatureCtx = signatureCanvas.getContext('2d');

            // Set canvas size to match display size
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCanvas.width = rect.width;
            signatureCanvas.height = rect.height;

            // Canvas styling
            signatureCtx.strokeStyle = '#1a1a2e';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';

            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events for mobile
            signatureCanvas.addEventListener('touchstart', handleTouchStart);
            signatureCanvas.addEventListener('touchmove', handleTouchMove);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.beginPath();
            signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signatureCtx.stroke();
            hasDrawnSignature = true;
            validateForm();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = signatureCanvas.getBoundingClientRect();
            isDrawing = true;
            signatureCtx.beginPath();
            signatureCtx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!isDrawing) return;
            const touch = e.touches[0];
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
            signatureCtx.stroke();
            hasDrawnSignature = true;
            validateForm();
        }

        function clearSignature() {
            if (!signatureCanvas || !signatureCtx) return;
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            hasDrawnSignature = false;
            validateForm();
        }

        // Form validation
        function validateForm() {
            const agreeTerms = document.getElementById('agreeTerms').checked;
            const signatureInput = document.getElementById('signatureInput').value.trim();
            const signBtn = document.getElementById('signBtn');

            // Must agree to terms AND have either typed or drawn signature
            const hasSignature = signatureInput.length > 0 || hasDrawnSignature;
            const isValid = agreeTerms && hasSignature;

            signBtn.disabled = !isValid;
        }

        // Submit agreement to PostgreSQL API
        async function submitAgreement() {
            const signBtn = document.getElementById('signBtn');
            signBtn.disabled = true;
            signBtn.textContent = '‚è≥ Submitting...';

            const signatureInput = document.getElementById('signatureInput').value.trim();
            const agreeTerms = document.getElementById('agreeTerms').checked;
            const agreeRecording = document.getElementById('agreeRecording').checked;

            // Get signature data (prefer drawn, fallback to typed)
            let signatureData = signatureInput;
            let signatureType = 'typed';

            if (hasDrawnSignature && signatureCanvas) {
                signatureData = signatureCanvas.toDataURL('image/png');
                signatureType = 'drawn';
            }

            const agreementData = {
                client_email: currentClient.email,
                client_full_name: currentClient.name,
                document_type: 'coaching_agreement',
                programme_type: 'career_booster_4_week',
                client_signature: signatureData,
                signature_type: signatureType,
                signed_date: new Date().toISOString(),
                agreed_to_terms: agreeTerms,
                consent_to_recording: agreeRecording,
                document_html: document.querySelector('.agreement-content').innerHTML
            };

            try {
                // Submit to PostgreSQL API
                const response = await fetch('https://sparkhub-be-qtmmb.ondigitalocean.app/api/crm/syp/public/sign-agreement/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(agreementData)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();
                console.log('Agreement saved to PostgreSQL:', result);

                // Mark client as having signed (update local state)
                currentClient.agreementSigned = true;

                // Save to localStorage as backup
                localStorage.setItem(`syp_agreement_${currentClient.email}`, JSON.stringify({
                    signed: true,
                    signedDate: new Date().toISOString(),
                    signatureType: signatureType
                }));

                // Show success and proceed to toolkit
                signBtn.classList.add('success');
                signBtn.textContent = '‚úÖ Agreement Signed!';

                setTimeout(() => {
                    // Hide agreement, show toolkit
                    document.getElementById('agreementSection').classList.remove('visible');
                    document.getElementById('portalContent').classList.add('visible');

                    // Render the portal content
                    document.getElementById('clientName').textContent = currentClient.name.split(' ')[0];
                    const stageIndex = STAGES.findIndex(s => s.id === currentClient.status);
                    const toolsUnlocked = getToolsUnlocked(stageIndex);
                    document.getElementById('statBlueprints').textContent = stageIndex >= 2 ? '1' : '0';
                    document.getElementById('statTools').textContent = `${toolsUnlocked}/6`;
                    document.getElementById('statDate').textContent = new Date().toLocaleDateString('en-GB');
                    renderJourney(currentClient);
                    renderTools(currentClient);
                }, 1500);

            } catch (error) {
                console.error('Failed to submit agreement:', error);

                // Fallback: save to localStorage
                localStorage.setItem(`syp_agreement_${currentClient.email}`, JSON.stringify({
                    signed: true,
                    signedDate: new Date().toISOString(),
                    signatureType: signatureType,
                    agreementData: agreementData
                }));

                // Still proceed (will sync later)
                signBtn.classList.add('success');
                signBtn.textContent = '‚úÖ Agreement Saved!';

                setTimeout(() => {
                    document.getElementById('agreementSection').classList.remove('visible');
                    document.getElementById('portalContent').classList.add('visible');
                    document.getElementById('clientName').textContent = currentClient.name.split(' ')[0];
                    const stageIndex = STAGES.findIndex(s => s.id === currentClient.status);
                    const toolsUnlocked = getToolsUnlocked(stageIndex);
                    document.getElementById('statBlueprints').textContent = stageIndex >= 2 ? '1' : '0';
                    document.getElementById('statTools').textContent = `${toolsUnlocked}/6`;
                    document.getElementById('statDate').textContent = new Date().toLocaleDateString('en-GB');
                    renderJourney(currentClient);
                    renderTools(currentClient);
                }, 1500);
            }
        }

        // Check if client has already signed agreement
        function hasSignedAgreement(client) {
            // Check localStorage first
            const localSigned = localStorage.getItem(`syp_agreement_${client.email}`);
            if (localSigned) {
                try {
                    const data = JSON.parse(localSigned);
                    if (data.signed) return true;
                } catch (e) {}
            }

            // Check client data from API
            if (client.agreementSigned) return true;

            return false;
        }

        // Setup form event listeners
        function setupAgreementForm() {
            const agreeTerms = document.getElementById('agreeTerms');
            const signatureInput = document.getElementById('signatureInput');

            if (agreeTerms) {
                agreeTerms.addEventListener('change', validateForm);
            }
            if (signatureInput) {
                signatureInput.addEventListener('input', validateForm);
            }

            initSignatureCanvas();
        }
    </script>
</body>
</html>
